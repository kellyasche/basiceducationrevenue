---
title: "Analysis - pct change in budget"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)

```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r shapefiles}
school_districts <- read_sf("Data/Shapefiles/School Shapefiles/School_district_boundaries.shp", quiet = TRUE) %>%
  rename(type = UNI_TYP,
         number = UNI_MAJ)

```


```{r master basic revenue}
original <- read_csv("Data/Formula/Master.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         eqgroup.label = ifelse(is.na(eqgroup.label), "", eqgroup.label)) %>%
  filter(group %in% c(1,4))

group.codes <- read_xlsx("Data/Formula/group codes.xlsx")

var.codes <- read_xlsx("Data/Formula/primary variable codes.xlsx")

categories <- c("bsrev", "exdayr", "gtrev", "smlrev", "decrev", "locaid", "afdc22", "totlep", "totspar", "cexaid", "tsparrev", "eqaid", "hhaid", "penrev")

master.original <- original %>%
  select(`District Name`, number, type, categories) %>%
  gather(key = "categories", value = "revenue.original", 4:17) 

```

```{r 4% increase scenario}
bsrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         bsrev.4pct = round(awadm22 * fa22.4pct)) %>%
  select(`District Name`, number, type, bsrev.4pct)

exdayr.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22x.4pct = (fa22x * .04) + fa22x,
         exdayr.4pct = round(fa22x.4pct * xwadm22),
         exdayr.4pct = ifelse(number == 347, exdayr.4pct, exdayr.4pct)) %>%
  select(`District Name`, number, type, exdayr.4pct)

gtrev22.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(gt22.4pct = gt22 + 1,
         gtrev.4pct = round(gt22.4pct * awadm22),
         gtaid.4pct = gtrev.4pct,
         gtlvy.4pct = gtrev.4pct - gtaid.4pct) %>%
  select(`District Name`, number, type, gtrev.4pct)

smlrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22sm.4pct = (fa22sm * .04) + fa22sm,
         smlalo.4pct = smlrto * fa22sm.4pct,
         smlrev.4pct = round(smlalo.4pct * awadm22),
         smlrev.4pct = ifelse(number == 318, (70189.06*.04) + 70189.06, smlrev.4pct),
         smlrev.4pct = ifelse(number == 363, (115058.66 * .04) + 115058.66, smlrev.4pct),
         smlrev.4pct = ifelse(number == 381, (241346.69 * .04) + 241346.69, smlrev.4pct),
         smlrev.4pct = ifelse(number == 2142, (404349.22 * .04) + 404349.22, smlrev.4pct)) %>%
  select(`District Name`, number, type, smlrev.4pct)

decrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22 * .04) + fa22,
         decalo.4pct = round(fa22.4pct * 0.28),
         declpu.4pct = awadm21 - awadm22,
         declpu.4pct = ifelse(declpu.4pct < 0, 0, declpu.4pct),
         decrev.4pct = round(decalo.4pct * declpu.4pct),
         decrev.4pct = ifelse(awadm22 == 0, 0, decrev.4pct)) %>%
  select(`District Name`, number, type, decrev.4pct)

locaid.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(localo.4pct = (localo * .04) + localo,
         locrev.4pct = (locrev * .04) + locrev,
         loctier1.4pct = 0,
         loctier2.4pct = 0,
         loctier1.4pct = ifelse(localo.4pct >= (300*.04) + 300, (300*.04) + 300, loctier1.4pct),
         loctier1.4pct = ifelse(localo.4pct < (300*.04) + 300, localo.4pct, loctier1.4pct),
         loctier2.4pct = ifelse(loctier1.4pct == (300*.04)+300, localo.4pct - loctier1.4pct, loctier2.4pct),
         loctier2.4pct = ifelse(loctier1.4pct < (300*.04) + 300, 0, loctier2.4pct),
         loctier1rev.4pct = round(loctier1.4pct * awadm22),
         loctier2rev.4pct = round(loctier2.4pct * awadm22),
         loctier1_eq_factor.4pct = (880000 * .04) + 880000,
         loctier2_eq_factor.4pct = (510000 * .04) + 510000,
         loclvytier1.4pct = 0.0,
         loclvytier1.4pct = ifelse(wadm22 > 0 & group == 1, round(loctier1rev.4pct * ((rmkv19 / wadm22) / loctier1_eq_factor.4pct)), loclvytier1.4pct)) %>%
  rowwise() %>%
  mutate(loclvytier1.4pct = min(loctier1rev.4pct, loclvytier1.4pct)) %>%
  ungroup() %>%
  mutate(locaidtier1.4pct = loctier1rev.4pct - loclvytier1.4pct,
         loclvytier2.4pct = 0.0,
         loclvytier2.4pct = ifelse(wadm22 > 0 & group == 1, round(loctier2rev.4pct * ((rmkv19 / wadm22) / loctier2_eq_factor.4pct)), loclvytier2.4pct)) %>%
  rowwise() %>%
  mutate(loclvytier2.4pct = min(loctier2rev.4pct, loclvytier2.4pct)) %>%
  ungroup() %>%
  mutate(locaidtier2.4pct = loctier2rev.4pct - loclvytier2.4pct,
         loclvy.4pct = loclvytier1.4pct + loclvytier2.4pct,
         locaid.4pct = locaidtier1.4pct + locaidtier2.4pct) %>%
  select(`District Name`, number, type, loctier1rev.4pct, locaid.4pct)

afdc22.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(afdc22.4pct = (afdc22 * .04) + afdc22) %>%
  select(`District Name`, number, type, afdc22.4pct)

totlep.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(leprat1.4pct = (704*.04) + 704,
         leprat2.4pct = (250*.04) + 250,
         leprev.4pct = round(lepadm22_min * leprat1.4pct),
         leppct.4pct = 0.0,
         leppct.4pct = ifelse(admsv22 > 0, lepadm22 / admsv22, leppct.4pct),
         lepftr.4pct = leppct.4pct / 0.115,
         lepftr.4pct = ifelse(lepftr.4pct < 0, 0,
                         ifelse(lepftr.4pct > 1, 1, lepftr.4pct)),
         lepcpu.4pct = lepadm22 * lepftr.4pct,
         lepcrev.4pct = round(lepcpu.4pct * leprat2.4pct),
         totlep.4pct = leprev.4pct + lepcrev.4pct) %>%
  select(`District Name`, number, type, totlep.4pct)

totspar.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         fa22ss.4pct = fa22.4pct - 530,
         sprevini.4pct = round(isoftr * admftr * sadmsv22 * fa22ss.4pct - 0),
         mspar22.4pct = round(mspar22 * (fa22ss.4pct / fa22ss.4pct)),
         hhspar22.4pct = round(hhspar22 * (fa22ss.4pct / fa22ss.4pct)),
         sprev.4pct = sprevini.4pct,
         sprev.4pct = ifelse(mspar22.4pct > sprevini.4pct, mspar22.4pct, sprev.4pct),
         sprev.4pct = ifelse(hhspar22.4pct > sprevini.4pct, hhspar22.4pct, sprev.4pct),
         espar22.4pct = (espar22 * .04) + espar22,
         elmspar.4pct = round(espar22.4pct * (fa22ss.4pct / fa22ss.4pct)),
         minspar.4pct = sprev.4pct + elmspar.4pct,
         totspar.4pct = minspar.4pct,
         totspar.4pct = ifelse(closedblg > 0 & srsrev21 > minspar.4pct, srsrev21, totspar.4pct),
         srsrev22.4pct = totspar.4pct) %>%
  select(`District Name`, number, type,  totspar.4pct)
  

cexaid.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(cxfrev.4pct = round(awadm22 * (((79*.04)+79) + ((109*.04)+109) * ageidx22)),
         ocexrev.4pct = round(cxfrev.4pct + (((31*.04)+31) * ywadm22)),
         cex_eq_factor.4pct = (22912*.04)+22912,
         cexrto.4pct = 0.0,
         cexrto.4pct = ifelse(awadm22 > 0 & group == 1, (antc19 / awadm22) / cex_eq_factor.4pct, cexrto.4pct),
         cexrto.4pct = ifelse(cexrto.4pct < 0, 0,
                              ifelse(cexrto.4pct > 1.0, 1, cexrto.4pct)),
         cexlvy.4pct = round(ocexrev.4pct * cexrto.4pct),
         cexaid.4pct = ocexrev.4pct - cexlvy.4pct) %>%
  select(`District Name`, number, type, cexaid.4pct)

tsparrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         fa22ts.4pct = fa22.4pct,
         tsparal.4pct = ((fa22ts.4pct * 0.141 * trsindex**0.26 * trdindex**0.13) -(fa22ts.4pct * trapct)),
         tsparal.4pct = ifelse(tsparal.4pct < 0, 0, tsparal.4pct), #if less than zero, return zero
         bastrans.4pct = round((fa22ts.4pct * trapct) * awadm22),
         tsparrev1.4pct = round(tsparal.4pct * awadm22),
         tsparrev2.4pct = 0,
         tottrarev.4pct = tottrarev22) %>%
  rowwise() %>%
  mutate(transex.4pct = min(transex21, transex20 * 1.05)) %>%
  ungroup() %>%
  mutate(tsparrev2.4pct = (transex.4pct - tottrarev.4pct) * 0.182,
         tsparrev2.4pct = ifelse(tsparrev2.4pct < 0, 0, tsparrev2.4pct),
         tsparrev.4pct = tsparrev1.4pct + tsparrev2.4pct,
         tsparaln.4pct = 0,
         tsparaln.4pct = ifelse(awadm22 > 0 & group==1, (tsparrev2.4pct / awadm22) + tsparal.4pct, tsparaln.4pct)) %>%
  select(`District Name`, number, type, tsparaln.4pct, tsparrev.4pct)

hhaid.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(hh_eq_factor.4pct = (hh_eq_factor * .04) + hh_eq_factor,
         hhlvy.4pct = 0.0,
         hhlvy.4pct = ifelse(wadm22 > 0 & group == 1, round(hhrev * ((rmkv19 / wadm22) / hh_eq_factor.4pct)), hhlvy.4pct)) %>%
  rowwise() %>%
  mutate(hhlvy.4pct = min(hhlvy.4pct, hhrev)) %>%
  ungroup() %>%
  mutate(hhaid.4pct = hhrev - hhlvy.4pct) %>%
  select(`District Name`, number, type, hhaid.4pct)

refrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(refcap.4pct = max(altcap22, stdcap)) %>%
  ungroup() %>%
  mutate(fa22.4pct = (fa22 * .04) + fa22,
         fa22ss.4pct = fa22.4pct - 530,
         sprevini.4pct = round(isoftr * admftr * sadmsv22 * fa22ss.4pct - 0),
         mspar22.4pct = round(mspar22 * (fa22ss.4pct / fa22ss.4pct)),
         hhspar22.4pct = round(hhspar22 * (fa22ss.4pct / fa22ss.4pct)),
         sprev.4pct = sprevini.4pct,
         sprev.4pct = ifelse(mspar22.4pct > sprevini.4pct, mspar22.4pct, sprev.4pct),
         sprev.4pct = ifelse(hhspar22.4pct > sprevini.4pct, hhspar22.4pct, sprev.4pct),
         espar22.4pct = (espar22 * .04) + espar22,
         elmspar.4pct = round(espar22.4pct * (fa22ss.4pct / fa22ss.4pct))) %>%
  rowwise() %>%
  mutate(refcap.4pct = max(altcap22, stdcap)) %>%
  ungroup() %>%
  mutate(refcap.4pct = ifelse(sprev.4pct + elmspar.4pct > 0, 99999999, refcap.4pct),
         refalo22.4pct = refalo22t,
         refalo22.4pct = ifelse(refalo22t > refcap.4pct, refcap.4pct, refalo22.4pct),
         refrev22.4pct = round(refalo22.4pct * awadm22)) %>%
  select(`District Name`, number, type, refrev22.4pct)


ajgeppu.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(bsrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(refrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.4pct, by = c("District Name", "number", "type")) %>%
  mutate(ajgened.4pct = bsrev.4pct + refrev22.4pct + hhrev + loctier1rev.4pct, # add lor tier 1 beginning FY21
         ajgeppu.4pct = 0.0,
         ajgeppu.4pct = ifelse(awadm22 > 0 & group == 1, round((ajgened.4pct / awadm22) * 100) / 100, ajgeppu.4pct)) %>%
  select(`District Name`, number, type, ajgeppu.4pct)
 
percentile.helper <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(ajgeppu.4pct, by = c("District Name", "number", "type")) %>%
  mutate(rur5.4pct = quantile(ajgeppu.4pct[eqgroup.label == "ruraleq" & ajgeppu.4pct > 0], .05, type = 1),
         rur95.4pct = quantile(ajgeppu.4pct[eqgroup.label == "ruraleq" & ajgeppu.4pct > 0], .95, type = 1),
         metro5.4pct = quantile(ajgeppu.4pct[eqgroup.label == "metroeq"], .05, type = 1),
         metro95.4pct = quantile(ajgeppu.4pct[eqgroup.label == "metroeq"], .95, type = 1),
         ajgep5.4pct = 0.0,
         ajgep95.4pct = 0.0,
         ajgep5.4pct = ifelse(eqgroup.label == "ruraleq", rur5.4pct,
                         ifelse(eqgroup.label == "metroeq", metro5.4pct, ajgep5.4pct)),
         ajgep95.4pct = ifelse(eqgroup.label == "ruraleq", rur95.4pct,
                          ifelse(eqgroup.label == "metroeq", metro95.4pct, ajgep95.4pct)),
         seqgap.4pct = ajgep95.4pct - ajgep5.4pct,
         seqgap.4pct = ifelse(seqgap.4pct < 0, 0, seqgap.4pct), # clip negatives
         deqgap.4pct = ajgep95.4pct - ajgeppu.4pct,
         deqgap.4pct = ifelse(deqgap.4pct < 0, 0, deqgap.4pct), # clip negatives
         eqindx.4pct = 0.0,
         eqindx.4pct = deqgap.4pct / seqgap.4pct) %>%
  select(`District Name`, number, type, deqgap.4pct, eqindx.4pct) 

refrev_ave.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(refrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.4pct, by = c("District Name", "number", "type")) %>%
  mutate(refrev_eq.4pct = refrev22.4pct,
         refrev_eq.4pct = ifelse(number == 3000, refrev_new, refrev_eq.4pct),
         refrev_sd.4pct = sum(refrev_eq.4pct[group %in% c(1,2)]),
         loctier1_eq.4pct = loctier1rev.4pct,
         loctier1_eq.4pct = ifelse(number == 3000, 0, loctier1_eq.4pct),
         locrev_sd.4pct = sum(loctier1_eq.4pct[group %in% c(1,2)]),
         awadm_sd.4pct = sum(awadm22[group %in% c(1,2)]),
         refrev_ave.4pct = refrev_sd.4pct / awadm_sd.4pct,
         loc_ave.4pct = locrev_sd.4pct / awadm_sd.4pct) %>%
  select(`District Name`, number, type, refrev_ave.4pct, loc_ave.4pct)

eqrev1.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(percentile.helper, by = c("District Name", "number", "type")) %>%
  mutate(sldalo.4pct = (80*.04) + 80,
         eqrev1.4pct = round(awadm22 * (((14*.04)+14) + (sldalo.4pct * eqindx.4pct))),
         eqrev1.4pct = ifelse(dist==1 & type==3 | number==625 | number==709 | deqgap.4pct==0, 0, eqrev1.4pct),
         eqrev1_p.4pct = 0.0,
         eqrev1_p.4pct = ifelse(group==1 & awadm22 > 0, round(eqrev1.4pct / awadm22), eqrev1_p.4pct)) %>%
  select(`District Name`, number, type, eqrev1.4pct)

eqrev2.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(refrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(refrev_ave.4pct, by = c("District Name", "number", "type")) %>%
  left_join(percentile.helper, by = c("District Name", "number", "type")) %>%
  mutate(sst22.4pct = 100000,
         refrev_p.4pct = 0.0,
         refrev_p.4pct = ifelse(awadm22 > 0,  (refrev22.4pct + loctier1rev.4pct) / awadm22, refrev_p.4pct),
         eqrev2.4pct = 0.0,
         eqrev2.4pct = ifelse(refrev_p.4pct < ((refrev_ave.4pct + loc_ave.4pct) * 0.1), (((refrev_ave.4pct + loc_ave.4pct) * 0.1) - refrev_p.4pct) * awadm22, eqrev2.4pct),
         eqrev2.4pct = ifelse(eqrev2.4pct > sst22.4pct, sst22.4pct, eqrev2.4pct),
         eqrev2.4pct = ifelse(dist==1 & type==3 | number==625 | number==709 |deqgap.4pct==0, 0, eqrev2.4pct)) %>%
  select(`District Name`, number, type, eqrev2, eqrev2.4pct)

eqrev3.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(eqrev1.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev2.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eqrev3.4pct = 0.0,
         eqrev3.4pct = ifelse(eqgroup.label == "metroeq", (eqrev1.4pct + eqrev2.4pct) * 0.25, eqrev3.4pct),
         eqrev3.4pct = ifelse(eqgroup.label == "ruraleq", (eqrev1.4pct + eqrev2.4pct) * 0.25, eqrev3.4pct)) %>%
  select(`District Name`, number, type, eqrev3.4pct)

eqrev4.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(percentile.helper, by = c("District Name", "number", "type")) %>%
  mutate(eqblw95.4pct = (50*.04) + 50,
         eqabv95.4pct = (50*.04) + 50,
         eqrev4.4pct = round(awadm22 * eqblw95.4pct),
         eqrev4.4pct = ifelse(deqgap.4pct == 0,round(awadm22 * eqabv95.4pct), eqrev4.4pct)) %>%
  select(`District Name`, number, type, eqrev4.4pct)

eqrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(eqrev1.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev2.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev3.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev4.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eqrev.4pct = eqrev1.4pct + eqrev2.4pct + eqrev3.4pct + eqrev4.4pct) %>%
  select(`District Name`, number, type, eqrev.4pct)

eqaid.4pct <- original %>%
  left_join(eqrev.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eq_eq_factor.4pct = (510000*.04)+510000,
         eqlvy.4pct = 0.0,
         eqlvy.4pct = ifelse(wadm22 > 0 & group == 1, round(eqrev.4pct * ((rmkv19 / wadm22) / eq_eq_factor.4pct)), eqlvy.4pct),
         eqlvy.4pct = ifelse(eqlvy.4pct > eqrev.4pct, eqrev.4pct, eqlvy.4pct),
         eqaid.4pct = eqrev.4pct - eqlvy.4pct) %>%
  select(`District Name`, number, type, eqaid.4pct)

penrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(penrev.4pct = penrev) %>%
  select(`District Name`, number,  type, penrev.4pct)

optadjfa.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(tsparrev.4pct, by = c("District Name", "number", "type")) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         optadjin.4pct = 0.0,
         optadjin.4pct = 0.0,
         optbasch.4pct = round((clwadm22 + mclwadm22) * fa22.4pct * trapct),
         optsrsch.4pct = round((clwadm22 + mclwadm22) * tsparaln.4pct),
         optextch.4pct = 0.0,
         optadjch.4pct = optbasch.4pct + optextch.4pct + optsrsch.4pct,
         optadjfa.4pct = round(cfwadm22 * -fa22.4pct),
         optadjfa.4pct = ifelse(type == 70, round(0 * fa22.4pct / fa22.4pct), optadjfa.4pct),
         optadjfa.4pct = ifelse(type == 90, round(641313.36 * fa22.4pct / fa22.4pct), optadjfa.4pct),
         optadj.4pct = optadjin.4pct + optadjch.4pct + optadjfa.4pct) %>%
  select(`District Name`, number, type, optadj.4pct)

master.4pct <- bsrev.4pct %>%
  left_join(exdayr.4pct, by = c("District Name", "number", "type")) %>%
  left_join(gtrev22.4pct, by = c("District Name", "number", "type")) %>%
  left_join(smlrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(decrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(afdc22.4pct, by = c("District Name", "number", "type")) %>%
  left_join(totlep.4pct, by = c("District Name", "number", "type")) %>%
  left_join(totspar.4pct, by = c("District Name", "number", "type")) %>%
  left_join(cexaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(hhaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(tsparrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(optadjfa.4pct, by = c("District Name", "number", "type" )) %>%
  left_join(penrev.4pct, by = c("District Name", "number", "type" )) %>%
  select(1:8, 10:16, 18:20) %>%
  gather(key = "categories", value = "revenue.4pct", 4:18 ) %>%
  mutate(categories = str_sub(categories, 1, -6),
         revenue.4pct = ifelse(is.na(revenue.4pct), 0, revenue.4pct)) 

```

```{r 4% basic revenue only}
bsrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         bsrev.bsrevonly.4pct = round(awadm22 * fa22.4pct)) %>%
  select(`District Name`, number, type, bsrev.bsrevonly.4pct)

exdayr.bsrevonly.4pct <- original %>%
  mutate(exdayr.bsrevonly.4pct = exdayr) %>%
  select(`District Name`, number, type, exdayr.bsrevonly.4pct)

gtrev22.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(gtrev.bsrevonly.4pct = gtrev) %>%
  select(`District Name`, number, type, gtrev.bsrevonly.4pct)

smlrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(smlrev.bsrevonly.4pct = smlrev) %>%
  select(`District Name`, number, type, smlrev.bsrevonly.4pct)

decrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.bsrevonly.4pct = (fa22 * .04) + fa22,
         decalo.bsrevonly.4pct = round(fa22.bsrevonly.4pct * 0.28),
         declpu.bsrevonly.4pct = awadm21 - awadm22,
         declpu.bsrevonly.4pct = ifelse(declpu.bsrevonly.4pct < 0, 0, declpu.bsrevonly.4pct),
         decrev.bsrevonly.4pct = round(decalo.bsrevonly.4pct * declpu.bsrevonly.4pct),
         decrev.bsrevonly.4pct = ifelse(awadm22 == 0, 0, decrev.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, decrev.bsrevonly.4pct)

locaid.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(loctier1rev.bsrevonly.4pct = loctier1rev,
         locaid.bsrevonly.4pct = locaid) %>%
  select(`District Name`, number, type, loctier1rev.bsrevonly.4pct, locaid.bsrevonly.4pct)

afdc22.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(afdc22.bsrevonly.4pct = (afdc22 * .04) + afdc22) %>%
  select(`District Name`, number, type, afdc22.bsrevonly.4pct)

totlep.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(totlep.bsrevonly.4pct = totlep) %>%
  select(`District Name`, number, type, totlep.bsrevonly.4pct)

totspar.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         fa22ss.4pct = fa22.4pct - 530,
         sprevini.4pct = round(isoftr * admftr * sadmsv22 * fa22ss.4pct - 0),
         mspar22.4pct = round(mspar22 * (fa22ss.4pct / fa22ss.4pct)),
         hhspar22.4pct = round(hhspar22 * (fa22ss.4pct / fa22ss.4pct)),
         sprev.4pct = sprevini.4pct,
         sprev.4pct = ifelse(mspar22.4pct > sprevini.4pct, mspar22.4pct, sprev.4pct),
         sprev.4pct = ifelse(hhspar22.4pct > sprevini.4pct, hhspar22.4pct, sprev.4pct),
         espar22.4pct = espar22,
         elmspar.4pct = round(espar22.4pct * (fa22ss.4pct / fa22ss.4pct)),
         minspar.4pct = sprev.4pct + elmspar.4pct,
         totspar.bsrevonly.4pct = minspar.4pct,
         totspar.bsrevonly.4pct = ifelse(closedblg > 0 & srsrev21 > minspar.4pct, srsrev21, totspar.bsrevonly.4pct),
         srsrev22.bsrevonly.4pct = totspar.bsrevonly.4pct) %>%
  select(`District Name`, number, type,  totspar.bsrevonly.4pct)
  

cexaid.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(cexaid.bsrevonly.4pct = cexaid) %>%
  select(`District Name`, number, type,  cexaid.bsrevonly.4pct)

tsparrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         fa22ts.4pct = fa22.4pct,
         tsparal.4pct = ((fa22ts.4pct * 0.141 * trsindex**0.26 * trdindex**0.13) -(fa22ts.4pct * trapct)),
         tsparal.4pct = ifelse(tsparal.4pct < 0, 0, tsparal.4pct), #if less than zero, return zero
         bastrans.4pct = round((fa22ts.4pct * trapct) * awadm22),
         tsparrev1.4pct = round(tsparal.4pct * awadm22),
         tsparrev2.4pct = 0,
         tottrarev.4pct = tottrarev22) %>%
  rowwise() %>%
  mutate(transex.4pct = min(transex21, transex20 * 1.05)) %>%
  ungroup() %>%
  mutate(tsparrev2.4pct = (transex.4pct - tottrarev.4pct) * 0.182,
         tsparrev2.4pct = ifelse(tsparrev2.4pct < 0, 0, tsparrev2.4pct),
         tsparrev.bsrevonly.4pct = tsparrev1.4pct + tsparrev2.4pct,
         tsparaln.bsrevonly.4pct = 0,
         tsparaln.bsrevonly.4pct = ifelse(awadm22 > 0 & group==1, (tsparrev2.4pct / awadm22) + tsparal.4pct, tsparaln.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, tsparaln.bsrevonly.4pct, tsparrev.bsrevonly.4pct)

hhaid.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(hhaid.bsrevonly.4pct = hhaid) %>%
  select(`District Name`, number, type, hhaid.bsrevonly.4pct)

refrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(refcap.4pct = max(altcap22, stdcap)) %>%
  ungroup() %>%
  mutate(fa22.4pct = (fa22 * .04) + fa22,
         fa22ss.4pct = fa22.4pct - 530,
         sprevini.4pct = round(isoftr * admftr * sadmsv22 * fa22ss.4pct - 0),
         mspar22.4pct = round(mspar22 * (fa22ss.4pct / fa22ss.4pct)),
         hhspar22.4pct = round(hhspar22 * (fa22ss.4pct / fa22ss.4pct)),
         sprev.4pct = sprevini.4pct,
         sprev.4pct = ifelse(mspar22.4pct > sprevini.4pct, mspar22.4pct, sprev.4pct),
         sprev.4pct = ifelse(hhspar22.4pct > sprevini.4pct, hhspar22.4pct, sprev.4pct),
         espar22.4pct = espar22,
         elmspar.4pct = round(espar22.4pct * (fa22ss.4pct / fa22ss.4pct))) %>%
  rowwise() %>%
  mutate(refcap.4pct = max(altcap22, stdcap)) %>%
  ungroup() %>%
  mutate(refcap.4pct = ifelse(sprev.4pct + elmspar.4pct > 0, 99999999, refcap.4pct),
         refalo22.4pct = refalo22t,
         refalo22.4pct = ifelse(refalo22t > refcap.4pct, refcap.4pct, refalo22.4pct),
         refrev22.bsrevonly.4pct = round(refalo22.4pct * awadm22)) %>%
  select(`District Name`, number, type, refrev22.bsrevonly.4pct)


ajgeppu.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(bsrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(refrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(ajgened.bsrevonly.4pct = bsrev.bsrevonly.4pct + refrev22.bsrevonly.4pct + hhrev + loctier1rev.bsrevonly.4pct, # add lor tier 1 beginning FY21
         ajgeppu.bsrevonly.4pct = 0.0,
         ajgeppu.bsrevonly.4pct = ifelse(awadm22 > 0 & group == 1, round((ajgened.bsrevonly.4pct / awadm22) * 100) / 100, ajgeppu.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, ajgeppu.bsrevonly.4pct)
 
percentile.helper.bsrevonly <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(ajgeppu.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(rur5.bsrevonly.4pct = quantile(ajgeppu.bsrevonly.4pct[eqgroup.label == "ruraleq" & ajgeppu.bsrevonly.4pct > 0], .05, type = 1),
         rur95.bsrevonly.4pct = quantile(ajgeppu.bsrevonly.4pct[eqgroup.label == "ruraleq" & ajgeppu.bsrevonly.4pct > 0], .95, type = 1),
         metro5.bsrevonly.4pct = quantile(ajgeppu.bsrevonly.4pct[eqgroup.label == "metroeq"], .05, type = 1),
         metro95.bsrevonly.4pct = quantile(ajgeppu.bsrevonly.4pct[eqgroup.label == "metroeq"], .95, type = 1),
         ajgep5.bsrevonly.4pct = 0.0,
         ajgep95.bsrevonly.4pct = 0.0,
         ajgep5.bsrevonly.4pct = ifelse(eqgroup.label == "ruraleq", rur5.bsrevonly.4pct,
                         ifelse(eqgroup.label == "metroeq", metro5.bsrevonly.4pct, ajgep5.bsrevonly.4pct)),
         ajgep95.bsrevonly.4pct = ifelse(eqgroup.label == "ruraleq", rur95.bsrevonly.4pct,
                          ifelse(eqgroup.label == "metroeq", metro95.bsrevonly.4pct, ajgep95.bsrevonly.4pct)),
         seqgap.bsrevonly.4pct = ajgep95.bsrevonly.4pct - ajgep5.bsrevonly.4pct,
         seqgap.bsrevonly.4pct = ifelse(seqgap.bsrevonly.4pct < 0, 0, seqgap.bsrevonly.4pct), # clip negatives
         deqgap.bsrevonly.4pct = ajgep95.bsrevonly.4pct - ajgeppu.bsrevonly.4pct,
         deqgap.bsrevonly.4pct = ifelse(deqgap.bsrevonly.4pct < 0, 0, deqgap.bsrevonly.4pct), # clip negatives
         eqindx.bsrevonly.4pct = 0.0,
         eqindx.bsrevonly.4pct = deqgap.bsrevonly.4pct / seqgap.bsrevonly.4pct) %>%
  select(`District Name`, number, type, deqgap.bsrevonly.4pct, eqindx.bsrevonly.4pct) 

refrev_ave.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(refrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(refrev_eq.bsrevonly.4pct = refrev22.bsrevonly.4pct,
         refrev_eq.bsrevonly.4pct = ifelse(number == 3000, refrev_new, refrev_eq.bsrevonly.4pct),
         refrev_sd.bsrevonly.4pct = sum(refrev_eq.bsrevonly.4pct[group %in% c(1,2)]),
         loctier1_eq.bsrevonly.4pct = loctier1rev.bsrevonly.4pct,
         loctier1_eq.bsrevonly.4pct = ifelse(number == 3000, 0, loctier1_eq.bsrevonly.4pct),
         locrev_sd.bsrevonly.4pct = sum(loctier1_eq.bsrevonly.4pct[group %in% c(1,2)]),
         awadm_sd.bsrevonly.4pct = sum(awadm22[group %in% c(1,2)]),
         refrev_ave.bsrevonly.4pct = refrev_sd.bsrevonly.4pct / awadm_sd.bsrevonly.4pct,
         loc_ave.bsrevonly.4pct = locrev_sd.bsrevonly.4pct / awadm_sd.bsrevonly.4pct) %>%
  select(`District Name`, number, type, refrev_ave.bsrevonly.4pct, loc_ave.bsrevonly.4pct)

eqrev1.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(percentile.helper.bsrevonly, by = c("District Name", "number", "type")) %>%
  mutate(sldalo.bsrevonly.4pct = 80,
         eqrev1.bsrevonly.4pct = round(awadm22 * (14 + (sldalo.bsrevonly.4pct * eqindx.bsrevonly.4pct))),
         eqrev1.bsrevonly.4pct = ifelse(dist==1 & type==3 | number==625 | number==709 | deqgap.bsrevonly.4pct==0, 0, eqrev1.bsrevonly.4pct),
         eqrev1_p.bsrevonly.4pct = 0.0,
         eqrev1_p.bsrevonly.4pct = ifelse(group==1 & awadm22 > 0, round(eqrev1.bsrevonly.4pct / awadm22), eqrev1_p.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, eqrev1.bsrevonly.4pct)

eqrev2.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(refrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(refrev_ave.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(percentile.helper.bsrevonly, by = c("District Name", "number", "type")) %>%
  mutate(sst22.bsrevonly.4pct = 100000,
         refrev_p.bsrevonly.4pct = 0.0,
         refrev_p.bsrevonly.4pct = ifelse(awadm22 > 0,  (refrev22.bsrevonly.4pct + loctier1rev.bsrevonly.4pct) / awadm22, refrev_p.bsrevonly.4pct),
         eqrev2.bsrevonly.4pct = 0.0,
         eqrev2.bsrevonly.4pct = ifelse(refrev_p.bsrevonly.4pct < ((refrev_ave.bsrevonly.4pct + loc_ave.bsrevonly.4pct) * 0.1), (((refrev_ave.bsrevonly.4pct + loc_ave.bsrevonly.4pct) * 0.1) - refrev_p.bsrevonly.4pct) * awadm22, eqrev2.bsrevonly.4pct),
         eqrev2.bsrevonly.4pct = ifelse(eqrev2.bsrevonly.4pct > sst22.bsrevonly.4pct, sst22.bsrevonly.4pct, eqrev2.bsrevonly.4pct),
         eqrev2.bsrevonly.4pct = ifelse(dist==1 & type==3 | number==625 | number==709 |deqgap.bsrevonly.4pct==0, 0, eqrev2.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, eqrev2, eqrev2.bsrevonly.4pct)

eqrev3.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(eqrev1.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev2.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eqrev3.bsrevonly.4pct = 0.0,
         eqrev3.bsrevonly.4pct = ifelse(eqgroup.label == "metroeq", (eqrev1.bsrevonly.4pct + eqrev2.bsrevonly.4pct) * 0.25, eqrev3.bsrevonly.4pct),
         eqrev3.bsrevonly.4pct = ifelse(eqgroup.label == "ruraleq", (eqrev1.bsrevonly.4pct + eqrev2.bsrevonly.4pct) * 0.25, eqrev3.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, eqrev3.bsrevonly.4pct)

eqrev4.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(percentile.helper.bsrevonly, by = c("District Name", "number", "type")) %>%
  mutate(eqblw95.bsrevonly.4pct = 50,
         eqabv95.bsrevonly.4pct = 50,
         eqrev4.bsrevonly.4pct = round(awadm22 * eqblw95.bsrevonly.4pct),
         eqrev4.bsrevonly.4pct = ifelse(deqgap.bsrevonly.4pct == 0,round(awadm22 * eqabv95.bsrevonly.4pct), eqrev4.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, eqrev4.bsrevonly.4pct)

eqrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(eqrev1.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev2.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev3.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev4.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eqrev.bsrevonly.4pct = eqrev1.bsrevonly.4pct + eqrev2.bsrevonly.4pct + eqrev3.bsrevonly.4pct + eqrev4.bsrevonly.4pct) %>%
  select(`District Name`, number, type, eqrev.bsrevonly.4pct)

eqaid.bsrevonly.4pct <- original %>%
  left_join(eqrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eq_eq_factor.bsrevonly.4pct = 510000,
         eqlvy.bsrevonly.4pct = 0.0,
         eqlvy.bsrevonly.4pct = ifelse(wadm22 > 0 & group == 1, round(eqrev.bsrevonly.4pct * ((rmkv19 / wadm22) / eq_eq_factor.bsrevonly.4pct)), eqlvy.bsrevonly.4pct),
         eqlvy.bsrevonly.4pct = ifelse(eqlvy.bsrevonly.4pct > eqrev.bsrevonly.4pct, eqrev.bsrevonly.4pct, eqlvy.bsrevonly.4pct),
         eqaid.bsrevonly.4pct = eqrev.bsrevonly.4pct - eqlvy.bsrevonly.4pct) %>%
  select(`District Name`, number, type, eqaid.bsrevonly.4pct)

penrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(penrev.bsrevonly.4pct = penrev) %>%
  select(`District Name`, number,  type, penrev.bsrevonly.4pct)

optadjfa.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(tsparrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         optadjin.bsrevonly.4pct = 0.0,
         optadjin.bsrevonly.4pct = 0.0,
         optbasch.bsrevonly.4pct = round((clwadm22 + mclwadm22) * fa22.4pct * trapct),
         optsrsch.bsrevonly.4pct = round((clwadm22 + mclwadm22) * tsparaln.bsrevonly.4pct),
         optextch.bsrevonly.4pct = 0.0,
         optadjch.bsrevonly.4pct = optbasch.bsrevonly.4pct + optextch.bsrevonly.4pct + optsrsch.bsrevonly.4pct,
         optadjfa.bsrevonly.4pct = round(cfwadm22 * -fa22.4pct),
         optadjfa.bsrevonly.4pct = ifelse(type == 70, round(0 * fa22.4pct / fa22.4pct), optadjfa.bsrevonly.4pct),
         optadjfa.bsrevonly.4pct = ifelse(type == 90, round(641313.36 * fa22.4pct / fa22.4pct), optadjfa.bsrevonly.4pct),
         optadj.bsrevonly.4pct = optadjin.bsrevonly.4pct + optadjch.bsrevonly.4pct + optadjfa.bsrevonly.4pct) %>%
  select(`District Name`, number, type, optadj.bsrevonly.4pct)

master.bsrevonly.4pct <- bsrev.bsrevonly.4pct %>%
  left_join(exdayr.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(gtrev22.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(smlrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(decrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(afdc22.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(totlep.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(totspar.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(cexaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(hhaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(tsparrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(optadjfa.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(penrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  select(1:8, 10:16, 18:20) %>%
  gather(key = "categories", value = "revenue.bsrevonly.4pct", 4:18 ) %>%
  mutate(categories = str_sub(categories, 1, -16),
         categories = trimws(categories, which = "both"),
         revenue.bsrevonly.4pct = ifelse(is.na(revenue.bsrevonly.4pct), 0, revenue.bsrevonly.4pct)) 


```


```{r district join}
district.join <- original %>%
  select(`District Name`, number, type, group, `County Name`, countyfp, Dem_Desc, planning.region, edr, awadm22) %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```


```{r district prop}
prop.group <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(group) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n)) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  select(Definition, total.dataset.n, total.dataset.pct.n)

prop.ruca <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(Dem_Desc) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.prop = total.dataset.n / sum(total.dataset.n)) 

prop.pr <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(planning.region) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n))

prop.edr <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(edr) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n))

```

<br>

Okay, I will now combine everything I've learned and analyze the following questions;

1. Which school district receives the largest "boost" in total funding between the two scenarios?
    a. If there are significant differences between the scenarios, why?
2. Which school  district receives the largest "boost" in revenue / APU for each scenario?
    a. If there are significant differences between the scenarios, why?
3. Do continued increases to specific scenarios compound changes?
Essentially - if tied to inflation, will things get out of whack?

The two scenarios being compared are listed in the following two sections.

<br>

# Overview of scenarios

The general education formula was developed in order to bring fairness in eduction funding across school districts independent of where they are located (property values, etc...) while also acknowledging that some schools will cost more to operate due to location and characteristics of the district. By only focusing on increasing one element of the formula, there is risk of making funding school districts unbalanced. 

There are multiple ways in which legislators can change the general education revenue formula. However, it is typical that legislators will increase difference funding mechanisms by percentages. For example, the legislature can increase the basic education revenue by 4%. In FY22 that would mean the revenue would jump from `r filter(original, number == 6) %>% select(fa22)` to `r filter(original, number == 6) %>% select(fa22) %>% mutate(fa22.4pct = (fa22 * .04) + fa22) %>% select(fa22.4pct)`.

One advantage of only increasing the basic education revenue component is that that component is linked to a few other components. For example, the declining enrollment component provides additional revenues for districts with decreasing enrollment by providing 28% of the basic education revenue value multiplied by the difference between FY22 and FY21 APUs. The components that are linked to the basic education revenue component are;

* Declining enrollment
* Compensatory
* Sparsity, 
* Transportation sparsity, and
* Options adjustment.

On the flip side of all this, the legislature could also choose other elements to adjust, such as increasing the gifted and talented revenue from $13 to $14 per APU. 

I want to analyze what happens to total revenues for schools when focusing on one component vs. all components for increases. Therefore the following scenarios will be compared;

1. 4% increase to all components in the formula
2. 4% increase to the basic education revenue component only.

This will help us determine if some schools benefit way more by only focusing on one component for increases rather than the entire formula.

<br>

## Overview of scenario 1: 4% increase for entire formula

The following is a list of all the components and how each one was adjusted by 4%. 

<br>

**Basic education revenue**

The basic education revenue category provides a base amount of revenue per adjusted pupil units to each school district.

A 4% would bring the revenue from $6,728 to `r dollar((6728*.04)+6728)`.

<br>

**Extended time**

This program allows a school district to count a student who participates in extended programming for up to an additional 0.2 students in ADM for the time the student spends in summer school, etc…. The allowance is $5,117 X the district’s extended time adjusted pupil units.

A 4% increase would bring the revenue from $5,117 to `r dollar((5117*.04)+5117)`.

<br>

**Gifted and talented**

A school district receives $13 per pupil unit for gifted and talented programming. $13 X adjusted pupil units. Must be spent on gifted and talented students.

A 4% increase would bring the revenue from $13 to `r dollar((13*.04) + 13)`. 

<br>

**Small schools**

A school district that serves less than 960 pupil units is eligible for small schools revenue equal to $544 X the district’s adjusted pupil units, times the ratio of 960 less the district’s adjusted pupil units to 960.

A 4% increase would bring the revenue from $544 to `r dollar((544*.04) + 544)`.

In addition, a few schools received a dollar amount that wasn't in the usual $544 x APU ratio due to having multiple schools in the district. A few of the schools in these districts qualified for small schools funding. Each of these were also increased.

* District 318, from $70,189.06 to  `r dollar((70189.06*.04) + 70189)`,
* District 363, from $115,058.66 to `r dollar((115058.66 * .04) + 115058.66)`,
* District 381, from $241,346.69 to `r dollar((241346.69 * .04) + 241346.69)`,
* District 2142, from $404,349.22 to `r dollar((404349.22 * .04) + 404349.22)`.

<br>

**Declining enrollment**

Revenue equals the greater of zero or 28% of the formula allowance for that year and the difference between adjusted pupil units for the current year and the adjusted pupil units for the previous year.

A 4% increase would bring the revenue from $1,884 to `r dollar((1884 *.04)+1884)`.

<br>

**Local optional aid**

This revenue is meant to help equalize property rich schools districts and property poor school districts by providing extra aid to property poor districts. This is done by calculating the revenue, then the levy with equalizing factors, and then aid is distributed by subtracting the levy from the revenue.

* Revenue
    + Tier 1: from $300 to `r dollar((300*.04)+300)`
    + Tier 2: $424 to `r dollar((424*.04) + 424)`
* Levy equalizing factors
    + Tier 1: $880,000 to `r dollar((880000*.04) + 880000)`
    + Tier 2: $510,000 to `r dollar((510000*.04) + 510000)`
    
<br>

**Compensatory**

Compensatory is a site-based revenue and at least 50% of the revenue must be distributed to qualifying programs at each site. The revenue must be used to meet the educational needs of pupils whose progress toward meeting state or local content or performance standards is below the level that is appropriate for learners of their age. This revenue must be put into a separate account. Revenue increases as the number of compensatory pupil units goes up, which is driven by the number of free and reduced price meals.

A pupil is counted as compensatory pupil if the pupil is eligible for free or reduced priced meals, which is set by the Federal government at 130% and 185 % of the federal poverty guidelines.

* Compensatory Revenue = (Basic Formula Allowance - $839) x .6 x Compensatory Pupil Units
* Compensatory Pupil Units = (free lunch students + .5 x reduced lunch students) x the less of:
one, or (free lunch students + .5 x reduced lunch students) / building ADM / .8

A 4% increase in this funding is linked to the basic education revenue so it would be $5,889 to `r dollar((5889*.04)+5889)`. However, we were not provided the number of students that qualified for free or reduced lunch at each district but rather just given the total compensatory value for each school district. So in this case, we just increased the total dollar amount by 4%.

<br>

**English learners**

English learner revenue: a school district with at least one student eligible for EL services has a statutorily assigned minimum EL pupil count of 20. In addition, a district received more english learner revenue depending on the concentration of english learner students within the district.

A 4% increase for the basic EL revenue would go from $704 to `r dollar((704*.04) + 704)`.

A 4% increase for EL concentration revenue would go from $250 to `r dollar((250*.04) + 250)`.

<br>

**Sparsity**

This is a vertical funding mechanism meant to shore up support for school districts that serve small student population for an area not served by other schools. It acknowledges the challenges associated with the lack of economies of scale to providing education.

There are three parts to this revenue;

* Secondary school sparsity
* Elementary school sparsity
* Sparsity guarantee

The two main components that can be changed are the following;

* Basic education revenue - $530: a 4% increase goes from $6,198.00 to `r dollar((6198*.04)+6198)`.
* Elementary sparsity revenue: the total revenue received by each school district was provided so we just multiplied the total revenue by 4%.

<br>

**Operating Capital aid**

Operating capital revenue must be reserved and used for equipment and facility needs. The computation is, the sum of $79 per pupil unit and the product of $109 per pupil unit and the district’s average building age index. The age index is called the maintenance cost index (MCI) and is calculated as follows;

* MCI = (weighted square footage of buildings) / (Unweighted square footage of buildings)
* The weighted square food is the buildings square footage times the lesser of 1.5 or the sum of 1 + (the age of each building or addition / 100).

Operating capital revenue is provided through an equalized aid and levy and is computed as follows;

* Operating capital revenue - [$79 + (MCI x $109)] x adjusted pupil units
* Operating capital levy = Operating capital revenue x the less of 1 or (adjusted net tax capacity /Adjusted Pupil Units) / $23,885
* Operating capital aid = Operating Capital Revenue - Operating Capital Levy

The following adjustments were made for this scenario;

A 4% increase of $79 is `r dollar((79*.04) + 79)`.

A 4% increase of $109 is `r dollar((109*.04) + 109)`.

A 4% increase for the equalizing factor goes from $23,885 to `r dollar((23885 * .04) + 23885)`.

<br>

**Transportation sparsity**

Transportation sparsity revenue provides revenue to school districts that have a relatively low ratio of pupils to the square mile area of the school district.

the primary change here is the increase in the basic education revenue.

A 4% would bring the revenue from $6,728 to `r dollar((6728*.04)+6728)`.

<br>

**Equity**

Equity revenue is designed to provide additional revenue to districts with lower amounts of referendum revenue. Calculations for this revenue is broken into two regions - the 7-county metro and greater Minnesota. The formula consists of three parts.

1. Basic equity revenue: equals the product of 125% x [$14 +($80 x district’s equity index)] x adjusted pupil units
    + Equity index = 1 - (basic formula allowance + local optional revenue + referendum revenue) / per pupil amount for the district at the 95th percentile in that region
    + School districts of the first class (Minneapolis, St. Paul, and Duluth) don’t receive basic equity revenue
2. Low referendum revenue: district has per pupil referendum revenue less than 10% of the statewide average receives an additional equity amount equal to the lesser of $100,000 or the difference between 10% of the statewide average referendum revenue and the district’s current amount of referendum revenue.
3. Supplemental equity revenue: all school districts receive $50 per pupil unit.

Equity aid and levy: A district’s total equity revenue is equalized on referendum market value using an equalizing factor of $510,000.

The primary change in equity funding in this scenario is;

* Basic education revenue: from $6,728 to `r dollar((6728*.04)+6728)`
* Updated revenue (4% scenario) from small schools, location optional referendum, transition revenue, and referendum revenue. 
* A 4% increase to $14 is `r dollar((14*.04)+14)`.
* A 4% increase to $80 is `r dollar((80*.04)+80)`.
* A 4% increase to $50 is `r dollar((50*.04) + 50)`.
* A 4% increase to the equalizing factor goes from $500,000 to `r dollar((500000*.04) + 500000)`.

<br>

**Transition**

No changes were made to this revenue.

<br>

**Pension adjustment**

No changes were made to the pension adjustment.

<br>

**Options adjustment**

The change here was in the basic education revenue allotment.

A 4% increase goes from $6728 to `r dollar((6728*.04)+6728)`.

<br>

## Overview of scenario 2: 4% increase to basic education revenue component

Due to the basic education revenue component being linked to other components, it's important to understand what changes.

The following is a list of the components that are impacted by a 4% increase to only the basic education revenue component.

<br>

**Declining enrollment**

Revenue equals the greater of zero or 28% of the formula allowance for that year and the difference between adjusted pupil units for the current year and the adjusted pupil units for the previous year.

A 4% increase would bring the revenue from $1,884 to `r dollar((1884 *.04)+1884)`.

<br>

**Compensatory**

Compensatory is a site-based revenue and at least 50% of the revenue must be distributed to qualifying programs at each site. The revenue must be used to meet the educational needs of pupils whose progress toward meeting state or local content or performance standards is below the level that is appropriate for learners of their age. This revenue must be put into a separate account. Revenue increases as the number of compensatory pupil units goes up, which is driven by the number of free and reduced price meals.

A pupil is counted as compensatory pupil if the pupil is eligible for free or reduced priced meals, which is set by the Federal government at 130% and 185 % of the federal poverty guidelines.

* Compensatory Revenue = (Basic Formula Allowance - $839) x .6 x Compensatory Pupil Units
* Compensatory Pupil Units = (free lunch students + .5 x reduced lunch students) x the less of:
one, or (free lunch students + .5 x reduced lunch students) / building ADM / .8

A 4% increase in this funding is linked to the basic education revenue so it would be $5,889 to `r dollar((5889*.04)+5889)`. However, we were not provided the number of students that qualified for free or reduced lunch at each district but rather just given the total compensatory value for each school district. So in this case, we just increased the total dollar amount by 4%.

<br>

**Sparsity**

This is a vertical funding mechanism meant to shore up support for school districts that serve small student population for an area not served by other schools. It acknowledges the challenges associated with the lack of economies of scale to providing education.

There are three parts to this revenue;

* Secondary school sparsity
* Elementary school sparsity
* Sparsity guarantee

The two main components that can be changed are the following;

* Basic education revenue - $530: a 4% increase goes from $6,198.00 to `r dollar((6198*.04)+6198)`.

* Elementary sparsity revenue: the total revenue received by each school district was provided so we just multiplied the total elementary sparsity revenue provided by 4%.

<br>

**Transportation sparsity**

Transportation sparsity revenue provides revenue to school districts that have a relatively low ratio of pupils to the square mile area of the school district.

the primary change here is the increase in the basic education revenue.

A 4% would bring the revenue from $6,728 to `r dollar((6728*.04)+6728)`.

<br>

**Options adjustment**

The change here was in the basic education revenue allotment.

A 4% increase goes from $6728 to `r dollar((6728*.04)+6728)`.

<br>

# Analysis of largest boost: pct change from original revenue

In this analysis, we are going to measure the "boost" received by each scenario from their original total revenue from the general education revenue formula, and which component of the formula drives the difference between the two scenarios. We will start with school districts, then look at public vs. charter schools, then RUCA categories, planning regions, and economic development regions.

## Aggregated analysis{.tabset}

In this section of the analysis, we are going to explore the boost in revenues observed via aggregating revenues at the categorical (i.e. public vs. charter) and geographical (i.e. planning region). Essentially, which regions and categories receive the highest boost between scenarios, not necessarily the school district.

Let's first take a look at the total dollar amounts for each scenario. The table below is the total revenue provided by the general education revenue under these three scenarios;

1. the original amount provided in FY22
2. a 4% increase to all components of the formula
3. a 4% increase to only the basic education revenue component.

A 4% increase to only the basic education revenue component would be $276,288,982, or 3.75% increase from the original amount. A 4% increase to the entire general education formula (all components) would be an increase of 
$307,276,630 or 4.17%. This is a difference of nearly $31 million between the two scenarios which is .42% of the original revenue provided. 
<br>

```{r total revenue summary}
summary.total.rev <- master.original %>%
  left_join(master.4pct, by = c("District Name", "number", "type", "categories")) %>%
  left_join(master.bsrevonly.4pct, by = c("District Name", "number", "type", "categories")) %>%
  left_join(district.join, by = c("District Name", "number", "type"))

summary.total.rev.all <- summary.total.rev %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE),
            revenue.4pct = sum(revenue.4pct, na.rm = TRUE),
            revenue.4pct.pct.change = (revenue.4pct - revenue.original) / revenue.original,
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct, na.rm = TRUE),
            revenue.bsrevonly.4pct.pct.change = (revenue.bsrevonly.4pct - revenue.original) / revenue.original) %>%
  mutate(`Diff between scenarios` = revenue.4pct - revenue.bsrevonly.4pct,
         `Diff between scenarios - pct of original` = `Diff between scenarios` / revenue.original)


datatable(summary.total.rev.all, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 0:6)),
                         scrollX = TRUE)) %>%
  formatCurrency(1:2, "$", digits = 0) %>%
  formatPercentage(3, digits = 2) %>%
  formatCurrency(4, "$") %>%
  formatPercentage(5, digits = 2) %>%
  formatCurrency(6, "$") %>%
  formatPercentage(7, digits = 2)

```

<br>

Let's take a look and see if what the changes are based on public vs charter schools, RUCA categories and geography.

The public vs charter school table shows that public schools see the largest boost from the two scenarios. Public schools experience a .43% boost by increasing the entire formula vs. only the basic education revenue component by 4% compared to .28% for charter schools.

The RUCA table shows that our most rural districts receive the largest boost by going from increasing only basic education revenue component to increasing the entire formula with a .54% increase. Entirely urban receives a .36% increase. In addition, the entirely rural school districts experience the lowest boost if only the basic education revenue component is increased by 4%. 
The planning region table shows that Southwest, Central, Southeast, and Northwest receive rather large boosts going from increasing only the bsic education revenue component by 4% compared to increasing the entire formula by 4%. In fact, Southwest goes from receiving the lowest boost if only the basic education revenue component is increased by 4%. But, if the entire formula is increased by 4%, it receives the 2nd largest boost.

The EDRs shows a similar trend. EDR 8, 6W, 6E and 1 all receive rather large boosts from going from one scenario to the other (over .5%). That boost helps them jump up the rankings. For example, EDR 8 receives the 11th lowest boost if basic education revenue component is incresaed by 4%. However, if the entire framework is increased by 4%, it jumps up to having the highest boost. 

<br>

### Public vs. charter

<br>

```{r total revenue summary group}
summary.total.rev.group <- summary.total.rev %>%
  group_by(group) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE),
            revenue.4pct = sum(revenue.4pct, na.rm = TRUE),
            revenue.4pct.pct.change = (revenue.4pct - revenue.original) / revenue.original,
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct, na.rm = TRUE),
            revenue.bsrevonly.4pct.pct.change = (revenue.bsrevonly.4pct - revenue.original) / revenue.original) %>%
  ungroup() %>%
  mutate(`Diff between scenarios` = revenue.4pct - revenue.bsrevonly.4pct,
         `Diff between scenarios - pct of original` = `Diff between scenarios` / revenue.original) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  arrange(desc(revenue.4pct.pct.change)) %>%
  mutate(rank.4pct.pct.change = seq(n())) %>%
  arrange(desc(revenue.bsrevonly.4pct.pct.change)) %>%
  mutate(rank.4pct.bsrevonly.pct.change = seq(n())) %>%
  arrange(desc(`Diff between scenarios - pct of original`)) %>%
  mutate(rank.diff.between.scenarios = seq(n())) %>%
  select(Definition, 2:8, 10:12)

datatable(summary.total.rev.group, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:10)),
                         scrollX = TRUE)) %>%
  formatCurrency(2:3, "$", digits = 0) %>%
  formatPercentage(4, digits = 2) %>%
  formatCurrency(5, "$") %>%
  formatPercentage(6, digits = 2) %>%
  formatCurrency(7, "$") %>%
  formatPercentage(8, digits = 2)
```

<br>

### RUCA

<br>

```{r total revenue summary ruca}
summary.total.rev.ruca <- summary.total.rev %>%
  drop_na(Dem_Desc) %>%
  group_by(Dem_Desc) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE),
            revenue.4pct = sum(revenue.4pct, na.rm = TRUE),
            revenue.4pct.pct.change = (revenue.4pct - revenue.original) / revenue.original,
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct, na.rm = TRUE),
            revenue.bsrevonly.4pct.pct.change = (revenue.bsrevonly.4pct - revenue.original) / revenue.original) %>%
  ungroup() %>%
  mutate(`Diff between scenarios` = revenue.4pct - revenue.bsrevonly.4pct,
         `Diff between scenarios - pct of original` = `Diff between scenarios` / revenue.original) %>%
  arrange(desc(revenue.4pct.pct.change)) %>%
  mutate(rank.4pct.pct.change = seq(n())) %>%
  arrange(desc(revenue.bsrevonly.4pct.pct.change)) %>%
  mutate(rank.4pct.bsrevonly.pct.change = seq(n())) %>%
  arrange(desc(`Diff between scenarios - pct of original`)) %>%
  mutate(rank.diff.between.scenarios = seq(n())) 

datatable(summary.total.rev.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:10)),
                         scrollX = TRUE)) %>%
  formatCurrency(2:3, "$", digits = 0) %>%
  formatPercentage(4, digits = 2) %>%
  formatCurrency(5, "$") %>%
  formatPercentage(6, digits = 2) %>%
  formatCurrency(7, "$") %>%
  formatPercentage(8, digits = 2)

```

<br>

### Planning Region

<br>

```{r total revenue summary pr}
summary.total.rev.pr <- summary.total.rev %>%
  drop_na(planning.region) %>%
  group_by(planning.region) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE),
            revenue.4pct = sum(revenue.4pct, na.rm = TRUE),
            revenue.4pct.pct.change = (revenue.4pct - revenue.original) / revenue.original,
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct, na.rm = TRUE),
            revenue.bsrevonly.4pct.pct.change = (revenue.bsrevonly.4pct - revenue.original) / revenue.original) %>%
  ungroup() %>%
  mutate(`Diff between scenarios` = revenue.4pct - revenue.bsrevonly.4pct,
         `Diff between scenarios - pct of original` = `Diff between scenarios` / revenue.original) %>%
  arrange(desc(revenue.4pct.pct.change)) %>%
  mutate(rank.4pct.pct.change = seq(n())) %>%
  arrange(desc(revenue.bsrevonly.4pct.pct.change)) %>%
  mutate(rank.4pct.bsrevonly.pct.change = seq(n())) %>%
  arrange(desc(`Diff between scenarios - pct of original`)) %>%
  mutate(rank.diff.between.scenarios = seq(n())) 

datatable(summary.total.rev.pr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:10)),
                         scrollX = TRUE)) %>%
  formatCurrency(2:3, "$", digits = 0) %>%
  formatPercentage(4, digits = 2) %>%
  formatCurrency(5, "$") %>%
  formatPercentage(6, digits = 2) %>%
  formatCurrency(7, "$") %>%
  formatPercentage(8, digits = 2)

```

<br>

### EDR

<br>

```{r total revenue summary edr}
summary.total.rev.edr <- summary.total.rev %>%
  drop_na(edr) %>%
  group_by(edr) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE),
            revenue.4pct = sum(revenue.4pct, na.rm = TRUE),
            revenue.4pct.pct.change = (revenue.4pct - revenue.original) / revenue.original,
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct, na.rm = TRUE),
            revenue.bsrevonly.4pct.pct.change = (revenue.bsrevonly.4pct - revenue.original) / revenue.original) %>%
  ungroup() %>%
  mutate(`Diff between scenarios` = revenue.4pct - revenue.bsrevonly.4pct,
         `Diff between scenarios - pct of original` = `Diff between scenarios` / revenue.original) %>%
  arrange(desc(revenue.4pct.pct.change)) %>%
  mutate(rank.4pct.pct.change = seq(n())) %>%
  arrange(desc(revenue.bsrevonly.4pct.pct.change)) %>%
  mutate(rank.4pct.bsrevonly.pct.change = seq(n())) %>%
  arrange(desc(`Diff between scenarios - pct of original`)) %>%
  mutate(rank.diff.between.scenarios = seq(n())) 

datatable(summary.total.rev.edr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:10)),
                         scrollX = TRUE)) %>%
  formatCurrency(2:3, "$", digits = 0) %>%
  formatPercentage(4, digits = 2) %>%
  formatCurrency(5, "$") %>%
  formatPercentage(6, digits = 2) %>%
  formatCurrency(7, "$") %>%
  formatPercentage(8, digits = 2)

```



<br>

Finally, let's look at this at the county level. We are going to look at the boost school districts within each county receive if the entire general education revenue framework is increased by 4% vs. only increasing the basic education revenue component.

The map below pretty clearly shows that school districts located in southwest Minnesota receive the highest boost if the entire general education revenue framework is increased vs only the basic education component.

## {.unnumbered .unlisted .toc-ignore}

```{r total revenue summary county}
summary.total.rev.county <- summary.total.rev %>%
  drop_na(`County Name`) %>%
  group_by(`County Name`, countyfp) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE),
            revenue.4pct = sum(revenue.4pct, na.rm = TRUE),
            revenue.4pct.pct.change = (revenue.4pct - revenue.original) / revenue.original,
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct, na.rm = TRUE),
            revenue.bsrevonly.4pct.pct.change = (revenue.bsrevonly.4pct - revenue.original) / revenue.original) %>%
  ungroup() %>%
  mutate(`Diff between scenarios` = revenue.4pct - revenue.bsrevonly.4pct,
         `Diff between scenarios - pct of original` = `Diff between scenarios` / revenue.original) %>%
  arrange(desc(revenue.4pct.pct.change)) %>%
  mutate(rank.4pct.pct.change = seq(n())) %>%
  arrange(desc(revenue.bsrevonly.4pct.pct.change)) %>%
  mutate(rank.4pct.bsrevonly.pct.change = seq(n())) %>%
  arrange(desc(`Diff between scenarios - pct of original`)) %>%
  mutate(rank.diff.between.scenarios = seq(n())) %>%
  left_join(mn_counties[,c(4,7)], by = "countyfp")

summary.total.rev.county.map <- ggplot(summary.total.rev.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = `Diff between scenarios - pct of original`, data_id = countyfp, tooltip = paste(`County Name`, "\nOriginal total revenue: ", dollar(revenue.original), "\nRevenue if only basic education component is increased 4%: ", dollar(revenue.bsrevonly.4pct), "\nRevenue if entire general education framework is increased 4%: ", dollar(revenue.4pct), "\nPercent difference between two scenarios: ", percent(`Diff between scenarios - pct of original`, accuracy = .2), sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "PuBu", direction = 1, labels = scales::percent) +
  labs(title = "Percent difference etween two scenarios") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = summary.total.rev.county.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```


<br>



## Not aggregated - School districts{.tabset}

In this section we will keep all revenues and scenarios based at the school district level and not sum up revenues according to difference categories and regions. We will then look at relationships between districts that experience the largest changes in the scenarios and their categories and regions - essentially, do the districts that would experience the largest boost (top 25%) have a relationship to RUCA category and geography? We will use a z-test to analyze the proportions of districts in the top 25% based on categorical and geographical characteristics and whether they are statistically significantly different than the proportion that the schools make up in the entire dataset.

First, we will examine how schools districts are impacted by the increase from each scenario as a percentage of their original total funding from the general education formula in FY22.

The table below provides the total original revenue received in FY22 as well as the total revenues from a 4% increase to the entire general education revenue formula and a 4% increase to the basic education revenue component only. In addition, the table provides the percent change from the original FY22 revenue for each of the scenarios, where those changes rank against their peers, as well as the percentage of the original budget lost if increasing the bsrev only vs. increasing the entire formula.

What's interesting is that if you sort by `Rank of pct lost between  scenarios` you will see that the top three school districts would lose 1% 

<br>

### Table

<br>

```{r revenue increase pct original districts}
comp.total.rev.change.districts <- master.4pct %>%
  left_join(master.bsrevonly.4pct, by = c("District Name", "number", "type", "categories")) %>%
  left_join(master.original, by = c("District Name", "number", "type", "categories")) %>%
  group_by(`District Name`, number, type) %>%
  summarize(total.rev.original = sum(revenue.original, na.rm = TRUE),
            total.rev.4pct.all = sum(revenue.4pct, na.rm = TRUE),
            total.rev.4pct.bsrev = sum(revenue.bsrevonly.4pct, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(total.rev.original > 0) %>%
  mutate(pct.diff.original.4pct.all = (total.rev.4pct.all - total.rev.original) / total.rev.original,
         pct.diff.original.4pct.bsrev = (total.rev.4pct.bsrev - total.rev.original) / total.rev.original,
         pct.gain.between.scenarios = (total.rev.4pct.all - total.rev.4pct.bsrev) / total.rev.original) %>%
  filter(pct.diff.original.4pct.all > 0,
         pct.diff.original.4pct.bsrev > 0) %>%
  arrange(desc(pct.gain.between.scenarios)) %>%
  mutate(rank.pct.gain.between.scenarios = seq(n())) %>%
  arrange(desc(pct.diff.original.4pct.all)) %>%
  mutate(rank.change.4pct.all = seq(n())) %>%
  arrange(desc(pct.diff.original.4pct.bsrev)) %>%
  mutate(rank.change.4pct.bsrev = seq(n())) %>%
  rename(`Total rev - original` = total.rev.original,
         `Total rev - 4pct all` = total.rev.4pct.all,
         `Total rev - bsrev only` = total.rev.4pct.bsrev,
         `Pct change from OG - 4pct all` = pct.diff.original.4pct.all,
         `Pct change from OG - 4pct bsrev only` = pct.diff.original.4pct.bsrev,
         `Percent of original gained between scenarios` = pct.gain.between.scenarios,
         `Rank of pct gained between 2 scenarios` = rank.pct.gain.between.scenarios,
         `Rank of change from OG - 4pct all` = rank.change.4pct.all,
         `Rank of change from OG - 4pct bsrev` = rank.change.4pct.bsrev) %>%
  filter(`District Name` != "Minnesota State Academies")

datatable(comp.total.rev.change.districts, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:11)),
                         scrollX = TRUE)) %>%
  formatCurrency(4:6, "$") %>%
  formatPercentage(7:9, digits = 4) 

```

<br>

### Range

<br>

```{r revenue increase pct original range districts}
comp.total.rev.change.range.districts <- comp.total.rev.change.districts %>%
  gather(key = "key", value = "pct.change", 7:9)

comp.total.rev.change.range.districts.plot <- ggplot(comp.total.rev.change.range.districts, aes("Pct change", pct.change)) +
  facet_wrap(~key, ncol = 2, scales = "free_y") +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\n", key, "\nPercent change from original: ", percent(pct.change, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Percent change from original funding")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  theme(legend.position = "none",
        text = element_text(size = 18))

girafe(ggobj = comp.total.rev.change.range.districts.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

tags$br()

comp.total.rev.change.range.districts.table <- comp.total.rev.change.range.districts %>%
  group_by(key) %>%
  summarize(range = range(pct.change)) %>%
  ungroup() %>%
  group_by(key) %>%
  mutate(ID = seq(n())) %>%
  ungroup() %>%
  spread(ID, range) %>%
  rename(Minimum = `1`,
         Maximum = `2`) %>%
  mutate(Range = Maximum - Minimum)

datatable(comp.total.rev.change.range.districts.table, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:3)),
                         scrollX = TRUE)) %>%
  formatPercentage(2:3, digits = 4) %>%
  formatPercentage(4, digits = 4)
```

<br>

## {.unnumbered .unlisted .toc-ignore .tabset}

Let's take a look to see if those schools that experience the largest "boost" from a 4% increase to basic education revenue component only to a 4% increase across the entire formula are related to whether it's a charter vs. public school, it's RUCA category, and it geographic location. We will use the top 75% with the highest gains in percent of original revenue terms between the two scenarios. The quantiles for that data are;

`r quantile(comp.total.rev.change.districts$'Percent of original gained between scenarios')`.

The public vs. charter school table shows that there was only 1 charter school in the top 25%. Obviously, this means that there is a statistically significant difference since charter schools make up 36% of the entire dataset. There were 126 school districts with the largest difference between the two scenarios are public schools.

The RUCA categories also indicate a statistically significant difference between being in the top quartile and it's proportion of the total dataset. The biggest difference is the number of schools located in a urban/town/rural mix county that are in the top quartile -  n = 53, pct = 42% compared to being only 27% of the entire dataset. Enrirely rural and town/rural mix school districts also had a higher percentage of schools in the top quartile compared to their proportion of the total dataset. The other major difference is how few school districts located in entirely urban counties are in the top quartiler compared to it's proportion of the dataset - 10% vs 41% of the dataset.

The planning regions indicate that Central, Southwest and Southeast make up a significantly larger proportion of the top quartile compared to it's population; 18% vs. 13%,  29% vs. 15%, and 20% vs. 11%, respectively. The other regions have either similar (Northwest) or significantly lower proportions of the top quartile (Seven County metro).

In addition, the EDR's show that, in particular, EDRs in Southern MN have a higher proportion of school districts in the top quartile compared to other regions. EDR 8, 9, and 10 all have significantly higher percentages - 15% vs. 6%, 11% vs. 7%, and 21% vs. 11%, respectively.

Lastly, the county map shows that the location of schools that are in the top quartiler are concentrated in the southern part of the state.

<br>

```{r calculate top 75%}
top.75pct <- quantile(comp.total.rev.change.districts$`Percent of original gained between scenarios`, .75) %>%
  unname()
```

### Public vs. Charter

```{r top boost group}
top.boost.districts <- comp.total.rev.change.districts %>%
  filter(`Percent of original gained between scenarios` >= top.75pct) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  filter(group %in% c(1,4)) 

top.boost.group <- top.boost.districts %>%
  group_by(Definition) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct = n / sum(n)) %>%
  right_join(prop.group, by = "Definition") %>%
  mutate(n = ifelse(is.na(n), 0, n),
         pct = ifelse(is.na(pct), 0, pct),
         prop = n / total.dataset.n)

datatable(top.boost.group, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)),
                         scrollX = TRUE)) %>%
  formatPercentage(3, digits = 2) %>%
  formatPercentage(5, digits = 2) %>%
  formatPercentage(6, digits = 2)
  

prop.test(top.boost.group$n, top.boost.group$total.dataset.n)

```

<br>

### RUCA

<br>

```{r top boost ruca}

top.boost.ruca <- top.boost.districts %>%
  group_by(Dem_Desc) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct = n / sum(n)) %>%
  left_join(prop.ruca, by = "Dem_Desc") %>%
  mutate(n = ifelse(is.na(n), 0, n),
         pct = ifelse(is.na(pct), 0, pct),
         prop = n / total.dataset.n)

datatable(top.boost.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)),
                         scrollX = TRUE)) %>%
  formatPercentage(3, digits = 2) %>%
  formatPercentage(5, digits = 2) %>%
  formatPercentage(6, digits = 2)
  

prop.test(top.boost.ruca$n, top.boost.ruca$total.dataset.n)

```

<br>

### Planning Region

<br>

```{r top boost pr}

top.boost.pr <- top.boost.districts %>%
  group_by(planning.region) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct = n / sum(n)) %>%
  right_join(prop.pr, by = "planning.region") %>%
  mutate(n = ifelse(is.na(n), 0, n),
         pct = ifelse(is.na(pct), 0, pct),
         prop = n / total.dataset.n)

datatable(top.boost.pr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)),
                         scrollX = TRUE)) %>%
  formatPercentage(3, digits = 2) %>%
  formatPercentage(5, digits = 2) %>%
  formatPercentage(6, digits = 2)
  

prop.test(top.boost.pr$n, top.boost.pr$total.dataset.n)

```

<br>

### EDR

<br>

```{r top boost edr}

top.boost.edr <- top.boost.districts %>%
  group_by(edr) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct = n / sum(n)) %>%
  right_join(prop.edr, by = "edr") %>%
  mutate(n = ifelse(is.na(n), 0, n),
         pct = ifelse(is.na(pct), 0, pct),
         prop = n / total.dataset.n)

datatable(top.boost.edr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)),
                         scrollX = TRUE)) %>%
  formatPercentage(3, digits = 2) %>%
  formatPercentage(5, digits = 2) %>%
  formatPercentage(6, digits = 2)
  

prop.test(top.boost.edr$n, top.boost.edr$total.dataset.n)

```

<br>

### County map

<br>

```{r top boost county}

top.boost.county <- top.boost.districts %>%
  group_by(`County Name`, countyfp) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  right_join(mn_counties[,c(3,4,7)]) %>%
  mutate(n = ifelse(is.na(n), 0, n),
         pct = n / sum(n),
         `County Name` = COUNTY_NAM) 

top.boost.county.map <- ggplot(top.boost.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = as.factor(n), data_id = countyfp, tooltip = paste(`County Name`, "\nNumber of schools in top 25: ", comma(n), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu")) +
  labs(title = "Schools in top 25 boost from scenarios") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = top.boost.county.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))


```

<br>



## {.unnumbered .unlisted .toc-ignore .tabset}

The range from above shows that about half of the school districts receive between .5% and 1% more by increasing the entire formula by 4% compared to only increasing the basic education revenue component. In addition, there does seem to be a relationship between districts that receive the highest boost going from a 4% to basic education only vs.a 4% increase to the entire formula and it's RUCA region, and geography. So, what components are driving that difference?

When looking at the categories that drive the gains from the 4% increase to basic education revenue vs. a 4% increase to the entire formula, local optional aid is the number one driver for 95.3% of the top quartile. Total sparsity is next with 5 districts having that as the top driver. The next biggest driver is operating capital aid with 61% of the second largest driver in the difference between the two scenarios. Small schools revenue and equity aid also end up being rather significant drivers in the difference for the top quartile.

The map is interesting. Obviously, local optional aid is the primary driver in the difference between the two scenarios for most of the districts in the top quartile. In northern Minnesota and in Southwest Minnesota, total sparsity and small schools revenue becomes a bigger deal. Operating capital aid, however, is also significant across nearly all districts. Equity aid also starts to pop up across many districts as the third highest category driving change between the two scenarios.

<br>

### Driver of differences

```{r driver of difference between total revenues districts}
driver.diff.total.rev.districts <- master.4pct %>%
  filter(`District Name` != "Minnesota State Academies") %>%
  left_join(master.bsrevonly.4pct, by = c("District Name", "number", "type", "categories")) %>%
  left_join(master.original, by = c("District Name", "number", "type", "categories")) %>%
  group_by(`District Name`, number, type) %>%
  mutate(total.rev.4pct = sum(revenue.4pct),
         total.rev.4pct.bsrev = sum(revenue.bsrevonly.4pct)) %>%
  ungroup() %>%
  mutate(total.rev.diff = total.rev.4pct - total.rev.4pct.bsrev) %>%
  mutate(category.diff = revenue.4pct - revenue.bsrevonly.4pct) %>%
  mutate(pct.diff = category.diff / total.rev.diff) %>%
  group_by(`District Name`, number, type) %>%
  arrange(desc(pct.diff)) %>%
  mutate(rank.pct.diff = seq(n())) %>%
  ungroup()

datatable(driver.diff.total.rev.districts, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:12)),
                         scrollX = TRUE)) %>%
  formatCurrency(5:11, "$", digits = 2) %>%
  formatPercentage(12, digits = 2)
  
```

<br>

### Top quartile districts with largest pct difference

<br>

```{r table driver of difference between total revenues top quartile districts}
driver.diff.total.rev.top.districts <- driver.diff.total.rev.districts %>%
  left_join(comp.total.rev.change.districts[,c(1,2,3,9)], by = c("District Name", "number", "type")) %>%
  filter(`Percent of original gained between scenarios` >= top.75pct) %>%
  arrange(desc(`Percent of original gained between scenarios`)) %>%
  filter(pct.diff > 0)

datatable(driver.diff.total.rev.top.districts, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:12)),
                         scrollX = TRUE)) %>%
  formatCurrency(5:11, "$", digits = 2) %>%
  formatPercentage(12, digits = 2)
  
```

<br>

### Chart - categories by rank 

<br>

```{r chart driver of difference top quartile districts}
driver.diff.total.rev.top.districts.n <- driver.diff.total.rev.top.districts %>%
  filter(rank.pct.diff < 4) %>%
  group_by(categories, rank.pct.diff) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(rank.pct.diff) %>%
  mutate(pct.rank = n / sum(n)) %>%
  ungroup() %>%
  group_by(rank.pct.diff) %>%
  arrange(desc(n)) %>%
  ungroup()

driver.diff.total.rev.top.districts.plot <- ggplot(driver.diff.total.rev.top.districts.n, aes(rank.pct.diff, pct.rank, group = categories, fill = categories)) +
  geom_col_interactive(position = "dodge", aes(data_id = categories, tooltip = paste("Rank: ", rank.pct.diff, "\nNumber of times at this rank: ", n, "\nPercent of rank: ", percent(pct.rank, accuracy = .1), sep = ""))) +
  geom_label_interactive(aes(label = categories), show.legend = FALSE, position = position_dodge(width = .9)) +
  scale_fill_manual(values = brewer.pal(n = 11, "RdYlBu")) +
  scale_y_continuous(labels = scales::percent) +
  labs(x="", y = "", color="", title = "Categories driving the difference between scenarios") +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = driver.diff.total.rev.top.districts.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```


<br>


### County map

<br>

```{r chart driver of difference top quartile districts map}
driver.diff.total.rev.top.districts.county <- driver.diff.total.rev.top.districts %>%
  filter(rank.pct.diff < 4) %>%
  left_join(school_districts[,c(1,2,7)], by = c("number", "type"))
  
driver.diff.total.rev.top.districts.county.map <- ggplot(driver.diff.total.rev.top.districts.county) +
  facet_wrap(~rank.pct.diff, ncol = 2) +
  geom_sf(data = mn_counties, color = "grey85", aes(geometry = geometry), fill = "transparent") +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = categories, data_id = pct.diff, tooltip = paste(`District Name`, "\nCategory: ", categories, "\nRank of category: ", rank.pct.diff, "\nPercent of differene between scanerios this category comprises: ", percent(pct.diff, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 11, "RdYlBu"))+
  labs(title = "Top 3 categories driving difference between two scenarios") +
  theme(legend.box.margin = margin(200, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = driver.diff.total.rev.top.districts.county.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```


