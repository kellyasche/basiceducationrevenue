---
title: "Report"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
library(ggpattern)
library(EnvStats)
library(treemapify)
library(waffle)
library(data.table)
library(ggpattern)
```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r shapefiles}
school_districts <- read_sf("Data/Shapefiles/New school shapefiles/School_district_boundaries.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01) %>%
  rename(type = SDTYPE,
         number = SDNUMBER) %>%
  mutate(number = as.numeric(number),
         type = as.numeric(type))


```


```{r master orignal}
original <- read_csv("Data/Formula/Master.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         eqgroup.label = ifelse(is.na(eqgroup.label), "", eqgroup.label)) %>%
  filter(group %in% c(1,4))

group.codes <- read_xlsx("Data/Formula/group codes.xlsx")

var.codes <- read_xlsx("Data/Formula/primary variable codes.xlsx")

categories <- c("bsrev", "exdayr", "gtrev", "smlrev", "decrev", "locaid", "afdc22", "totlep", "totspar", "cexaid", "tsparrev", "eqaid", "hhaid", "penrev")

link.comp <- c("bsrev", "decrev", "afdc22", "totspar", "tsparrev")

master.original <- original %>%
  select(`District Name`, number, type, categories) %>%
  gather(key = "categories", value = "revenue.original", 4:17) 

```


```{r district join}
district.join <- original %>%
  select(`District Name`, number, type, group, `County Name`, countyfp, Dem_Desc, planning.region, edr, awadm22) %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```

```{r master 5yr scenarios}
master.5yr.scenarios.districts <- read_csv("Data/Formula/Master-5yr-scenarios-district.csv")

scenarios.5yr.districts <-  master.5yr.scenarios.districts %>%
  rename(revenue.original = revenue.0yr) %>%
  select(`District Name`, number, type, categories, revenue.original, revenue.bsrevonly.5yr, revenue.5yr) %>%
  gather(key = "scenario", value = "revenue", 5:7) %>%
  left_join(district.join[,c(1,2,3,4,10)], by = c("District Name", "number", "type")) %>%
  mutate(revenue.apu = revenue / awadm22) %>%
  select(-revenue) %>%
  spread(scenario, revenue.apu) %>%
  select(`District Name`, number, type, group, categories, awadm22, revenue.original, revenue.bsrevonly.5yr, revenue.5yr) %>%
  rename(revenue.original.apu = revenue.original,
         revenue.bsrevonly.apu = revenue.bsrevonly.5yr,
         revenue.entire.formula.apu = revenue.5yr) %>%
  left_join(district.join, by = c("District Name", "number", "type", "group", "awadm22")) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  select(-group)
```





```{r district prop}
prop.group <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(group) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n)) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  select(Definition, total.dataset.n, total.dataset.pct.n)

prop.ruca <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(Dem_Desc) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.prop = total.dataset.n / sum(total.dataset.n)) 

prop.pr <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(planning.region) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n))

prop.edr <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(edr) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n))

```

```{r total revenues all schools}
total.rev.all.schools <- master.5yr.scenarios.districts %>%
  select(`District Name`, number, type, revenue.0yr, revenue.bsrevonly.5yr, revenue.5yr) %>%
  group_by(`District Name`, number, type) %>%
  summarize(total.rev.original = sum(revenue.0yr, na.rm = TRUE),
            total.rev.bsrevonly = sum(revenue.bsrevonly.5yr, na.rm = TRUE),
            total.rev.entire.formula = sum(revenue.5yr, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(district.join[,c(1,2,3,4,10)], by = c("District Name", "number", "type")) %>%
  mutate(total.rev.original.apu = total.rev.original / awadm22,
         total.rev.bsrevonly.apu = total.rev.bsrevonly / awadm22,
         total.rev.entire.formula.apu = total.rev.entire.formula /awadm22) %>%
  select(-total.rev.original, -total.rev.bsrevonly, -total.rev.entire.formula, -awadm22, -group)

```


<br>

# The Governor's proposal{.tabset}

The governor's proposal is to increase education funding by increasing the basic education revenue allowance by 4% the first year and by inflation in subsequent years. Over the course of 5 years this would look like the following;

* FY23: $6,863
* FY24: $7,138
* FY25: $7,572
* FY26: $7,799
* FY27: $8,033

Increasing the basic education revenue allowance doesn't mean it's the only component of the general education revenue formula that increases. Increasing this component also means increases will occur in the components that are linked to this one;

* basic skills - compensatory,
* declining enrollment,
* sparsity, and
* transportation sparsity.

As an example, let's look at the hypothetical changes to the revenue streams from the General Education Revenue Formula for Belgrade-Brooten-Elrosa Public School District. Table 1 shows that by increasing the basic education revenue component by 4% the first year with 3% inflationary increases in the four subsequent years increases the revenue streams for not only that specific component, but transportation sparsity, compensatory, sparsity, and declining enrollment. This change impacts some of the largest revenue streams in the General Education Revenue formula such as transportation sparsity, compensatory, and sparsity. 

<br>

```{r pine point example}
bbe <- scenarios.5yr.districts %>%
  filter(`District Name` == "Belgrade-Brooten-Elrosa Public School District") %>%
  left_join(var.codes, by = c("categories" = "Code")) %>%
  select(Category, revenue.original.apu, revenue.bsrevonly.apu) %>%
  arrange(desc(revenue.original.apu)) %>%
  mutate(`Pct Increase` = (revenue.bsrevonly.apu - revenue.original.apu) / revenue.original.apu,
         revenue.original.apu = dollar(revenue.original.apu),
         revenue.bsrevonly.apu = dollar(revenue.bsrevonly.apu),
         `Pct Increase` = percent(`Pct Increase`, accuracy = .1)) %>%
  rename(`FY22 original funding per APU` = revenue.original.apu,
         `FY27 proposed funding per APU` = revenue.bsrevonly.apu)

kable(format = "html", bbe, escape = F, caption = "Table 1: Belgrade-Brooten-Elrosa Public School District - changes in general education revenue components", align = "c") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>%
  row_spec(1:2, background = "yellow") %>%
  row_spec(4:5, background = "yellow") %>%
  row_spec(14, background = "yellow") 

```

<br>

# Linked and unlinked components in the General Education Formula{.tabset}

Fortunately, by increasing the basic education revenue component of the formula we are increasing the components that make up 80% or more of the entire general education revenue formula provided to districts.

The chart below provides the share of these five components (basic education, sparsity, transportation sparsity, compensatory, declining enrollment) of the entire general education framework. It clearly shows that these five components make up over 90% of the entire revenue provided to public and charter schools through the general education revenue framework.

<br>

```{r basic ed tied components pct total rev all districts together}
basic.ed.linked.pct.total <- master.original %>%
  mutate(linked.comp = ifelse(categories %in% link.comp, "Linked", "Not linked")) %>%
  group_by(linked.comp) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(pct = revenue.original / sum(revenue.original),
         linked.comp = fct_relevel(linked.comp, "Not linked", "Linked"))

basic.ed.linked.pct.total.plot <- ggplot(basic.ed.linked.pct.total, aes("", pct, fill = linked.comp)) +
  geom_bar_interactive(stat = "identity", aes(data_id = linked.comp, tooltip = paste("Linked to basic education component: ", linked.comp, "\nTotal revenue in this group: ", dollar(revenue.original), "\nPercent of total general education revenue formula: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(y = ifelse(linked.comp == "Linked", pct / 2, .97), label = percent(pct, accuracy = .1)), color = "black", show.legend = FALSE, size = 5) +
  labs(x="", y = "", color="", title = "Basic education and it's linked components as share of\ntotal general education formula", subtitle = "The basic education and it's linked components comprise a significant portion of\nthe entire general education formula") +
  coord_polar("y") +
  theme_bar +
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank(),
        plot.background = element_blank(),
        panel.grid.major = element_blank()) 

girafe(ggobj = basic.ed.linked.pct.total.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>



However, there is plenty of variation across schools. The map below provides a clear pattern in the percent that those 5 linked components comprise of the total revenue each district receives from the general education formula in FY22. The highest percentages exist in districts with higher property values - suburbs, districts with lake properties. Over 95% of the revenue they receive from the general education formula comes from those 5 components. The other districts receive between 85% and 95% of their revenue from those 5 components.



<br>

```{r basic ed and linked components as pct by district map}
basic.ed.linked.pct.total <- master.original %>%
  mutate(linked.comp = ifelse(categories %in% link.comp, "Linked", "Not linked")) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  drop_na(Dem_Desc)

basic.ed.linked.pct.total.district <- basic.ed.linked.pct.total %>%
  group_by(`District Name`, number, type, linked.comp) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(`District Name`, number, type) %>%
  mutate(pct = revenue.original / sum(revenue.original),
         linked.comp = fct_relevel(linked.comp, "Not linked", "Linked")) %>%
  ungroup() %>%
  filter(linked.comp == "Linked") %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  filter(group == 1) %>%
  filter(type != 70) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type")) 

basic.ed.linked.pct.total.district.map <- ggplot(basic.ed.linked.pct.total.district) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct, data_id = `District Name`, tooltip = paste(`District Name`, "\nRevenue from components linked to basic ed: ", dollar(revenue.original), "\nPercent of total revenue from general education formula: ", percent(pct, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "PuBu", direction = 1, labels = scales::percent) +
  labs(title = "Basic education linked components as percent of total\ngeneral education revenue", subtitle = "The highest percentages are in high property value districts such as\nthe suburbs and lakes regions.") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = basic.ed.linked.pct.total.district.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))
   

```

<br>

So what causes this variation? The districts that have lower property values tend to rely a bit more on some of the equalization components in the general education formula that aren't linked to the basic education component - namely local optional aid and small schools revenue.

The maps below provide the top 3 components that are not linked to the basic education revenue component for each district. The top unlinked component for much of rural Minnesota districts is the local optional aid and small schools revenue. These typically make up 3% to 6% of the total revenue from the general education formula. The operating capital aid is the top unlinked component for many of the districts that are "property rich" such as the suburbs and within the lakes areas. 

Once you get into the 2nd and 3rd highest unlinked components, it really becomes mixed across the districts. In addition, the percentage of the total revenue from the general education formula that each unlinked component comprises is quite low (0.5% to 3%).

<br>

## Top unlinked category for each district

<br>

```{r rank 1 unlinked components district map}
unlinked.pct.remaining.rev.districts <- basic.ed.linked.pct.total %>%
  filter(linked.comp == "Not linked") %>%
  left_join(total.rev.all.schools, by = c("District Name", "number", "type")) %>%
  filter(group == 1) %>%
  mutate(total.rev.original = total.rev.original.apu * awadm22,
         unlinked.pct.total.rev = revenue.original / total.rev.original) %>%
  group_by(`District Name`) %>%
  arrange(desc(unlinked.pct.total.rev)) %>%
  mutate(unlinked.rank = seq(n())) %>%
  ungroup() %>%
  filter(unlinked.pct.total.rev != "NaN")

unlinked.pct.remaining.rev.districts.rank.1 <- unlinked.pct.remaining.rev.districts %>%
  filter(unlinked.rank == 1) %>%
  mutate(unlinked.pct.total.rev.bins = cut(unlinked.pct.total.rev,
                                           breaks = c(quantile(.$unlinked.pct.total.rev, probs = seq(0,1,.2))),
                                           labels = c(paste(percent(unname(quantile(.$unlinked.pct.total.rev, 0)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .2)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .2)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .4)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .4)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .6)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .6)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .8)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .8)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, 1)), accuracy = .1))),
                                           include.lowest = TRUE)) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type"))

unlinked.pct.remaining.rev.districts.rank.1.comp.map <- ggplot(unlinked.pct.remaining.rev.districts.rank.1) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = categories, data_id = `District Name`, tooltip = paste(`District Name`, "\nRank of component: ", unlinked.rank, "\nUnlinked component: ", categories, "\nRevenue from component: ", dollar(revenue.original), "\nPercent of total revenue from general education formula: ", percent(unlinked.pct.total.rev, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu")) +
  labs(subtitle = "Local optional aid and small schools revenue become important to rural districts with\nlow property values") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        plot.margin = margin(-150, 0,0,0),
        text = element_text(size = 18),
        legend.position = "bottom")


unlinked.pct.remaining.rev.districts.rank.1.pct.map <- ggplot(unlinked.pct.remaining.rev.districts.rank.1) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = unlinked.pct.total.rev.bins, data_id = `District Name`, tooltip = paste(`District Name`, "\nRank of component: ", unlinked.rank, "\nUnlinked component: ", categories, "\nRevenue from component: ", dollar(revenue.original), "\nPercent of total revenue from general education formula: ", percent(unlinked.pct.total.rev, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(ncol = 2)) +
  labs(subtitle = "\n") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        plot.margin = margin(-150,0,0,0),
        text = element_text(size = 18),
        legend.position = "bottom")

title <- ggdraw() +
  draw_label(
    "Top unlinked component for each district",
    fontface = "bold",
    x = 0,
    hjust = 0,
    size = 24
  ) +
  theme(
    plot.margin = margin(0,0,0,0)
  )

row.1 <- plot_grid(unlinked.pct.remaining.rev.districts.rank.1.comp.map, unlinked.pct.remaining.rev.districts.rank.1.pct.map, ncol = 2, rel_widths = c(1,1))

girafe(ggobj = plot_grid(title, row.1, ncol = 1, rel_heights = c(.1, 1)), height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```
<br>

## 2nd highest unlinked category for each district

<br>

```{r rank 2 unlinked components district map}
unlinked.pct.remaining.rev.districts.rank.2 <- unlinked.pct.remaining.rev.districts %>%
  filter(unlinked.rank == 2) %>%
  mutate(unlinked.pct.total.rev.bins = cut(unlinked.pct.total.rev,
                                           breaks = c(quantile(.$unlinked.pct.total.rev, probs = seq(0,1,.2))),
                                           labels = c(paste(percent(unname(quantile(.$unlinked.pct.total.rev, 0)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .2)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .2)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .4)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .4)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .6)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .6)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .8)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .8)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, 1)), accuracy = .1))),
                                           include.lowest = TRUE)) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type"))

unlinked.pct.remaining.rev.districts.rank.2.comp.map <- ggplot(unlinked.pct.remaining.rev.districts.rank.2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = categories, data_id = `District Name`, tooltip = paste(`District Name`, "\nRank of component: ", unlinked.rank, "\nUnlinked component: ", categories, "\nRevenue from component: ", dollar(revenue.original), "\nPercent of total revenue from general education formula: ", percent(unlinked.pct.total.rev, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 7, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  labs(subtitle = "The 2nd highest unlinked components is much more mixed") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        plot.margin = margin(-150, 0,0,0),
        text = element_text(size = 18),
        legend.position = "bottom")


unlinked.pct.remaining.rev.districts.rank.2.pct.map <- ggplot(unlinked.pct.remaining.rev.districts.rank.2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = unlinked.pct.total.rev.bins, data_id = `District Name`, tooltip = paste(`District Name`, "\nRank of component: ", unlinked.rank, "\nUnlinked component: ", categories, "\nRevenue from component: ", dollar(revenue.original), "\nPercent of total revenue from general education formula: ", percent(unlinked.pct.total.rev, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(ncol = 2)) +
  labs(subtitle = "\n") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        plot.margin = margin(-150,0,0,0),
        text = element_text(size = 18),
        legend.position = "bottom")

title <- ggdraw() +
  draw_label(
    "2nd highest unlinked component for each district",
    fontface = "bold",
    x = 0,
    hjust = 0,
    size = 24
  ) +
  theme(
    plot.margin = margin(0,0,0,0)
  )

row.1 <- plot_grid(unlinked.pct.remaining.rev.districts.rank.2.comp.map, unlinked.pct.remaining.rev.districts.rank.2.pct.map, ncol = 2, rel_widths = c(1,1))

girafe(ggobj = plot_grid(title, row.1, ncol = 1, rel_heights = c(.1, 1)), height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```


<br>

## 3rd highest unlinked category for each district

<br>

```{r rank 3 unlinked components district map}
unlinked.pct.remaining.rev.districts.rank.3 <- unlinked.pct.remaining.rev.districts %>%
  filter(unlinked.rank == 3) %>%
  mutate(unlinked.pct.total.rev.bins = cut(unlinked.pct.total.rev,
                                           breaks = c(quantile(.$unlinked.pct.total.rev, probs = seq(0,1,.2))),
                                           labels = c(paste(percent(unname(quantile(.$unlinked.pct.total.rev, 0)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .2)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .2)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .4)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .4)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .6)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .6)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, .8)), accuracy = .1)),
                                                      paste(percent(unname(quantile(.$unlinked.pct.total.rev, .8)), accuracy = .1), " to ", percent(unname(quantile(.$unlinked.pct.total.rev, 1)), accuracy = .1))),
                                           include.lowest = TRUE)) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type"))

unlinked.pct.remaining.rev.districts.rank.3.comp.map <- ggplot(unlinked.pct.remaining.rev.districts.rank.3) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = categories, data_id = `District Name`, tooltip = paste(`District Name`, "\nRank of component: ", unlinked.rank, "\nUnlinked component: ", categories, "\nRevenue from component: ", dollar(revenue.original), "\nPercent of total revenue from general education formula: ", percent(unlinked.pct.total.rev, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 9, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  labs(subtitle = "The 2nd highest unlinked components is much more mixed") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        plot.margin = margin(-150, 0,0,0),
        text = element_text(size = 18),
        legend.position = "bottom")


unlinked.pct.remaining.rev.districts.rank.3.pct.map <- ggplot(unlinked.pct.remaining.rev.districts.rank.3) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = unlinked.pct.total.rev.bins, data_id = `District Name`, tooltip = paste(`District Name`, "\nRank of component: ", unlinked.rank, "\nUnlinked component: ", categories, "\nRevenue from component: ", dollar(revenue.original), "\nPercent of total revenue from general education formula: ", percent(unlinked.pct.total.rev, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(ncol = 2)) +
  labs(subtitle = "\n") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        plot.margin = margin(-150,0,0,0),
        text = element_text(size = 18),
        legend.position = "bottom")

title <- ggdraw() +
  draw_label(
    "3rd highest unlinked component for each district",
    fontface = "bold",
    x = 0,
    hjust = 0,
    size = 24
  ) +
  theme(
    plot.margin = margin(0,0,0,0)
  )

row.1 <- plot_grid(unlinked.pct.remaining.rev.districts.rank.3.comp.map, unlinked.pct.remaining.rev.districts.rank.3.pct.map, ncol = 2, rel_widths = c(1,1))

girafe(ggobj = plot_grid(title, row.1, ncol = 1, rel_heights = c(.1, 1)), height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

# Examples

As the above sections highlight, the general education formula has many mechanisms in which districts receive funding, and because of it's nature to equalize revenue, some districts can more revenue than others per APU. This also means that the variation in reliance to different components of the general education formula cuts across rural-ness and geographic location and is determined more by property values. Let's use school districts in the Northwest region of the state as an example.

The map below provides the total revenue each district received from the general education formula per adjusted pupil unit in FY22. The shades of color represent the revenue per APU with each break representing 20% of the school districts - 20% of the districts received $7,142.98 to $7,761.14, the next 20% of districts received $7,761.15 to $8,081.35 per adjusted pupil unit, and so on.

A couple of patterns show that districts that are further up north typically receive higher revenue per APU, more than $8,500 per APU, while districts in the sourthern portion of the region receive less. In addition, districts with significant amount of lake properties or industry typically receive less as well.

<br>

```{r revenue per apu NW}
rev.apu.nw <- total.rev.all.schools %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  filter(planning.region == "Northwest") %>%
  filter(group ==1) %>%
  filter(`District Name` != "Pine Point Public School District") %>%
  mutate(bins = cut(total.rev.original.apu,
                    breaks = c(quantile(total.rev.original.apu, probs = seq(0,1, by = .2))),
                    labels = c(paste(dollar(unname(quantile(total.rev.original.apu, 0))), " to ", dollar(unname(quantile(total.rev.original.apu, .2)))),
                               paste(dollar(unname(quantile(total.rev.original.apu, .2))), " to ", dollar(unname(quantile(total.rev.original.apu, .4)))),
                               paste(dollar(unname(quantile(total.rev.original.apu, .4))), " to ", dollar(unname(quantile(total.rev.original.apu, .6)))),
                               paste(dollar(unname(quantile(total.rev.original.apu, .6))), " to ", dollar(unname(quantile(total.rev.original.apu, .8)))),
                               paste(dollar(unname(quantile(total.rev.original.apu, .8))), " to ", dollar(unname(quantile(total.rev.original.apu, 1))))),
                    include.lowest = TRUE)) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type"))


rev.apu.nw.map <- ggplot(rev.apu.nw) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = bins, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue from general education formula per apu: ", dollar(total.rev.original.apu), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(reverse = TRUE)) +
  labs(title = "Total revenue from general education formula per APU") +
  theme(legend.box.margin = margin(0, 0, 0, -0),
        text = element_text(size = 18))

girafe(ggobj = rev.apu.nw.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```


<br>

Let's compare the composition of the general education revenue for the following districts;

* Grygla Public School District (highest revenue per APU from general education formula, $12,978.90)
* Pequot Lakes Public Schools (lowest revenue per APU from general education formula, $7,142.98)
* Moorhead Public School District (an entirely urban school, $7,784.95)
* Ada-Borup Public School District (an entirely rural school, $8,474.33).

These districts represent a variety of school types - a mix of rural-ness as well as a variety of property types within their districts.


<br>

```{r component comparison in NW map}
comparisons <- basic.ed.linked.pct.total %>%
  filter(`District Name` %in% c("Pequot Lakes Public Schools", "Moorhead Area Public School District", "Grygla Public School District", "Ada-Borup-West Public Schools")) %>%
  left_join(var.codes, by = c("categories" = "Code")) %>%
  select(`District Name`, Category, revenue.original, linked.comp, awadm22) %>%
  group_by(`District Name`) %>%
  mutate(total.rev = sum(revenue.original)) %>%
  ungroup() %>%
  mutate(cat.rev.apu = revenue.original / awadm22,
         total.rev.apu = total.rev / awadm22,
         pct = cat.rev.apu / total.rev.apu) %>%
  select(`District Name`, Category, linked.comp, cat.rev.apu, total.rev.apu, pct) %>%
  group_by(`District Name`) %>%
  arrange(pct) %>%
  ungroup() %>%
  left_join(school_districts[,c(5, 12)], by = c("District Name" = "PREFNAME")) %>%
  mutate(data_id = as.character(seq(n())))

comparison.map <- ggplot(rev.apu.nw) +
  geom_sf_interactive(color = "grey85", fill = "grey85", aes(geometry = geometry, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue from general education formula per apu: ", dollar(total.rev.original.apu), sep = ""))) +
  geom_sf_interactive(data = comparisons, aes(fill = `District Name`, geometry = geometry, data_id = `District Name`, tooltip = paste(`District Name`, sep = ""))) +
  scale_fill_manual(values = brewer.pal(n = 4, "RdYlBu")) +
  theme_sf +
  labs(title = "Comparing 4 school districts in NW Minnesota", y = "", x = "") +
  theme(legend.box.margin = margin(0, 0, 0, 0),
        text = element_text(size = 18))

girafe(ggobj = comparison.map, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>

The chart below provides each components share of the general education revenue formula for each district. They highlight some of the differences across the region and how property values and rural-ness can impact the composition of the various components within the general education formula. Each color represents the difference component of the general education. The various shades of blue are the components that are linked to the basic education component (darkest blue). The squares with no color represent the gap in revenue per adjusted pupil unit between Grygla Public School District (highest revenue per adjusted pupil unit) and the other districts.

The general education revenue composition for the Grygla Public School District shows a broad range of components. The largest components are linked to the basic education revenue component - sparsity and transportation sparsity. They also receive a significant amount from the small schools component and a bit for local optional aid, operating capital aid, and pensions adjustment.

In Ada-Borup-West, the composition of components is a bit thing. They receive a bit more from the compensatory revenue stream as well as transportation sparsity in the components that are linked to the basic education revenue. They also get some help in the form of local optional aid.

In Moorhead, the big component that provides additional support is compensatory and a bit from local optional aid.

And then Pequot Lakes essentially only receives support via the basic education component and then a small bit from compensatory, transportation sparsity, and pensions adjustment.

What this tells us is that the general education revenue formula is meant to provide a base of funding (the basic education component) for all districts, and then add additional support depending on the characteristics of the district - property values, higher transportation costs, economies of scale - all which can lead to higher costs for districts. 

<br>

```{r comparison waffle chart nw}

comparisons.total.rev.apu <- comparisons %>%
  select(`District Name`, total.rev.apu) %>%
  mutate(max.total.rev.apu = max(total.rev.apu),
         `Less total rev` =  max.total.rev.apu - total.rev.apu)  %>%
  gather(key = "Category", value = "cat.rev.apu", 4) %>%
  mutate(linked.comp = "Not linked") %>%
  select(-total.rev.apu) %>%
  group_by(`District Name`) %>%
  distinct(cat.rev.apu, .keep_all = TRUE)

comparisons.pct.highest.apu <- comparisons %>%
  mutate(max.total.rev.apu = max(total.rev.apu)) %>%
  select(`District Name`, Category, linked.comp, cat.rev.apu, max.total.rev.apu) %>%
  rbind(comparisons.total.rev.apu) %>%
  mutate(cat.pct.highest.rev.apu = cat.rev.apu / max.total.rev.apu,
         Category = as.factor(Category),
         Category = fct_relevel(Category, "Basic education", "Compensatory", "Sparsity", "Transportation sparsity", "Declining enrollment", "Local optional aid", "Operating capital aid", "Small schools", "Gifted and talented", "English learners", "Equity aid", "Extended time", "Pensions adjustment", "Transition aid", "Less total rev"),
         `District Name` = fct_relevel(`District Name`, "Grygla Public School District", "Ada-Borup-West Public Schools", "Moorhead Area Public School District", "Pequot Lakes Public Schools")) %>%
  setorder(Category)

plot <- ggplot(comparisons.pct.highest.apu, aes(fill = Category, values = cat.rev.apu/100)) +
  facet_wrap(~`District Name`, ncol = 2) +
  geom_waffle(flip = TRUE, size = .33, n_rows = 10, color = "grey85", make_proportional = TRUE) +
  coord_equal() +
  theme_sf + 
  labs(title = "Composition of general education revenue formula", subtitle = "Each box represents a $130 per adjusted pupil unit") +
  scale_fill_manual(values = c("#053061", "#2166ac", "#4393c3", "#92c5de", "#b3de69", "#ffffb3", "#bebada", "#fb8072", "#fdb462", "transparent"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(size = 18))

girafe(ggobj = plot, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

Besides rural-ness and geography, the type of school (public vs. charter) can also play a role in differences in funding from the general education revenue formula.

First, it's important to know where charter schools are located. And a huge majority of them are in the seven county metro.

In the seven-county metro, there are 129 charter schools which is 73% of the total schools in those counties. For comparison, there are 55 charter schools outside of the seven county metro and they make up 16% of the total schools in greater Minnesota.

<br>

```{r charter school location}
charter.pr <- scenarios.5yr.districts %>%
  left_join(district.join[,c(1,2,3,4)], by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  drop_na(planning.region) %>%
  filter(group %in% c(1,4)) %>%
  group_by(planning.region, group) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(planning.region) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  mutate(data_id = as.character(seq(n())))

charter.pr.plot <- ggplot(charter.pr, aes(planning.region, n, fill = Definition, group = Definition)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(planning.region, "\nType of school: ", Definition, "\nNumber of schools: ", comma(n), "\nPercent of total schools: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = comma(n)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent share of total schools in planning regions") +
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = charter.pr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

What's interesting is that the revenue per adjusted pupil units are very different between charter schools and public schools in the seven county metro. The chart below are boxplots that provide the 25% and 75% range of total revenue per adjusted pupil unit for schools, along with the median (black line within the box), and the outliers (black dots).

The boxplots for charter schools and public schools outside of the seven county metro are very similar. Most school districts range from $7,500 to $10,000 per adjusted pupil unit with medians around $8,100. However, the ranges are very different in the seven county metro. The range of total revenue per adjusted pupil unit for charter schools in the seven county metro range from jus below $8,000 to just over $10,000 per adjusted pupil unit while the range for public schools is significantly lower - well below $8,000.  The medians are also exceptionally different - $9,100 for charter schools vs. $7,300 for public schools.

<br>

```{r charter revenue per apu}
total.rev.apu.group <- total.rev.all.schools %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  mutate(metro.not = ifelse(planning.region == "Seven County Mpls-St Paul", "Seven County Metro", "Greater MN")) %>%
  drop_na(metro.not)

total.rev.apu.group.plot <- ggplot(total.rev.apu.group, aes(metro.not, total.rev.original.apu, fill = Definition)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge",
                           aes(data_id = group,
                               tooltip = after_stat({
                                 paste("Q1: ", prettyNum(.data$ymin),
                                       "\nMedian: ", prettyNum(.data$middle),
                                       "\nQ3: ", prettyNum(.data$ymax))
                               }))) +
  labs(x="", y = "", color="", title = "Total revenue per APU")+
  scale_y_continuous(labels=scales::dollar) +
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu")) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.apu.group.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))



```

<br>

So what's going on here? Again, the composition of the school districts general education formula tell the story. Let's compare four districts in the metro to get a sense of formula revenue composition.

1. Sejong Academy of Minnesota: This is a K-10 Korean Immersion Charter school with 186 adjusted pupil units located in St. Paul, MN. It received the highest general education revenue per adjusted pupil unit in the seven county metro - $13,499.46.

2. St. Croix Preparatory Academy: This is a K-12 charter school with 1,278 adjusted pupil units located in Stillwater, MN. It received the lowest general education revenue per adjusted pupil unit of charter schools in the seven county metro - $7,067.96.

3. Brooklyn Center School District: This is a K-12 public school with 2,549 adjusted pupil units located in Brooklyn Center. It received the highest general education revenue per adjusted pupil unit of public schools in the seven county metro - $9,529.78

4. Minnetonka Public School District - This is a K-12 public school with 12,178 adjusted pupil units located in Minnetonka. It receive the lowest general education revenue per adjusted pupil unit of all schools in Minnesota - $6,948.97.

These four districts represent the highest and lowest revenues for public schools and charter schools in the seven county metro and will provide an appropriate reflection of the variation in general education revenue formula composition.

Below are waffle charts that provide a representation of the component composition. Each block represents $135 in revenue per adjusted pupil unit and the colors represent the component from which the revenue originates.

Starting with Sejong Academy of Minnesota, we can see that the compensatory component makes up a large chunk of the additional revenue that district receives. In addition, declining enrollment played a role that year as well. Outside of the linked components, their revenue also comes from unlinked components such as english learners and small schools revenue playing a role.

The other charter school, St. Croix Preparatory Academy, only receives additional operating capital aid. Otherwise, it is only provided basic education revenue.

Of the public school districts, Brooklyn Center receives funding from the broadest number of components of the general education formula. Compensatory is a major proportion of their revenue. The unlinked components that add additional support to the district are local optional aid, and extended time revenue. Minnetonka, on the other hand, only receives a bit of operating capital aid on top of the basic education revenue component.


<br>

```{r waffle chart metro charter vs public}
less.total.rev.comparisons.charter.public <- master.original %>%
  filter(`District Name` %in% c("Sejong Academy of Minnesota", "St. Croix Preparatory Academy", "Brooklyn Center School District", "Minnetonka Public School District")) %>%
  group_by(`District Name`, number, type) %>%
  summarize(total.rev.original = sum(revenue.original, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  mutate(total.rev.original.apu = total.rev.original / awadm22,
         max.total.rev.original.apu = max(total.rev.original.apu),
         `Less total rev` = max.total.rev.original.apu - total.rev.original.apu) %>%
  select(`District Name`, Definition, `Less total rev`) %>%
  gather(key = "Category", value = "revenue.original.apu", 3)

total.rev.comparisons.charter.public <- master.original %>%
  filter(`District Name` %in% c("Sejong Academy of Minnesota", "St. Croix Preparatory Academy", "Brooklyn Center School District", "Minnetonka Public School District")) %>%
  group_by(`District Name`, number, type) %>%
  summarize(total.rev.original = sum(revenue.original, na.rm = TRUE)) %>%
  ungroup() %>%
  select(`District Name`, total.rev.original)
  
comparisons.charter.public <- scenarios.5yr.districts %>%
  filter(`District Name` %in% c("Sejong Academy of Minnesota", "St. Croix Preparatory Academy", "Brooklyn Center School District", "Minnetonka Public School District")) %>%
  left_join(var.codes, by = c("categories" = "Code")) %>%
  select(`District Name`, Definition, Category, revenue.original.apu) %>%
  rbind(less.total.rev.comparisons.charter.public) %>%
  left_join(total.rev.comparisons.charter.public, by = "District Name") %>%
  mutate(Category = as.factor(Category),
         Category = fct_relevel(Category, "Basic education", "Compensatory", "Sparsity", "Transportation sparsity", "Declining enrollment", "Local optional aid", "Operating capital aid", "Small schools", "Gifted and talented", "English learners", "Equity aid", "Extended time", "Pensions adjustment", "Transition aid", "Less total rev"),
         `District Name` = fct_relevel(`District Name`, "Sejong Academy of Minnesota", "St. Croix Preparatory Academy", "Brooklyn Center School District", "Minnetonka Public School District")) %>%
    setorder(Category)


plot <- ggplot(comparisons.charter.public, aes(fill = Category, values = revenue.original.apu/100)) +
  facet_wrap(~`District Name`, ncol = 2) +
  geom_waffle(flip = TRUE, size = .33, n_rows = 10, color = "grey85", make_proportional = TRUE) +
  coord_equal() +
  theme_sf + 
  labs(title = "Composition of general education revenue formula", subtitle = "Each box represents a $135 per adjusted pupil unit") +
  scale_fill_manual(values = c("#053061", "#2166ac", "#4393c3", "#92c5de", "#b3de69", "#ffffb3", "#bebada", "#fb8072", "#fdb462", "#33a02c", "transparent"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(size = 18))

girafe(ggobj = plot, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))



```

<br>

Reviewing the composition of funding components that districts receive, one thing becomes abundantly clear - the basic education revenue and it's linked components make up a large majority of the funding support that schools receive. The basic education revenue component provides a baseline funding for all schools depending on their adjusted pupil units whereas the other 4 components support districts depending on the economic composition of their student body, the added expenses of being small but serving a large geographic area, and lessening the blow from declining enrollment. 

The unlinked components serve as smaller additional support systems to help acknowledge the unique challenges that some schools face -  local optional aid acknowledges that differences in a districts ability to raise revenue from local property taxes, small schools revenue acknowledges the challenges in finding economies of scale, and english learners revenue acknowledges the additional resources needed to teach students whose english isn't their first language.

<br>

# Changes in revenue after increases to basic education component

The big question is whether continued increases to only basic education (which also increases 4 other components) will throw the entire general education formula "out-of-whack". The design of the general education revenue formula means that no matter what, some districts will receive more funds per APU than others. It's the nature of having a formula that attempts to "equalize" resources across the state. 

A 4% increase to the basic education component followed by 4 years of 3% inflationary increases means the basic education allowance would go from $6,728 per APU to $7,875.32 which is a 17% increase.

Let's compare the percent change in revenue from the general education formula before and after the increases to the basic education component. The map below provides the increase for each school district. It shows that there is variation in increases in total revenue with a large majority of districts receiving between 15% and 16% increase, a few schools (largely in high property value districts) receive between 16% and 17% increases, and a few other categories that receive less than 15%.  

<br>

```{r pct change district map}
pct.change.total.rev.all.schools <- scenarios.5yr.districts %>%
  group_by(`District Name`, number, type) %>%
  summarize(total.rev.original.apu = sum(revenue.original.apu, na.rm = TRUE),
            total.rev.projection.apu = sum(revenue.bsrevonly.apu, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(total.rev.original.apu > 0,
         total.rev.original.apu != "Inf") %>%
  mutate(pct.change.total.rev.apu = (total.rev.projection.apu - total.rev.original.apu) / total.rev.original.apu) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type")) %>%
  left_join(group.codes, by = c("group" = "Code"))

pct.change.total.rev.all.schools.map <- ggplot(pct.change.total.rev.all.schools) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = pct.change.total.rev.apu, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal rev - original: ", dollar(total.rev.original.apu), "\nTotal rev - after increases: ", dollar(total.rev.projection.apu), "\nPercent change in total rev: ", percent(pct.change.total.rev.apu, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "PuBu", direction = 1, labels = scales::percent) +
  labs(title = "Percent change in total rev after increases to basic education") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.all.schools.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))


```



<br>

If we compare public school districts with the charter schools we begin to see a pattern in the variation. Again, we can see that nearly all of the public schools receive a total revenue increase of between 14.5% and 16.5% with some sigificant outliers receive less than 14.5%. The median is 15.9%. 

For charter schools we see that nearly all schools receive a percentage increases a bit lower - from 14.5% to just over 16%. The 25th and 75th percentiles fall between 14.5% and 16.3%. The median is 15.4%. There are just a few outliers receiving less than 14.5%. Overall, these aren't huge differences. Nearly all schools are receiving a similar percentage increase.

<br>

```{r pct change total rev group}
pct.change.total.rev.group.plot <- ggplot(pct.change.total.rev.all.schools, aes(Definition, pct.change.total.rev.apu, fill = Definition, group = Definition)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge",
                           aes(data_id = group,
                               tooltip = after_stat({
                                 paste("Q1: ", prettyNum(.data$ymin),
                                       "\nMedian: ", prettyNum(.data$middle),
                                       "\nQ3: ", prettyNum(.data$ymax))
                               }),
                               outlier.tooltip = paste(`District Name`, sep = ""))) +
  labs(x="", y = "", color="", title = "Percent change after increases to basic education")+
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu")) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.group.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))   
```

<br>

Let's also take a look at the revenue change per APU. The map below provides the dollar change per APU for school districts after increases to the basic education revenue component. It's interesting that the previous map showed the largest percentage increases in the districts with the lowest increase in revenue per APU in this map. Districts in the suburbs and in lakes regions experience the smallest increases in revenue per APU. Some of the largest increases are in our mort rural areas of Minnesota (northern and western).

<br>

```{r revenue change per APU map}
rev.change.apu.all.schools <- total.rev.all.schools %>%
  mutate(change.apu = total.rev.bsrevonly.apu - total.rev.original.apu) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type")) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  left_join(group.codes, by = c("group" = "Code"))

rev.change.apu.all.schools.map <- ggplot(data = filter(rev.change.apu.all.schools, group == 1)) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = change.apu, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal rev per apu - original", dollar(total.rev.original.apu), "\nTotal rev per APU - after increases: ", dollar(total.rev.bsrevonly.apu), "\nChange in total rev per APU: ", dollar(change.apu), sep = ""))) +
  theme_sf+
  scale_fill_stepsn(colours = brewer.pal(n = 5, "PuBu"),
                    labels = scales::dollar) +
  labs(title = "Change in revenue per APU after increases") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = rev.change.apu.all.schools.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))


```

<br>

So what does this mean for for charter schools? The boxplot below provides the distribution of the revenue change per APU after increases to the basic education revenue component. Public schools have a pretrty narrow band of change with the 25th percentile being $1,148 per APU increase and a 75th percentile per APU increase of $1,481. The median is $1,251.

The charter schools, on the other hand, experience a wide range of increases per APU. The 25th percentile begins at $1,147 and the 75th percentile begins at $2,039. The median for charter schools is $1,303.

<br>

```{r dollar change per APU groups}
rev.change.apu.groups.plot <- ggplot(rev.change.apu.all.schools, aes(Definition, change.apu, fill = Definition, group = Definition)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge",
                           aes(data_id = group,
                               tooltip = after_stat({
                                 paste("Q1: ", prettyNum(.data$ymin),
                                       "\nMedian: ", prettyNum(.data$middle),
                                       "\nQ3: ", prettyNum(.data$ymax))
                               }),
                               outlier.tooltip = paste(`District Name`, sep = ""))) +
  labs(x="", y = "", color="", title = "Revenue change per APU after increases to basic education")+
  scale_y_continuous(labels=scales::dollar) +
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu")) +
  theme_line+
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = rev.change.apu.groups.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE)) 


```

<br>

# Why is there variation?

The variation in the percent change in total revenue across schools as well as the opposite pattern in the schools that receive the highest revenue per APU increase forces us to ask a few questions.

First, which types of formula component composition make it so that some districts get a higher percent change in their total revenue than other districts? And relatedly, why do some districts get higher dollar change per APU than others?

Secondly, does this variation significantly impact the total revenue per APU such that districts are leapfrogging over each other if we were to rank all districts from highest revenue per APU to lowest revenue per APU? Remember, this is important because the general education formula is designed to provide more funding per APU to some districts over others because it attempts to equalize funding as well as acknowledge that there are higher costs associated to district location and student composition. If districts are "leapfrogging" each other, than increasing funding to education by only increasing the basic education component is "throwing it out whack".

The table below provides the total revenue per APU from the general education formula for 5 different districts in Northwest Minnesota.

* Pequot Lakes Public Schools,
* Moorhead Area Public School District,
* Grygla Public School District,
* Ada-Borup-West Public Schools, and
* Greenbush-Middle River School Dist.

The first four are the examples we used previously and represent a wide range of rural-ness and property values. Greenbush-Middle River School District was added since it had the lowest percentage increase in the state after increasing the basic education revenue component.

The table shows how nuanced this all is - the district receiving the largest percent increase was Pequot Lakes School District with a 16.8%. However, in total dollars it received the lowest increase with a nearly $1,200 per APU increase. 

The highest total dollar increase was Grygla Public School District which received a nearly $2,000 per APU increase, but received the second lowest percent increase with 14.8%.

The lowest percentage increase was Greenbush-Middle River school district with 11% but received a modest $1,300 per APU increase.


<br>

```{r pct change examples nw}
pct.change.total.rev.nw.examples <- total.rev.all.schools %>%
  filter(`District Name` %in% c("Pequot Lakes Public Schools", "Moorhead Area Public School District", "Grygla Public School District", "Ada-Borup-West Public Schools", "Greenbush-Middle River School Dist.")) %>%
  mutate(total.rev.change.apu = total.rev.bsrevonly.apu - total.rev.original.apu,
         pct.change.total.rev.apu = (total.rev.bsrevonly.apu - total.rev.original.apu) / total.rev.original.apu) %>%
  arrange(desc(pct.change.total.rev.apu)) %>%
  select(`District Name`, total.rev.original.apu, total.rev.bsrevonly.apu, total.rev.change.apu, pct.change.total.rev.apu) %>%
  rename(`Total rev per APU - original` = total.rev.original.apu,
         `Total rev per APU - after increase` = total.rev.bsrevonly.apu,
         `Change in revenue per APU` = total.rev.change.apu,
         `Percent change in revenue` = pct.change.total.rev.apu)

datatable(pct.change.total.rev.nw.examples, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)))) %>%
  formatCurrency(2:4, "$") %>%
  formatPercentage(5, digits = 1)
  
```

<br>

So what in the world is going on? Well, it's all about the composition of the components each district receives from the general education formula.

The percentage change of the total revenue is linked to how much of a districts revenue is linked to the basic education component. The chart below provides the percent change each of the districts receive after increases to the basic education (light green) with the percentage of their total revenue from the general education formula comes from components linked to the basic education component. The chart clearly shows that the districts that received the highest percentage increases also had a significantly large proportion of the revenue linked to the basic education component. 

For example, Pequot Lakes received the highest percentage increase of this group and also had nearly 99% of their revenue come from components that are linked to the basic education component. Whereas Greenbush-Middle River had the lowest percentage increase to their total revenue from the general education formula and only had 65% of that revenue come from components linked to the basic education component.

<br>


```{r component change nw examples}
pct.change.components.nw.examples <- scenarios.5yr.districts %>%
  filter(`District Name` %in% c("Pequot Lakes Public Schools", "Moorhead Area Public School District", "Grygla Public School District", "Ada-Borup-West Public Schools", "Greenbush-Middle River School Dist.")) %>%
  mutate(pct.change.comp = (revenue.bsrevonly.apu - revenue.original.apu) / revenue.original.apu) %>%
  mutate(revenue.change.comp = revenue.bsrevonly.apu - revenue.original.apu,
         change.yes.no = ifelse(revenue.change.comp > 0, "Linked to basic education", "Not linked to basic education"))

prop.rev.change.nw.examples <- pct.change.components.nw.examples %>%
  group_by(`District Name`, number, type, change.yes.no) %>%
  summarize(revenue.original.apu = sum(revenue.original.apu),
            revenue.bsrevonly.apu = sum(revenue.bsrevonly.apu)) %>%
  ungroup() %>%
  group_by(`District Name`) %>%
  mutate(total.rev.original.apu = sum(revenue.original.apu),
         total.rev.bsrevonly.apu = sum(revenue.bsrevonly.apu),
         pct.change.total.rev.apu = (total.rev.bsrevonly.apu - total.rev.original.apu) / total.rev.original.apu,
         pct = revenue.original.apu / sum(revenue.original.apu)) %>%
  ungroup() %>%
  arrange(desc(pct)) %>%
  mutate(`District Name` = as.factor(`District Name`),
         `District Name` = fct_reorder(`District Name`, -pct),
         pct.of.pct = pct.change.total.rev.apu * pct) %>%
  filter(change.yes.no == "Linked to basic education")

prop.rev.change.nw.examples.plot <- ggplot() +
  geom_col_interactive(data = prop.rev.change.nw.examples, aes(x = reorder(`District Name`, pct.change.total.rev.apu), y = pct.change.total.rev.apu, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - original: ", dollar(total.rev.original.apu), "\nTotal revenue per APU - after increases: ", dollar(total.rev.bsrevonly.apu), "\nPercent change in revenue after increases: ", percent(pct.change.total.rev.apu, accuracy = .1), "\nPercent that components linked to basic education comprise of total revenue: ", percent(pct, accuracy = .1), sep = "")), fill = "#bae4b3") +
  geom_col_interactive(data = prop.rev.change.nw.examples, width = .5, aes(x = reorder(`District Name`, pct.change.total.rev.apu), y = pct.of.pct, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - original: ", dollar(total.rev.original.apu), "\nTotal revenue per APU - after increases: ", dollar(total.rev.bsrevonly.apu), "\nPercent change in revenue after increases: ", percent(pct.change.total.rev.apu, accuracy = .1), "\nPercent that components linked to basic education comprise of total revenue: ", percent(pct, accuracy = .1), sep = "")), fill = "#006d2c", show.legend = FALSE) +
  geom_label(data = prop.rev.change.nw.examples, aes(x = reorder(`District Name`, pct.change.total.rev.apu), y = pct.change.total.rev.apu, label = paste("Change in total revenue\n", percent(pct.change.total.rev.apu, accuracy = .1))), show.legend = FALSE, fill = "#bae4b3", nudge_y = .02) +
  labs(x="", y = "", color="", title = "Percent of revenue from components linked to basic education")+
  geom_label(data = prop.rev.change.nw.examples, aes(x = reorder(`District Name`, pct.change.total.rev.apu), y = pct.of.pct / 2, label = paste("Linked components are\n", percent(pct, accuracy = .1), " of total revenue", sep = "")), fill = "transparent") +
  scale_y_continuous(labels=scales::percent)+
  expand_limits(y = c(0, .22)) +
  coord_flip() +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = prop.rev.change.nw.examples.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```


<br>

Although Grygla received the second lowest percentage increase to their total revenue from the general education formula, it had, by far, the largest dollar per APU increase to their revenue.

The chart below provides the proportion of revenue received at a school district by component. In order to compare with Grygla which has the highest revenue per APU, some of the boxes are empty, meaning that is the gap between the district and Grygla's total revenue per APU after increasing the basic education revenue component. 

The chart shows that Grygla receives the highest revenue per APU after the increases to the basic education component. This due to the highest amount of revenue the district receives that's linked to the basic education component. Although everyone gets the same increase to the basic education allowance, Grygla also receives a substantial amount from sparsity and transportation sparsity which are linked to the increases in the basic education component. So quite a large proportion of Grygla's revenue received an increase. The only reason it doesn't have a higher percentage change is because it also receives funding from the non-linked components such as local optional aid, small schools, and operating capital aid. 

On the other hand, districts such as Moorhead and Pequot Lakes have less components linked to the basic education component, therefore there is less revenue to increase. Moorhead receives a little bit more in compensatory but doesn't receive the sparsity revenue that Grygla receives. Pequot Lakes gets nearly all of it's revenue from the basic education component with just a bit more from compensatory and transportation sparsity.

<br>

```{r component change and composition nw examples}
wtf.max <- total.rev.all.schools %>%
  filter(`District Name` %in% c("Pequot Lakes Public Schools", "Moorhead Area Public School District", "Grygla Public School District", "Ada-Borup-West Public Schools", "Greenbush-Middle River School Dist.")) %>%
  mutate(max.total.rev = max(total.rev.bsrevonly.apu),
         `Less total rev` = max.total.rev - total.rev.bsrevonly.apu) %>%
  select(`District Name`, `Less total rev`) %>%
  gather(key = "Category", value = "revenue.bsrevonly.apu", 2) %>%
  mutate(change.yes.no = "Not linked to basic education")

wtf <- pct.change.components.nw.examples %>%
  left_join(var.codes, by = c("categories" = "Code")) %>%
  select(`District Name`, Category, revenue.bsrevonly.apu, change.yes.no) %>%
  rbind(wtf.max) %>%
  group_by(`District Name`) %>%
  mutate(total.rev.bsrevonly = sum(revenue.bsrevonly.apu[Category != "Less total rev"])) %>%
  ungroup() %>%
  mutate(Category = fct_relevel(Category, "Basic education", "Compensatory", "Sparsity", "Transportation sparsity", "Declining enrollment", "Local optional aid", "Operating capital aid", "Small schools", "Gifted and talented", "English learners", "Equity aid", "Extended time", "Pensions adjustment", "Transition aid"),
         `District Name` = fct_relevel(`District Name`, "Grygla Public School District", "Greenbush-Middle River School Dist.", "Ada-Borup-West Public Schools", "Moorhead Area Public School District", "Pequot Lakes Public Schools")) %>%
    setorder(Category)

plot <- ggplot(wtf, aes(fill = Category, values = revenue.bsrevonly.apu/100)) +
  facet_wrap(~`District Name`, ncol = 2) +
  geom_waffle(flip = TRUE, size = .33, n_rows = 10,  make_proportional = TRUE, aes(color = change.yes.no)) +
  coord_equal() +
  theme_sf + 
  scale_fill_manual(values = c("#084594", "#4292c6", "#6baed6", "#c6dbef", "#eff3ff", "#f6e8c3", "#dfc27d", "#bf812d", "#8c510a", "#543005", "transparent")) +
  labs(title = "Composition of total revenue change", subtitle = "Each box represents a $135 per adjusted pupil unit") +
  scale_color_manual(values = c("#276419", "grey85")) +
  theme(legend.position = "bottom",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        text = element_text(size = 18),
        strip.text = element_text(size = 10))

girafe(ggobj = plot, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```



