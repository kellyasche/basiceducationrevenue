---
title: "Analysis - long term impacts"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
library(ggpattern)
library(EnvStats)

```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r shapefiles}
school_districts <- read_sf("Data/Shapefiles/New school shapefiles/School_district_boundaries.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(type = SDTYPE,
         number = SDNUMBER) %>%
  mutate(number = as.numeric(number),
         type = as.numeric(type))


```


```{r master orignal}
original <- read_csv("Data/Formula/Master.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         eqgroup.label = ifelse(is.na(eqgroup.label), "", eqgroup.label)) %>%
  filter(group %in% c(1,4))

group.codes <- read_xlsx("Data/Formula/group codes.xlsx")

var.codes <- read_xlsx("Data/Formula/primary variable codes.xlsx")

categories <- c("bsrev", "exdayr", "gtrev", "smlrev", "decrev", "locaid", "afdc22", "totlep", "totspar", "cexaid", "tsparrev", "eqaid", "hhaid", "penrev")

master.original <- original %>%
  select(`District Name`, number, type, categories) %>%
  gather(key = "categories", value = "revenue.original", 4:17) 

```


```{r district join}
district.join <- original %>%
  select(`District Name`, number, type, group, `County Name`, countyfp, Dem_Desc, planning.region, edr, awadm22) %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```

```{r master 5yr scenarios}
master.5yr.scenarios.districts <- read_csv("Data/Formula/Master-5yr-scenarios-district.csv")

scenarios.5yr.districts <-  master.5yr.scenarios.districts %>%
  gather(key = "year", value = "revenue", 5:16) %>%
  mutate(scenario = ifelse(str_detect(year, "bsrevonly"), "Basic education only", "Entire formula"),
         year = str_sub(year, -3, -3),
         year = as.numeric(year)) %>%
  left_join(district.join, by = c("District Name", "number", "type")) 

```





```{r district prop}
prop.group <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(group) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n)) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  select(Definition, total.dataset.n, total.dataset.pct.n)

prop.ruca <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(Dem_Desc) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.prop = total.dataset.n / sum(total.dataset.n)) 

prop.pr <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(planning.region) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n))

prop.edr <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(edr) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n))

```

<br>

# Analysis - revenue per APU

Let's take a look at the total revenue per apu for the original revenue, the revenue after increasing the basic education component by 4%, and the revenue after increasing the entire formula by 4%. 

The maps below provide the total revenue per APU for each scenario and the shades of color are "binned" by quintile - meaning each bin has 20% of the total public school districts, which is between 65 and 66 districts per bin.

The first thing that jumps out from the maps below is that our most rural districts, particularly along the borders of the state, receive the highest revenue per APU, no matter which scenario.

What we are looking for if there are any shifts/patterns in districts that receive the highest revenue per APU over the course of five years for each scenario. Glancing at these maps shows that there is very little change. 

<br>


```{r prep total revenue per APU}
total.rev.districts <- scenarios.5yr.districts %>%
  filter(group == 1) %>%
  group_by(`District Name`, number, type, group, year, scenario) %>%
  summarize(total.rev = sum(revenue, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(district.join[,c(1,2,3,4,10)], by = c("District Name", "number", "type", "group")) %>%
  mutate(total.rev.apu = total.rev / awadm22) %>%
  filter(year %in% c(0,5)) %>%
  mutate(scenario = ifelse(year == 0, "Original", scenario)) %>%
  distinct(number, type, group, year, scenario, total.rev, awadm22, total.rev.apu, .keep_all = TRUE) %>%
  select(-year, -awadm22, -total.rev) %>%
  drop_na(total.rev.apu) %>%
  filter(!is.infinite(total.rev.apu)) %>%
  spread(scenario, total.rev.apu) %>%
  mutate(original.quant = cut(Original,
                              breaks = c(unname(quantile(.$Original, 0)),
                                         unname(quantile(.$Original, .2)),
                                         unname(quantile(.$Original, .4)),
                                         unname(quantile(.$Original, .6)),
                                         unname(quantile(.$Original, .8)),
                                         unname(quantile(.$Original, 1))),
                              labels = c(paste(dollar(unname(quantile(.$Original, 0))), " to ", dollar(unname(quantile(.$Original,  .2))), sep = ""),
                                         paste(dollar(unname(quantile(.$Original,  .2))), " to ", dollar(unname(quantile(.$Original,  .4))), sep = ""),
                                         paste(dollar(unname(quantile(.$Original,  .4))), " to ", dollar(unname(quantile(.$Original,  .6))), sep = ""),
                                         paste(dollar(unname(quantile(.$Original,  .6))), " to ", dollar(unname(quantile(.$Original,  .8))), sep = ""),
                                         paste(dollar(unname(quantile(.$Original,  .8))), " to ", dollar(unname(quantile(.$Original,  1))), sep = "")),
                              include.lowest = TRUE),
         basic.ed.quant = cut(`Basic education only`,
                              breaks = c(unname(quantile(.$`Basic education only`, 0)),
                                         unname(quantile(.$`Basic education only`, .2)),
                                         unname(quantile(.$`Basic education only`, .4)),
                                         unname(quantile(.$`Basic education only`, .6)),
                                         unname(quantile(.$`Basic education only`, .8)),
                                         unname(quantile(.$`Basic education only`, 1))),
                              labels = c(paste(dollar(unname(quantile(.$`Basic education only`, 0))), " to ", dollar(unname(quantile(.$`Basic education only`,  .2))), sep = ""),
                                         paste(dollar(unname(quantile(.$`Basic education only`,  .2))), " to ", dollar(unname(quantile(.$`Basic education only`,  .4))), sep = ""),
                                         paste(dollar(unname(quantile(.$`Basic education only`,  .4))), " to ", dollar(unname(quantile(.$`Basic education only`,  .6))), sep = ""),
                                         paste(dollar(unname(quantile(.$`Basic education only`,  .6))), " to ", dollar(unname(quantile(.$`Basic education only`,  .8))), sep = ""),
                                         paste(dollar(unname(quantile(.$`Basic education only`,  .8))), " to ", dollar(unname(quantile(.$`Basic education only`,  1))), sep = "")),
                              include.lowest = TRUE),
         entire.formula.quant = cut(`Entire formula`,
                              breaks = c(unname(quantile(.$`Entire formula`, 0)),
                                         unname(quantile(.$`Entire formula`, .2)),
                                         unname(quantile(.$`Entire formula`, .4)),
                                         unname(quantile(.$`Entire formula`, .6)),
                                         unname(quantile(.$`Entire formula`, .8)),
                                         unname(quantile(.$`Entire formula`, 1))),
                              labels = c(paste(dollar(unname(quantile(.$`Entire formula`, 0))), " to ", dollar(unname(quantile(.$`Entire formula`,  .2))), sep = ""),
                                         paste(dollar(unname(quantile(.$`Entire formula`,  .2))), " to ", dollar(unname(quantile(.$`Entire formula`,  .4))), sep = ""),
                                         paste(dollar(unname(quantile(.$`Entire formula`,  .4))), " to ", dollar(unname(quantile(.$`Entire formula`,  .6))), sep = ""),
                                         paste(dollar(unname(quantile(.$`Entire formula`,  .6))), " to ", dollar(unname(quantile(.$`Entire formula`,  .8))), sep = ""),
                                         paste(dollar(unname(quantile(.$`Entire formula`,  .8))), " to ", dollar(unname(quantile(.$`Entire formula`,  1))), sep = "")),
                              include.lowest = TRUE),
         original.quant.rank = ifelse(Original < quantile(.$Original, .2), 1,
                                      ifelse(Original < quantile(.$Original, .4) & Original >= quantile(.$Original, .2), 2,
                                             ifelse(Original < quantile(.$Original, .6) & Original >= quantile(.$Original, .4), 3,
                                                    ifelse(Original < quantile(.$Original, .8) & Original >= quantile(.$Original, .6), 4, 5)))),
         original.quant.rank = ifelse(Original < quantile(.$Original, .2), 1,
                                      ifelse(Original < quantile(.$Original, .4) & Original >= quantile(.$Original, .2), 2,
                                             ifelse(Original < quantile(.$Original, .6) & Original >= quantile(.$Original, .4), 3,
                                                    ifelse(Original < quantile(.$Original, .8) & Original >= quantile(.$Original, .6), 4, 5)))),
         original.quant.rank = ifelse(Original < quantile(.$Original, .2), 1,
                                      ifelse(Original < quantile(.$Original, .4) & Original >= quantile(.$Original, .2), 2,
                                             ifelse(Original < quantile(.$Original, .6) & Original >= quantile(.$Original, .4), 3,
                                                    ifelse(Original < quantile(.$Original, .8) & Original >= quantile(.$Original, .6), 4, 5)))),
         bsrevonly.quant.rank = ifelse(`Basic education only` < quantile(.$`Basic education only`, .2), 1,
                                      ifelse(`Basic education only` < quantile(.$`Basic education only`, .4) & `Basic education only` >= quantile(.$`Basic education only`, .2), 2,
                                             ifelse(`Basic education only` < quantile(.$`Basic education only`, .6) & `Basic education only` >= quantile(.$`Basic education only`, .4), 3,
                                                    ifelse(`Basic education only` < quantile(.$`Basic education only`, .8) & `Basic education only` >= quantile(.$`Basic education only`, .6), 4, 5)))),
         entire.formula.quant.rank = ifelse(`Entire formula` < quantile(.$`Entire formula`, .2), 1,
                                      ifelse(`Entire formula` < quantile(.$`Entire formula`, .4) & `Entire formula` >= quantile(.$`Entire formula`, .2), 2,
                                             ifelse(`Entire formula` < quantile(.$`Entire formula`, .6) & `Entire formula` >= quantile(.$`Entire formula`, .4), 3,
                                                    ifelse(`Entire formula` < quantile(.$`Entire formula`, .8) & `Entire formula` >= quantile(.$`Entire formula`, .6), 4, 5)))),
         bsrevonly.change = ifelse(bsrevonly.quant.rank > original.quant.rank, "Moved up",
                                   ifelse(bsrevonly.quant.rank < original.quant.rank, "Moved down", "No change")),
         entire.formula.change = ifelse(entire.formula.quant.rank > original.quant.rank, "Moved up", 
                                        ifelse(entire.formula.quant.rank < original.quant.rank, "Moved down", "No change"))) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type")) 
  
total.rev.districts.original.map <- ggplot(total.rev.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = original.quant, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - original: ", dollar(Original), "\nPercentile among public school districts in revenue per APU: ", original.quant, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(reverse = TRUE, ncol = 1)) +
  labs(title = "Original revenue", subtitle = "Our most rural school districts receive the highest\nrevenue per APU") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18),
        legend.position = "bottom",
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12))


total.rev.districts.bsrevonly.map <- ggplot(total.rev.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = basic.ed.quant, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - increase to basic ed only: ", dollar(`Basic education only`), "\nPercentile among public school districts in revenue per APU: ", basic.ed.quant, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(reverse = TRUE, ncol = 1)) +
  labs(title = "Increase to basic ed revenue only", subtitle = "Our most rural school districts receive the highest\nrevenue per APU") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        legend.position = "bottom")

total.rev.districts.entire.formula.map <- ggplot(total.rev.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = entire.formula.quant, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - increase to entire formula: ", dollar(`Entire formula`), "\nPercentile among public school districts in revenue per APU: ", entire.formula.quant, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(reverse = TRUE, ncol = 1)) +
  scale_color_manual(values = brewer.pal(n = 6, "OrRd")) +
  labs(title = "Increase to entire formula", subtitle = "Our most rural school districts receive the highest\nrevenue per APU") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18),
        legend.position = "bottom",
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12))

title <- ggdraw() +
  draw_label(
    "Total revenue per APU by each scenario",
    fontface = "bold",
    x = 0,
    hjust = 0,
    size = 24) +
  theme(
    plot.margin = margin(100,0,0,0)
  )

plot.row.1 <- plot_grid(total.rev.districts.original.map, total.rev.districts.bsrevonly.map, ncol = 2)

plot.row.2 <- plot_grid(NULL, total.rev.districts.entire.formula.map, NULL, ncol = 3, rel_widths = c(.25,.5,.25), align = c("hv"))
  
girafe(ggobj = plot_grid(title, plot.row.1, plot.row.2, ncol = 1, rel_heights = c(0.1, 1, 1)), height_svg = 20, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```
<br>

## Relationships{.tabset}

Next, let's see if there are any patterns or relationships in these increases depending on type of school, it's RUCA category, and regions. The charts below provide each school district's total revenue per APU for each scenario, a boxplot for each scenario, as well as the relationship between type of school, RUCA category, and region to it's total revenue per APU.

* Charter vs public: The box plots indicate a consistent pattern where charter schools have a significantly higher total revenue per APU median than public schools. The t-test also indicates a relationship between the type of school and it's total revenue per APU.
* RUCA: The RUCA box plots show that entirely rural school districts have a consistently higher revenue per APU median for each scenario than all other RUCA categories. Town/rural mix schools also have consistently higher revenue per APU than the other two categories. Entirely urban as well as urban/town/rural mix schools have very similar median, but significantly different middle 50%. There is a significantly larger variation in the top half of entirely urban schools. This is likely due to the larger number of charter schools that are in the metro areas. Lastly, there are a significant number of outliers among the town/rural mix schools and urban/town/rural mix schools. 
* Planning Region: The box plot shows that our most rural planning regions of the state have the highest total revenue per APU medians (Northwest, Northeast, Southwest). Interestingly, the seven county metro also has higher medians due to there being a large number of charter schools. Central schools have the lowest.
* EDR: EDRs 1 and 2 as well as EDR 6W and 8 have some of the highest total revenue per APUs in the state. 

<br>

### Charter vs. public

<br>

```{r total rev increases relationships group}
total.rev.increases.relationship <- master.5yr.scenarios.districts %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  group_by(`District Name`, number, type, group) %>%
  summarize(total.rev.original = sum(revenue.0yr, na.rm = TRUE),
            total.rev.bsrevonly = sum(revenue.bsrevonly.5yr, na.rm = TRUE),
            total.rev.entire.formula = sum(revenue.5yr, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(district.join, by = c("District Name", "number", "type", "group")) %>%
  mutate(total.rev.original.apu = total.rev.original / awadm22,
         total.rev.bsrevonly.apu = total.rev.bsrevonly / awadm22,
         total.rev.entire.formula.apu = total.rev.entire.formula / awadm22) %>%
  gather(key = "scenario", value = "total.rev.apu", 14:16) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  mutate(scenario = str_replace(scenario, "total.rev.bsrevonly.apu", "Basic education only"),
         scenario = str_replace(scenario, "total.rev.entire.formula.apu", "Entire formula"),
         scenario = str_replace(scenario, "total.rev.original.apu", "Original"),
         scenario = fct_relevel(scenario, "Original", "Basic education only", "Entire formula")) %>%
  drop_na(total.rev.apu) %>%
  filter(total.rev.apu != is.infinite(total.rev.apu),
         total.rev.apu != Inf)

total.rev.increases.rel.group.plot <- ggplot(total.rev.increases.relationship, aes(scenario, total.rev.apu, color = Definition, group = Definition)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario,  "\nTotal revenue per APU: ", dollar(total.rev.apu), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Total revenue per APU by each scenario")+
  scale_y_continuous(labels=scales::dollar)+
  theme_line +
  scale_color_manual(values= brewer.pal(n = 6, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.increases.rel.group.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


tags$br()

total.rev.increases.rel.group.boxplot <- ggplot(total.rev.increases.relationship, aes(scenario, total.rev.apu, fill = Definition)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = group, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Total revenue per APU by each scenario")+
  scale_y_continuous(labels=scales::dollar)+
  theme_line +
  scale_fill_manual(values= brewer.pal(n = 4, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.increases.rel.group.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

correlation <- total.rev.increases.relationship %>%
  spread(scenario, total.rev.apu) %>%
  mutate(Definition = as.factor(Definition))

t.test(Original ~ Definition, data = correlation)

t.test(`Basic education only` ~ Definition, data = correlation)

t.test(`Entire formula` ~ Definition, data = correlation)

```

<br>

### RUCA

<br>

```{r total rev increases relationships ruca}
total.rev.increases.rel.ruca.plot <- ggplot(total.rev.increases.relationship, aes(scenario, total.rev.apu, color = Dem_Desc, group = Dem_Desc)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario,  "\nTotal revenue per APU: ", dollar(total.rev.apu), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Total revenue per APU by each scenario")+
  scale_y_continuous(labels=scales::dollar)+
  theme_line +
  scale_color_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.increases.rel.ruca.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


tags$br()

total.rev.increases.rel.ruca.boxplot <- ggplot(total.rev.increases.relationship, aes(scenario, total.rev.apu, fill = Dem_Desc)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = Dem_Desc, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Total revenue per APU by each scenario")+
  scale_y_continuous(labels=scales::dollar)+
  theme_line +
  scale_fill_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.increases.rel.ruca.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

correlation <- total.rev.increases.relationship %>%
  spread(scenario, total.rev.apu) %>%
  mutate(Dem_Desc = as.factor(Dem_Desc))

summary(aov(Original ~ Dem_Desc, data = correlation))

summary(aov(`Basic education only` ~ Dem_Desc, data = correlation))

summary(aov(`Entire formula` ~ Dem_Desc, data = correlation))


```

<br>

### Planning Region

<br>

```{r total rev increases relationships pr}
total.rev.increases.rel.pr.plot <- ggplot(total.rev.increases.relationship, aes(scenario, total.rev.apu, color = planning.region, group = planning.region)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario,  "\nTotal revenue per APU: ", dollar(total.rev.apu), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Total revenue per APU by each scenario")+
  scale_y_continuous(labels=scales::dollar)+
  theme_line +
  scale_color_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.increases.rel.pr.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


tags$br()

total.rev.increases.rel.pr.boxplot <- ggplot(total.rev.increases.relationship, aes(scenario, total.rev.apu, fill = planning.region)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = planning.region, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Total revenue per APU by each scenario")+
  scale_y_continuous(labels=scales::dollar)+
  theme_line +
  scale_fill_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.increases.rel.pr.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

correlation <- total.rev.increases.relationship %>%
  spread(scenario, total.rev.apu) %>%
  mutate(planning.region = as.factor(planning.region))

summary(aov(Original ~ planning.region, data = correlation))

summary(aov(`Basic education only` ~ planning.region, data = correlation))

summary(aov(`Entire formula` ~ planning.region, data = correlation))

```

<br>

### EDR

<br>

```{r total rev increases relationships edr}
total.rev.increases.rel.edr.plot <- ggplot(total.rev.increases.relationship, aes(scenario, total.rev.apu, color = edr, group = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario,  "\nTotal revenue per APU: ", dollar(total.rev.apu), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Total revenue per APU by each scenario")+
  scale_y_continuous(labels=scales::dollar)+
  theme_line +
  scale_color_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.increases.rel.edr.plot, width_svg = 10, height_svg = 20) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


tags$br()

total.rev.increases.rel.edr.boxplot <- ggplot(total.rev.increases.relationship, aes(scenario, total.rev.apu, fill = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = edr, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Total revenue per APU by each scenario")+
  scale_y_continuous(labels=scales::dollar)+
  theme_line +
  scale_fill_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = total.rev.increases.rel.edr.boxplot, width_svg = 10, height_svg = 15) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

correlation <- total.rev.increases.relationship %>%
  spread(scenario, total.rev.apu) %>%
  mutate(edr = as.factor(edr))

summary(aov(Original ~ edr, data = correlation))

summary(aov(`Basic education only` ~ edr, data = correlation))

summary(aov(`Entire formula` ~ edr, data = correlation))

```

<br>

## Quintiles

Let's see if any of the districts shift in the quantiles going from the original to each of the scenarios.

The maps below highlight the districts that shifted quintiles from their original revenue quintile "rank". There are very few that change. 

When increasing the basic education component only, 8 schools shift - 4 move up one quintile while 4 others move down.

When increasing the entire formula 14 districts shift - 7 move up and 7 move down one quintile rank.

<br>

```{r quintile shifts maps}
quintile.shifts.districts.bsrevonly.map <- ggplot(total.rev.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = bsrevonly.change, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - original revenue: ", dollar(Original), "\nPercentile rank among public school districts: ", original.quant.rank,  "\nTotal revenue per APU - increase to basic ed only: ", dollar(`Basic education only`), "\nPercentile rank among public school districts in revenue per APU: ", bsrevonly.quant.rank, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("#d7191c", "#2b83ba", "grey"),
                    guide = guide_legend(reverse = FALSE, ncol = 2)) +
  labs(title = "Increase to basic ed revenue only", subtitle = "Four moved, Four moved down") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        legend.position = "bottom",
        plot.margin = margin(-200,0,0,0))

quintile.shifts.districts.entire.formula.map <- ggplot(total.rev.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = entire.formula.change, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - original: ", dollar(Original), "\nPercentil rank among public school districts: ", original.quant.rank, "\nTotal revenue per APU - increase to entire formula: ", dollar(`Entire formula`), "\nPercentile among public school districts in revenue per APU: ", entire.formula.quant.rank, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("#d7191c", "#2b83ba", "grey"),
                    guide = guide_legend(reverse = FALSE, ncol = 2)) +
  labs(title = "Increase to entire formula", subtitle = "7 shift up, 7 shift down") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18),
        legend.position = "bottom",
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        plot.margin = margin(-200,0,0,0))


title <- ggdraw() +
  draw_label(
    "Districts that moved up or down a quintile",
    fontface = "bold",
    x = 0,
    hjust = 0,
    size = 24) +
  theme(
    plot.margin = margin(0,0,0,0)
  )

plot.row.1 <- plot_grid(quintile.shifts.districts.bsrevonly.map, quintile.shifts.districts.entire.formula.map, ncol = 2)
  
girafe(ggobj = plot_grid(title, plot.row.1, ncol = 1, rel_heights = c(0.1, .9)), height_svg = 12, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

## Rank{.tabset}

Next, let's just see if the ranks change much across the state. The maps below provide the public school district ranks for each scenario. The darker the shade, the higher the rank meaning the higher the total revenue per APU. The maps show that the highest ranks are in northern Minnesota and southwest with significantly less around central Minnesota and the suburbs. I was hoping to see a pattern or change in ranks across the scenarios but that doesn't seem to be the case.

<br>

```{r district rank}
rank.districts <- master.5yr.scenarios.districts %>%
  select(`District Name`, number, type, categories, revenue.0yr, revenue.bsrevonly.5yr, revenue.5yr) %>%
  rename(revenue.original = revenue.0yr) %>%
  group_by(`District Name`, number, type) %>%
  summarize(total.rev.original = sum(revenue.original, na.rm = TRUE),
            total.rev.bsrevonly = sum(revenue.bsrevonly.5yr, na.rm = TRUE),
            total.rev.entire.formula = sum(revenue.5yr, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  mutate(total.rev.original.apu = total.rev.original / awadm22,
         total.rev.bsrevonly.apu = total.rev.bsrevonly / awadm22,
         total.rev.entire.formula.apu = total.rev.entire.formula / awadm22) %>%
  ungroup() %>%
  filter(total.rev.original.apu != "Inf") %>%
  filter(total.rev.bsrevonly.apu != "Inf") %>%
  filter(total.rev.entire.formula.apu != "Inf") %>%
  arrange(desc(total.rev.original.apu)) %>%
  mutate(rank.original = seq(n())) %>%
  arrange(desc(total.rev.bsrevonly.apu)) %>%
  mutate(rank.bsrevonly = seq(n())) %>%
  arrange(desc(total.rev.entire.formula.apu)) %>%
  mutate(rank.entire.formula = seq(n())) %>%
  gather(key = "scenario", value = "rank", 17:19) %>%
  mutate(scenario = str_replace(scenario, "rank.bsrevonly", "Basic education only"),
         scenario = str_replace(scenario, "rank.entire.formula", "Entire formula"),
         scenario = str_replace(scenario, "rank.original", "Original"),
         scenario = fct_relevel(scenario, "Original", "Basic education only", "Entire formula")) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type"))

names(rank.districts)

rank.districts.map <- ggplot(rank.districts) +
  facet_wrap(~scenario, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = rank, data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario, "\nRank among schools: ", rank, sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "PuBu", direction = -1, labels = scales::comma) +
  labs(title = "Rank of total revenue per APU for each scenario") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = rank.districts.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

Perhaps looking at the maps through the lens of change. The maps below show the change in rank among all schools when going from the original total revenue per APU to the new values under each scenario. Shades of blue means a districts rank improved while yellow and orange means their ranks worsened. 

When comparing the two maps, it shows that districts in southwest Minnesota improve in rank when the entire formula increases. When only the basic education revenue is increased, the central lakes region improves significantly. 

However, this is all pretty subtle. 

<br>

```{r rank change districts}
rank.change.districts <- rank.districts %>%
  spread(scenario, rank) %>%
  mutate(bsrevonly.rank.change = `Basic education only` - `Original`,
         entire.formula.rank.change = `Entire formula` - `Original`) %>%
  gather(key = "scenario", value = "rank.change", 21:22) %>%
  mutate(scenario = str_replace(scenario, "bsrevonly.rank.change", "Basic education only"),
         scenario = str_replace(scenario, "entire.formula.rank.change", "Entire formula"))

rank.change.districts.map <- ggplot(rank.change.districts) +
  facet_wrap(~scenario, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = rank.change, data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario, "\nRank change from original: ", rank.change, sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "RdYlBu", direction = -1, labels = scales::comma) +
  labs(title = "Change in rank of total revenue per APU for each scenario") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = rank.change.districts.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

# Analysis - pct change in revenue per APU

Even though there doesn't seem to be much change or shift when comparing revenue per APU across all districts, the percentage change might highlight some patterns.

The maps below show the percent increase from the FY22 total revenues for each scenario and they show a pretty clear pattern.

When increasing the basic education component only, the highest percent increases occur in districts with higher property values such as the central lakes regions and the suburbs. However, if the entire formula increases, the highest percentages are in districts with lower property values such as central, western, and southern Minnesota.

<br>

```{r pct change districts}
pct.change.total.rev.districts <- total.rev.districts %>%
  mutate(pct.change.bsrevonly = (`Basic education only` - Original) / Original,
         pct.change.entire.formula = (`Entire formula` - Original) / Original) %>%
  mutate(quantile.pct.change.bsrevonly = cut(pct.change.bsrevonly,
                                             breaks = c(quantile(.$pct.change.bsrevonly, probs = seq(0,1, by = .20))),
                                             labels = c(paste(percent(unname(quantile(.$pct.change.bsrevonly, 0)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.bsrevonly, .20)), accuracy = .01), sep = ""),
                                                        paste(percent(unname(quantile(.$pct.change.bsrevonly, .20)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.bsrevonly, .40)), accuracy = .01), sep = ""),
                                                        paste(percent(unname(quantile(.$pct.change.bsrevonly, .40)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.bsrevonly, .60)), accuracy = .01), sep = ""),
                                                        paste(percent(unname(quantile(.$pct.change.bsrevonly, .60)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.bsrevonly, .80)), accuracy = ,01), sep = ""),
                                                        paste(percent(unname(quantile(.$pct.change.bsrevonly, .80)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.bsrevonly, 1)), accuracy = .01), sep = "")),
                                             include.lowest = TRUE),
         quantile.pct.change.entire.formula = cut(pct.change.entire.formula,
                                                  breaks = c(quantile(.$pct.change.entire.formula, probs = seq(0,1, by = .20))),
                                                  labels = c(paste(percent(unname(quantile(.$pct.change.entire.formula, 0)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.entire.formula, .20)), accuracy = .01), sep = ""),
                                                        paste(percent(unname(quantile(.$pct.change.entire.formula, .20)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.entire.formula, .40)), accuracy = .01), sep = ""),
                                                        paste(percent(unname(quantile(.$pct.change.entire.formula, .40)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.entire.formula, .60)), accuracy = .01), sep = ""),
                                                        paste(percent(unname(quantile(.$pct.change.entire.formula, .60)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.entire.formula, .80)), accuracy = ,01), sep = ""),
                                                        paste(percent(unname(quantile(.$pct.change.entire.formula, .80)), accuracy = .01), " to ", percent(unname(quantile(.$pct.change.entire.formula, 1)), accuracy = .01), sep = "")),
                                             include.lowest = TRUE))

pct.change.bsrevonly.districts.map <- ggplot(pct.change.total.rev.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = quantile.pct.change.bsrevonly, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - original revenue: ", dollar(Original), "\nPercentile rank among public school districts: ", original.quant.rank,  "\nTotal revenue per APU - increase to basic ed only: ", dollar(`Basic education only`), "\nPercentile rank among public school districts in revenue per APU: ", bsrevonly.quant.rank, "\nPercent change in revenue: ", percent(pct.change.bsrevonly, accuracy = .01), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(reverse = FALSE, ncol = 2)) +
  labs(title = "Increase to basic education only", subtitle = "Largest increases occur in areas with high property values") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        legend.position = "bottom",
        plot.margin = margin(-200,0,0,0))

pct.change.entire.formula.districts.map <- ggplot(pct.change.total.rev.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = quantile.pct.change.entire.formula, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU - original revenue: ", dollar(Original), "\nPercentile rank among public school districts: ", original.quant.rank,  "\nTotal revenue per APU - increase to basic ed only: ", dollar(`Basic education only`), "\nPercentile rank among public school districts in revenue per APU: ", entire.formula.quant.rank, "\nPercent change in revenue: ", percent(pct.change.entire.formula, accuracy = .01), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(reverse = FALSE, ncol = 2)) +
  labs(title = "Increase to the entire formula", subtitle = "Largest increases occur in districts with low property values") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18),
        plot.title = element_text(size = 16),
        plot.subtitle = element_text(size = 12),
        legend.position = "bottom",
        plot.margin = margin(-200,0,0,0))

title <- ggdraw() +
  draw_label(
    "Percent change in total revenue per APU from original revenue",
    fontface = "bold",
    size = 24,
    hjust = 0,
    x = 0
  ) +
  theme(
    plot.margin = margin(0,0,0,0)
  )

pct.change.total.rev.districts.row.1 <- plot_grid(pct.change.bsrevonly.districts.map, pct.change.entire.formula.districts.map, ncol = 2)

girafe(ggobj = plot_grid(title, pct.change.total.rev.districts.row.1, rel_heights = c(.1, .9), ncol = 1), height_svg = 12, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

## Relationships{.tabset}

Let's see if there are any relationships in the amount of percent change from the original by the type of school, RUCA category, and regions. The charts below provide the pct change in total revenue for each school district for each scenario as well as the boxplots for these changes, and quick t-test and anova tables to test for significant differences.

* Charter vs. Public: Both charts show that charter schools are more bunched together for each scenario and have very similar pct changes whereas the public schools have significantly more variance. In addition, there's a huge difference in the gap between public vs charter when increasing the entire formula. The median for public schools in that scenario is 18% vs. 16.8% for charter schools.

* RUCA: The RUCA chart shows considerable more low outliers among town/rural mix schools and urban/town/rural mix schools. The box plots show an interesting pattern. When the basic education component is the only thing increased, the median percentages and the middle 50% of values are relatively the same across all RUCA categories. However, if we increase the entire formula, entirely urban is considerably lower than the other categories. The median for the entirely urban is 17% vs. 18% for the other schools. In addition, the ANOVA test shows a significantly larger difference when increasing the entire formula vs. the basic education component only.

* Planning Region: The planning region chart shows a similar pattern to the RUCA chart. When increasing the entire formula, the seven county metro is quite a bit lower than schools in the other planning regions. The median for the seven county metro is 16.9% vs. 17.5% to 18.2% for the other regions. In fact, the ANOVA test shows that there is no statistically significant difference when increasing the basic revenue component only vs. increasing the entire formula where there is a signficant difference.

* EDR: Again, there is a significant decrease in the seven county metro compared to the other EDRs. In addition, there is much lower p-value for the differences across increasing the entire formula.

<br>

### Charter vs. public

<br>

```{r pct change relationships group}
pct.change.total.rev.relationship <- master.5yr.scenarios.districts %>%
  select(`District Name`, number, type, categories, revenue.0yr, revenue.bsrevonly.5yr, revenue.5yr) %>%
  rename(revenue.original = revenue.0yr) %>%
  group_by(`District Name`, number, type) %>%
  summarize(total.rev.original = sum(revenue.original, na.rm = TRUE),
            total.rev.bsrevonly = sum(revenue.bsrevonly.5yr, na.rm = TRUE),
            total.rev.entire.formula = sum(revenue.5yr, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  mutate(total.rev.original.apu = total.rev.original / awadm22,
         total.rev.bsrevonly.apu = total.rev.bsrevonly / awadm22,
         total.rev.entire.formula.apu = total.rev.entire.formula / awadm22,
         pct.change.total.rev.bsrevonly.apu = (total.rev.bsrevonly.apu - total.rev.original.apu) / total.rev.original.apu,
         pct.change.total.rev.entire.formula.apu = (total.rev.entire.formula.apu - total.rev.original.apu) / total.rev.original.apu) %>%
  ungroup() %>%
  gather(key = "scenario", value = "pct.change", 17:18) %>%
  mutate(scenario = str_replace(scenario, "pct.change.total.rev.bsrevonly.apu", "Basic education only"),
         scenario = str_replace(scenario, "pct.change.total.rev.entire.formula.apu", "Entire formula")) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  drop_na(planning.region, edr)

pct.change.total.rev.relationship.group.plot <- ggplot(pct.change.total.rev.relationship, aes(scenario, pct.change, color = Definition, group = Definition)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario,  "\nPct change in total revenue per APU: ", percent(pct.change, accuracy = .1), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Percent change in total revenue per APU")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  scale_color_manual(values= brewer.pal(n = 6, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.relationship.group.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


tags$br()

pct.change.total.rev.relationship.group.boxplot <- ggplot(pct.change.total.rev.relationship, aes(scenario, pct.change, fill = Definition)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = group, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Percent change in total revenue per APU")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  scale_fill_manual(values= brewer.pal(n = 4, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.relationship.group.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

correlation <- pct.change.total.rev.relationship %>%
  spread(scenario, pct.change) %>%
  mutate(Definition = as.factor(Definition))

t.test(`Basic education only` ~ Definition, data = correlation)

t.test(`Entire formula` ~ Definition, data = correlation)

```

<br>

### RUCA

<br>

```{r pct change relationships ruca}
pct.change.total.rev.relationship.ruca.plot <- ggplot(pct.change.total.rev.relationship, aes(scenario, pct.change, color = Dem_Desc, group = Dem_Desc)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario,  "\nPct change in total revenue per APU: ", percent(pct.change, accuracy = .1), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Percent change in total revenue per APU")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  scale_color_manual(values = color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.relationship.ruca.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


tags$br()

pct.change.total.rev.relationship.ruca.boxplot <- ggplot(pct.change.total.rev.relationship, aes(scenario, pct.change, fill = Dem_Desc)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = Dem_Desc, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Percent change in total revenue per APU")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  scale_fill_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.relationship.ruca.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

correlation <- pct.change.total.rev.relationship %>%
  spread(scenario, pct.change) %>%
  mutate(Dem_Desc = as.factor(Dem_Desc))

summary(aov(`Basic education only` ~ Dem_Desc, data = correlation))

summary(aov(`Entire formula` ~ Dem_Desc, data = correlation))

```

<br>

### Planning Regions

<br>

```{r pct change relationships pr}
pct.change.total.rev.relationship.pr.plot <- ggplot(pct.change.total.rev.relationship, aes(scenario, pct.change, color = planning.region, group = planning.region)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario,  "\nPct change in total revenue per APU: ", percent(pct.change, accuracy = .1), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Percent change in total revenue per APU")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  scale_color_manual(values = color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.relationship.pr.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


tags$br()

pct.change.total.rev.relationship.pr.boxplot <- ggplot(pct.change.total.rev.relationship, aes(scenario, pct.change, fill = planning.region)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = planning.region, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Percent change in total revenue per APU")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  scale_fill_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.relationship.pr.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

correlation <- pct.change.total.rev.relationship %>%
  spread(scenario, pct.change) %>%
  mutate(planning.region = as.factor(planning.region))

summary(aov(`Basic education only` ~ planning.region, data = correlation))

summary(aov(`Entire formula` ~ planning.region, data = correlation))

```

<br>

### EDR

<br>

```{r pct change relationships edr}
pct.change.total.rev.relationship.edr.plot <- ggplot(pct.change.total.rev.relationship, aes(scenario, pct.change, color = edr, group = edr)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nScenario: ", scenario,  "\nPct change in total revenue per APU: ", percent(pct.change, accuracy = .1), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Percent change in total revenue per APU")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  scale_color_manual(values = color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.relationship.edr.plot, width_svg = 15, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


tags$br()

pct.change.total.rev.relationship.edr.boxplot <- ggplot(pct.change.total.rev.relationship, aes(scenario, pct.change, fill = edr)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = edr, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Percent change in total revenue per APU")+
  scale_y_continuous(labels=scales::percent)+
  theme_line +
  scale_fill_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = pct.change.total.rev.relationship.edr.boxplot, width_svg = 15, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

correlation <- pct.change.total.rev.relationship %>%
  spread(scenario, pct.change) %>%
  mutate(edr = as.factor(edr))

summary(aov(`Basic education only` ~ edr, data = correlation))

summary(aov(`Entire formula` ~ edr, data = correlation))

```

<br>

## Quintiles



<br>

To get a clear picture, lets see what districts shift up and down in their quintile rank when comparing the scenario that increases the entire formula vs. only increasing the basic education component.

The chart below shows that there is quite a bit of movement in terms of the quintile rank in pct change between the two scenarios. When comparing quintile ranks from the basic education only scenario with increasing the entire formula, districts in the lakes regions and suburbs drop between 2 and 4 ranks in their quintile while property poor schools increase a similar amount of ranks. 

<br>

```{r pct change quintil rank shift}
quintile.rank.pct.change.total.rev.districts <- pct.change.total.rev.districts %>%
  mutate(quintile.rank.pct.change.bsrevonly = cut(pct.change.bsrevonly,
                                                  breaks = c(quantile(.$pct.change.bsrevonly, probs = seq(0,1, .2))),
                                                  labels = c(1, 2, 3, 4, 5),
                                                  include.lowest = TRUE),
         quintile.rank.pct.change.entire.formula = cut(pct.change.entire.formula,
                                                       breaks = c(quantile(.$pct.change.entire.formula, probs = seq(0, 1, .2))),
                                                       labels = c(1, 2, 3, 4, 5),
                                                       include.lowest = TRUE),
         quintile.rank.pct.change.bsrevonly = as.numeric(quintile.rank.pct.change.bsrevonly),
         quintile.rank.pct.change.entire.formula = as.numeric(quintile.rank.pct.change.entire.formula),
         quintile.shifts = quintile.rank.pct.change.entire.formula - quintile.rank.pct.change.bsrevonly,
         quintile.shifts = as.factor(quintile.shifts))

quintile.rank.pct.change.total.rev.districts.map <- ggplot(quintile.rank.pct.change.total.rev.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = quintile.shifts, data_id = `District Name`, tooltip = paste(`District Name`, "\nTotal revenue per APU: ", dollar(Original), "\nTotal revenue per APU: ", dollar(`Basic education only`), "\nPercent change - original to basic education only: ", percent(pct.change.bsrevonly, accuracy = .1),  "\nTotal revenue per APU - increase entire formula: ", dollar(`Entire formula`), "\nPercent change - original to increaseing entire formula: ", percent(pct.change.entire.formula, accuracy = .1), "\nShift in quintile from basic education only to increasing entire formula: ", quintile.shifts, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 9, "RdYlBu")) +
  labs(title = "Increase or decrease in quintile rank for pct change from\noriginal", subtitle = "Property rich districts drop while property poor districts move up") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = quintile.rank.pct.change.total.rev.districts.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

# What components drive change?{.tabset}

So now we need to figure out which components drive the change in total revenue. The chart below plots each school along with the percentage each component composes of the difference between increasing the basic education component only vs. increasing the entire formula. The chart shows that the components that are the primary drivers are;

* Local optional aid (locaid)
* Operating capital aid (cexaid)
* Small schools revenue (smlrev)

The remaining categories do also have influence but across less schools. 

<br>

```{r components districts}
comp.pct.diff <- master.5yr.scenarios.districts %>%
  select(`District Name`, number, type, categories, revenue.0yr, revenue.5yr, revenue.bsrevonly.5yr) %>%
  rename(revenue.original = revenue.0yr) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  mutate(cat.rev.original.apu = revenue.original / awadm22,
         cat.rev.bsrevonly.apu = revenue.bsrevonly.5yr / awadm22,
         cat.rev.entire.formula.apu = revenue.5yr / awadm22) %>%
  select(`District Name`, number, type, group, categories, cat.rev.original.apu, cat.rev.bsrevonly.apu, cat.rev.entire.formula.apu) %>%
  mutate(diff.cat.bsrevonly.ef.apu = cat.rev.entire.formula.apu - cat.rev.bsrevonly.apu) %>%
  left_join(total.rev.districts[,c(1,2,3,7,5,6)], by = c("District Name", "number", "type")) %>%
  rename(total.rev.apu.original = Original,
         total.rev.apu.bsrevonly = `Basic education only`,
         total.rev.apu.entire.formula = `Entire formula`)  %>%
  mutate(diff.total.rev.apu = total.rev.apu.entire.formula - total.rev.apu.bsrevonly,
         cat.pct.diff.apu = diff.cat.bsrevonly.ef.apu / diff.total.rev.apu) %>%
  group_by(categories) %>%
  mutate(axis.order = sum(cat.pct.diff.apu, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(district.join, by = c("District Name", "number", "type", "group"))

comp.pct.diff.plot <- ggplot(comp.pct.diff, aes(reorder(categories, axis.order), cat.pct.diff.apu)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nComponent: ", categories, "\nRevenue per APU from component - original: ", dollar(cat.rev.original.apu), "\nRevenue per APU from component - basic revenue only: ", dollar(cat.rev.bsrevonly.apu), "\nRevenue per APU from component - increase entire formula: ", dollar(cat.rev.entire.formula.apu), "\nComponents impact on difference between two scenarios: ", percent(cat.pct.diff.apu, accuracy = .1), sep = ""))) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent) +
  theme_line+
  coord_flip() +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

```

<br>


Next, let's see if there are any relationships between the type of school, it's RUCA category, and it's region. Since there are only a few components that make the biggest difference, we are going to include the following components;

* Local optional aid: locaid
* Operating capital aid: cexaid
* Small schools revenue: smlrev
* Equity aid: eqaid
* English learners: totlep
* Sparsity revenue: totspar
* Extended time revenue: exdayr

The charts below provide the percent of each component of the formula comprises the difference between the total increase from increasing only the basic education component to increasing the entire formula for each district. Box plots are also included to see the difference in median values and concentrations.

* Charter vs. public: the important piece here is that charter schools are not eligible to receive local optional aid, extended time revenue, or sparsity revenue. The biggest difference is the local optional aid received by public school districts. This category had a median value of 55% - meaning 55% of the difference between the two scenarios was made up by local optional aid. Charter schools typically had a higher percentage of operating capital aid, small schools revenue as well as English learners. 

* RUCA: Schools outside of entirely urban counties had significantly higher percentages in local optional aid, while more urban districts had higher percentages in operating capital aid, small schools revenue (likely charter schools), and English learners.

* Planning Region: Interestingly, local optional aid barely shows up in the seven county metro. And, Northeast has a lot of districts at or near 0 as well. Other regions have the highest percentages of all components in the category. Operating capital is highest in the seven county metro. Small schools revenue is large middle 50%. 



<br>

## Charter vs. Public

<br>

```{r components districts group}
components.included <- c("locaid", "cexaid", "smlrev", "eqaid", "totlep", "totspar", "exdayr")

total.rev.group <- master.5yr.scenarios.districts %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  group_by(`District Name`, type, number) %>%
  summarize(total.rev.original = sum(revenue.0yr, na.rm = TRUE),
            total.rev.bsrevonly = sum(revenue.bsrevonly.5yr, na.rm = TRUE),
            total.rev.entire.formula = sum(revenue.5yr, na.rm = TRUE)) %>%
  ungroup() 

comp.pct.diff.districts <- master.5yr.scenarios.districts %>%
  select(`District Name`, number, type, categories, revenue.0yr, revenue.5yr, revenue.bsrevonly.5yr) %>%
  rename(cat.revenue.original = revenue.0yr,
         cat.revenue.bsrevonly = revenue.bsrevonly.5yr,
         cat.revenue.entire.formula = revenue.5yr) %>%
  left_join(total.rev.group, by = c("District Name", "number", "type")) %>%
  mutate(diff.total.rev.scenarios = total.rev.entire.formula - total.rev.bsrevonly,
         diff.cat = cat.revenue.entire.formula - cat.revenue.bsrevonly,
         pct.diff.cat = diff.cat / diff.total.rev.scenarios) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  mutate(cat.revenue.original.apu = cat.revenue.original / awadm22,
         cat.revenue.bsrevonly.apu = cat.revenue.bsrevonly / awadm22,
         cat.revenue.entire.formula.apu = cat.revenue.entire.formula / awadm22,
         total.rev.original.apu = total.rev.original / awadm22,
         total.rev.bsrevonly.apu = total.rev.bsrevonly / awadm22,
         total.rev.entire.formula.apu = total.rev.entire.formula /awadm22,
         diff.total.rev.scenarios.apu = diff.total.rev.scenarios / awadm22,
         diff.cat.apu = diff.cat / awadm22,
         pct.diff.cat.apu = diff.cat.apu / diff.total.rev.scenarios.apu) %>%
  select(`District Name`, number, type, categories, cat.revenue.original.apu, cat.revenue.bsrevonly.apu, cat.revenue.entire.formula.apu, total.rev.original.apu, total.rev.bsrevonly.apu, total.rev.entire.formula.apu, diff.cat.apu, diff.total.rev.scenarios.apu, pct.diff.cat.apu) %>%
  group_by(categories) %>%
  mutate(axis.order = sum(pct.diff.cat.apu, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  left_join(school_districts[,c(3,4,12)], by = c("number", "type"))

comp.pct.diff.group.plot <- ggplot(filter(comp.pct.diff.districts, categories %in% components.included), aes(reorder(categories, axis.order), pct.diff.cat.apu, group = Definition, color = Definition)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nComponent: ", categories, "\nRevenue per APU from component - original: ", dollar(cat.revenue.original.apu), "\nRevenue per APU from component - basic revenue only: ", dollar(cat.revenue.bsrevonly.apu), "\nRevenue per APU from component - increase entire formula: ", dollar(cat.revenue.entire.formula.apu), "\nComponents impact on difference between two scenarios: ", percent(pct.diff.cat.apu, accuracy = .1), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent) +
  scale_color_manual(values = brewer.pal(n = 6, "RdYlBu")) +
  theme_line+
  coord_flip() +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.group.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

tags$br()

comp.pct.diff.group.boxplot <- ggplot(filter(comp.pct.diff.districts, categories %in% components.included), aes(reorder(categories, -axis.order), pct.diff.cat.apu, fill = Definition)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = group, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_discrete(guide = guide_axis(angle = 25)) +
  theme_line +
  scale_fill_manual(values= brewer.pal(n = 4, "RdYlBu"),
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.group.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))




```

<br>

## RUCA

<br>

```{r components districts ruca}
comp.pct.diff.ruca.plot <- ggplot(filter(comp.pct.diff.districts, categories %in% components.included), aes(reorder(categories, axis.order), pct.diff.cat.apu, group = Dem_Desc, color = Dem_Desc)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nComponent: ", categories, "\nRevenue per APU from component - original: ", dollar(cat.revenue.original.apu), "\nRevenue per APU from component - basic revenue only: ", dollar(cat.revenue.bsrevonly.apu), "\nRevenue per APU from component - increase entire formula: ", dollar(cat.revenue.entire.formula.apu), "\nComponents impact on difference between two scenarios: ", percent(pct.diff.cat.apu, accuracy = .1), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent) +
  scale_color_manual(values = color.ruca) +
  theme_line+
  coord_flip() +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.ruca.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

tags$br()

comp.pct.diff.ruca.boxplot <- ggplot(filter(comp.pct.diff.districts, categories %in% components.included), aes(reorder(categories, -axis.order), pct.diff.cat.apu, fill = Dem_Desc)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = Dem_Desc, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_discrete(guide = guide_axis(angle = 25)) +
  theme_line +
  scale_fill_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.ruca.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))




```

<br>

## Planning Regions

<br>

```{r components districts pr}
comp.pct.diff.pr.plot <- ggplot(filter(comp.pct.diff.districts, categories %in% components.included), aes(reorder(categories, axis.order), pct.diff.cat.apu, group = planning.region, color = planning.region)) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nComponent: ", categories, "\nRevenue per APU from component - original: ", dollar(cat.revenue.original.apu), "\nRevenue per APU from component - basic revenue only: ", dollar(cat.revenue.bsrevonly.apu), "\nRevenue per APU from component - increase entire formula: ", dollar(cat.revenue.entire.formula.apu), "\nComponents impact on difference between two scenarios: ", percent(pct.diff.cat.apu, accuracy = .1), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent) +
  scale_color_manual(values = color.pr) +
  theme_line+
  coord_flip() +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.pr.plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

tags$br()

comp.pct.diff.pr.boxplot <- ggplot(filter(comp.pct.diff.districts, categories %in% components.included), aes(reorder(categories, -axis.order), pct.diff.cat.apu, fill = planning.region)) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = planning.region, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_discrete(guide = guide_axis(angle = 25)) +
  theme_line +
  scale_fill_manual(values= color.pr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.pr.boxplot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))




```

<br>

## EDR

<br>

```{r components districts edr}
comp.pct.diff.edr.plot <- ggplot(filter(comp.pct.diff.districts, categories %in% components.included & !is.na(pct.diff.cat.apu)), aes(reorder(categories, axis.order), pct.diff.cat.apu, group = edr, color = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_point_interactive(size = 5, aes(data_id = `District Name`, tooltip = paste(`District Name`, "\nComponent: ", categories, "\nRevenue per APU from component - original: ", dollar(cat.revenue.original.apu), "\nRevenue per APU from component - basic revenue only: ", dollar(cat.revenue.bsrevonly.apu), "\nRevenue per APU from component - increase entire formula: ", dollar(cat.revenue.entire.formula.apu), "\nComponents impact on difference between two scenarios: ", percent(pct.diff.cat.apu, accuracy = .1), sep = "")), position = position_dodge(width = .5)) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent) +
  scale_color_manual(values = color.edr) +
  theme_line+
  coord_flip() +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.edr.plot, width_svg = 10, height_svg = 15) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))

tags$br()

comp.pct.diff.edr.boxplot <- ggplot(filter(comp.pct.diff.districts, categories %in% components.included), aes(reorder(categories, -axis.order), pct.diff.cat.apu, fill = edr)) +
  facet_wrap(~planning.region, ncol = 2) +
  geom_boxplot_interactive(outlier.colour = "black", outlier.shape = 16, outlier.size = 2, position = "dodge", aes(data_id = edr, tooltip = after_stat({paste(
    "Group: ", .data$fill,
          "\nQ1: ", prettyNum(.data$ymin),
          "\nQ3: ", prettyNum(.data$ymax),
          "\nmedian: ", prettyNum(.data$middle)
  )}))) +
  labs(x="", y = "", color="", title = "Components percentage difference between two scenarios")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_discrete(guide = guide_axis(angle = 25)) +
  theme_line +
  scale_fill_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.edr.boxplot, width_svg = 10, height_svg = 15) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))




```

<br>

Let's see what this looks like on a map (which be only public schools). The maps below show the top 4 categories that drive the difference between the two scenarios. It clearly shows that nearly all of greater Minnesota benefits from the local optional aid. This component drives between 40 and 75% of the difference between the two scenarios. For the seven county metro, operating capital becomes the highest. In some districts in northern Minnesota, small schools revenue and sparsity revenue are the largest drivers. 

The second largest component for much of greater Minnesota districts is operating capital aid, small schools revenue, and English learners.

<br>

```{r components pct diff district map}
comp.pct.diff.districts.rank <- comp.pct.diff.districts %>%
  group_by(`District Name`, number, type) %>%
  arrange(desc(pct.diff.cat.apu)) %>%
  mutate(rank = seq(n())) %>%
  ungroup() %>%
  filter(rank < 5) %>%
  mutate(rank = as.factor(rank),
         categories = ifelse(categories == "bsrev", "None", categories))

comp.pct.diff.districts.rank.map <- ggplot(comp.pct.diff.districts.rank) +
  facet_wrap(~rank, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = categories, data_id = `District Name`, tooltip = paste(`District Name`, "\nCategory: ", categories, "\nRank as pct of difference: ", rank, "\nPercent this component comprises of difference between two scenarios: ", percent(pct.diff.cat.apu, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 11, "RdYlBu"))+
  labs(title = "Largest driver of difference between two scenarios") +
  theme(legend.box.margin = margin(50, 0, 0, 0),
        text = element_text(size = 18))

girafe(ggobj = comp.pct.diff.districts.rank.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))


```