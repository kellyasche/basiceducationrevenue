---
title: "Analysis - revenue per APU"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)

```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r shapefiles}
school_districts <- read_sf("Data/Shapefiles/School Shapefiles/School_district_boundaries.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(type = UNI_TYP,
         number = UNI_MAJ)

```


```{r master basic revenue}
original <- read_csv("Data/Formula/Master.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         eqgroup.label = ifelse(is.na(eqgroup.label), "", eqgroup.label)) %>%
  filter(group %in% c(1,4))

group.codes <- read_xlsx("Data/Formula/group codes.xlsx")

var.codes <- read_xlsx("Data/Formula/primary variable codes.xlsx")

categories <- c("bsrev", "exdayr", "gtrev", "smlrev", "decrev", "locaid", "afdc22", "totlep", "totspar", "cexaid", "tsparrev", "eqaid", "hhaid", "penrev")

master.original <- original %>%
  select(`District Name`, number, type, categories) %>%
  gather(key = "categories", value = "revenue.original", 4:17) 

```

```{r 4% increase scenario}
bsrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         bsrev.4pct = round(awadm22 * fa22.4pct)) %>%
  select(`District Name`, number, type, bsrev.4pct)

exdayr.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22x.4pct = (fa22x * .04) + fa22x,
         exdayr.4pct = round(fa22x.4pct * xwadm22),
         exdayr.4pct = ifelse(number == 347, exdayr.4pct, exdayr.4pct)) %>%
  select(`District Name`, number, type, exdayr.4pct)

gtrev22.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(gt22.4pct = gt22 + 1,
         gtrev.4pct = round(gt22.4pct * awadm22),
         gtaid.4pct = gtrev.4pct,
         gtlvy.4pct = gtrev.4pct - gtaid.4pct) %>%
  select(`District Name`, number, type, gtrev.4pct)

smlrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22sm.4pct = (fa22sm * .04) + fa22sm,
         smlalo.4pct = smlrto * fa22sm.4pct,
         smlrev.4pct = round(smlalo.4pct * awadm22),
         smlrev.4pct = ifelse(number == 318, (70189.06*.04) + 70189.06, smlrev.4pct),
         smlrev.4pct = ifelse(number == 363, (115058.66 * .04) + 115058.66, smlrev.4pct),
         smlrev.4pct = ifelse(number == 381, (241346.69 * .04) + 241346.69, smlrev.4pct),
         smlrev.4pct = ifelse(number == 2142, (404349.22 * .04) + 404349.22, smlrev.4pct)) %>%
  select(`District Name`, number, type, smlrev.4pct)

decrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22 * .04) + fa22,
         decalo.4pct = round(fa22.4pct * 0.28),
         declpu.4pct = awadm21 - awadm22,
         declpu.4pct = ifelse(declpu.4pct < 0, 0, declpu.4pct),
         decrev.4pct = round(decalo.4pct * declpu.4pct),
         decrev.4pct = ifelse(awadm22 == 0, 0, decrev.4pct)) %>%
  select(`District Name`, number, type, decrev.4pct)

locaid.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(localo.4pct = (localo * .04) + localo,
         locrev.4pct = (locrev * .04) + locrev,
         loctier1.4pct = 0,
         loctier2.4pct = 0,
         loctier1.4pct = ifelse(localo.4pct >= (300*.04) + 300, (300*.04) + 300, loctier1.4pct),
         loctier1.4pct = ifelse(localo.4pct < (300*.04) + 300, localo.4pct, loctier1.4pct),
         loctier2.4pct = ifelse(loctier1.4pct == (300*.04)+300, localo.4pct - loctier1.4pct, loctier2.4pct),
         loctier2.4pct = ifelse(loctier1.4pct < (300*.04) + 300, 0, loctier2.4pct),
         loctier1rev.4pct = round(loctier1.4pct * awadm22),
         loctier2rev.4pct = round(loctier2.4pct * awadm22),
         loctier1_eq_factor.4pct = (880000 * .04) + 880000,
         loctier2_eq_factor.4pct = (510000 * .04) + 510000,
         loclvytier1.4pct = 0.0,
         loclvytier1.4pct = ifelse(wadm22 > 0 & group == 1, round(loctier1rev.4pct * ((rmkv19 / wadm22) / loctier1_eq_factor.4pct)), loclvytier1.4pct)) %>%
  rowwise() %>%
  mutate(loclvytier1.4pct = min(loctier1rev.4pct, loclvytier1.4pct)) %>%
  ungroup() %>%
  mutate(locaidtier1.4pct = loctier1rev.4pct - loclvytier1.4pct,
         loclvytier2.4pct = 0.0,
         loclvytier2.4pct = ifelse(wadm22 > 0 & group == 1, round(loctier2rev.4pct * ((rmkv19 / wadm22) / loctier2_eq_factor.4pct)), loclvytier2.4pct)) %>%
  rowwise() %>%
  mutate(loclvytier2.4pct = min(loctier2rev.4pct, loclvytier2.4pct)) %>%
  ungroup() %>%
  mutate(locaidtier2.4pct = loctier2rev.4pct - loclvytier2.4pct,
         loclvy.4pct = loclvytier1.4pct + loclvytier2.4pct,
         locaid.4pct = locaidtier1.4pct + locaidtier2.4pct) %>%
  select(`District Name`, number, type, loctier1rev.4pct, locaid.4pct)

afdc22.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(afdc22.4pct = (afdc22 * .04) + afdc22) %>%
  select(`District Name`, number, type, afdc22.4pct)

totlep.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(leprat1.4pct = (704*.04) + 704,
         leprat2.4pct = (250*.04) + 250,
         leprev.4pct = round(lepadm22_min * leprat1.4pct),
         leppct.4pct = 0.0,
         leppct.4pct = ifelse(admsv22 > 0, lepadm22 / admsv22, leppct.4pct),
         lepftr.4pct = leppct.4pct / 0.115,
         lepftr.4pct = ifelse(lepftr.4pct < 0, 0,
                         ifelse(lepftr.4pct > 1, 1, lepftr.4pct)),
         lepcpu.4pct = lepadm22 * lepftr.4pct,
         lepcrev.4pct = round(lepcpu.4pct * leprat2.4pct),
         totlep.4pct = leprev.4pct + lepcrev.4pct) %>%
  select(`District Name`, number, type, totlep.4pct)

totspar.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         fa22ss.4pct = fa22.4pct - 530,
         sprevini.4pct = round(isoftr * admftr * sadmsv22 * fa22ss.4pct - 0),
         mspar22.4pct = round(mspar22 * (fa22ss.4pct / fa22ss.4pct)),
         hhspar22.4pct = round(hhspar22 * (fa22ss.4pct / fa22ss.4pct)),
         sprev.4pct = sprevini.4pct,
         sprev.4pct = ifelse(mspar22.4pct > sprevini.4pct, mspar22.4pct, sprev.4pct),
         sprev.4pct = ifelse(hhspar22.4pct > sprevini.4pct, hhspar22.4pct, sprev.4pct),
         espar22.4pct = (espar22 * .04) + espar22,
         elmspar.4pct = round(espar22.4pct * (fa22ss.4pct / fa22ss.4pct)),
         minspar.4pct = sprev.4pct + elmspar.4pct,
         totspar.4pct = minspar.4pct,
         totspar.4pct = ifelse(closedblg > 0 & srsrev21 > minspar.4pct, srsrev21, totspar.4pct),
         srsrev22.4pct = totspar.4pct) %>%
  select(`District Name`, number, type,  totspar.4pct)
  

cexaid.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(cxfrev.4pct = round(awadm22 * (((79*.04)+79) + ((109*.04)+109) * ageidx22)),
         ocexrev.4pct = round(cxfrev.4pct + (((31*.04)+31) * ywadm22)),
         cex_eq_factor.4pct = (22912*.04)+22912,
         cexrto.4pct = 0.0,
         cexrto.4pct = ifelse(awadm22 > 0 & group == 1, (antc19 / awadm22) / cex_eq_factor.4pct, cexrto.4pct),
         cexrto.4pct = ifelse(cexrto.4pct < 0, 0,
                              ifelse(cexrto.4pct > 1.0, 1, cexrto.4pct)),
         cexlvy.4pct = round(ocexrev.4pct * cexrto.4pct),
         cexaid.4pct = ocexrev.4pct - cexlvy.4pct) %>%
  select(`District Name`, number, type, cexaid.4pct)

tsparrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         fa22ts.4pct = fa22.4pct,
         tsparal.4pct = ((fa22ts.4pct * 0.141 * trsindex**0.26 * trdindex**0.13) -(fa22ts.4pct * trapct)),
         tsparal.4pct = ifelse(tsparal.4pct < 0, 0, tsparal.4pct), #if less than zero, return zero
         bastrans.4pct = round((fa22ts.4pct * trapct) * awadm22),
         tsparrev1.4pct = round(tsparal.4pct * awadm22),
         tsparrev2.4pct = 0,
         tottrarev.4pct = tottrarev22) %>%
  rowwise() %>%
  mutate(transex.4pct = min(transex21, transex20 * 1.05)) %>%
  ungroup() %>%
  mutate(tsparrev2.4pct = (transex.4pct - tottrarev.4pct) * 0.182,
         tsparrev2.4pct = ifelse(tsparrev2.4pct < 0, 0, tsparrev2.4pct),
         tsparrev.4pct = tsparrev1.4pct + tsparrev2.4pct,
         tsparaln.4pct = 0,
         tsparaln.4pct = ifelse(awadm22 > 0 & group==1, (tsparrev2.4pct / awadm22) + tsparal.4pct, tsparaln.4pct)) %>%
  select(`District Name`, number, type, tsparaln.4pct, tsparrev.4pct)

hhaid.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(hh_eq_factor.4pct = (hh_eq_factor * .04) + hh_eq_factor,
         hhlvy.4pct = 0.0,
         hhlvy.4pct = ifelse(wadm22 > 0 & group == 1, round(hhrev * ((rmkv19 / wadm22) / hh_eq_factor.4pct)), hhlvy.4pct)) %>%
  rowwise() %>%
  mutate(hhlvy.4pct = min(hhlvy.4pct, hhrev)) %>%
  ungroup() %>%
  mutate(hhaid.4pct = hhrev - hhlvy.4pct) %>%
  select(`District Name`, number, type, hhaid.4pct)

refrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(refcap.4pct = max(altcap22, stdcap)) %>%
  ungroup() %>%
  mutate(fa22.4pct = (fa22 * .04) + fa22,
         fa22ss.4pct = fa22.4pct - 530,
         sprevini.4pct = round(isoftr * admftr * sadmsv22 * fa22ss.4pct - 0),
         mspar22.4pct = round(mspar22 * (fa22ss.4pct / fa22ss.4pct)),
         hhspar22.4pct = round(hhspar22 * (fa22ss.4pct / fa22ss.4pct)),
         sprev.4pct = sprevini.4pct,
         sprev.4pct = ifelse(mspar22.4pct > sprevini.4pct, mspar22.4pct, sprev.4pct),
         sprev.4pct = ifelse(hhspar22.4pct > sprevini.4pct, hhspar22.4pct, sprev.4pct),
         espar22.4pct = (espar22 * .04) + espar22,
         elmspar.4pct = round(espar22.4pct * (fa22ss.4pct / fa22ss.4pct))) %>%
  rowwise() %>%
  mutate(refcap.4pct = max(altcap22, stdcap)) %>%
  ungroup() %>%
  mutate(refcap.4pct = ifelse(sprev.4pct + elmspar.4pct > 0, 99999999, refcap.4pct),
         refalo22.4pct = refalo22t,
         refalo22.4pct = ifelse(refalo22t > refcap.4pct, refcap.4pct, refalo22.4pct),
         refrev22.4pct = round(refalo22.4pct * awadm22)) %>%
  select(`District Name`, number, type, refrev22.4pct)


ajgeppu.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(bsrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(refrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.4pct, by = c("District Name", "number", "type")) %>%
  mutate(ajgened.4pct = bsrev.4pct + refrev22.4pct + hhrev + loctier1rev.4pct, # add lor tier 1 beginning FY21
         ajgeppu.4pct = 0.0,
         ajgeppu.4pct = ifelse(awadm22 > 0 & group == 1, round((ajgened.4pct / awadm22) * 100) / 100, ajgeppu.4pct)) %>%
  select(`District Name`, number, type, ajgeppu.4pct)
 
percentile.helper <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(ajgeppu.4pct, by = c("District Name", "number", "type")) %>%
  mutate(rur5.4pct = quantile(ajgeppu.4pct[eqgroup.label == "ruraleq" & ajgeppu.4pct > 0], .05, type = 1),
         rur95.4pct = quantile(ajgeppu.4pct[eqgroup.label == "ruraleq" & ajgeppu.4pct > 0], .95, type = 1),
         metro5.4pct = quantile(ajgeppu.4pct[eqgroup.label == "metroeq"], .05, type = 1),
         metro95.4pct = quantile(ajgeppu.4pct[eqgroup.label == "metroeq"], .95, type = 1),
         ajgep5.4pct = 0.0,
         ajgep95.4pct = 0.0,
         ajgep5.4pct = ifelse(eqgroup.label == "ruraleq", rur5.4pct,
                         ifelse(eqgroup.label == "metroeq", metro5.4pct, ajgep5.4pct)),
         ajgep95.4pct = ifelse(eqgroup.label == "ruraleq", rur95.4pct,
                          ifelse(eqgroup.label == "metroeq", metro95.4pct, ajgep95.4pct)),
         seqgap.4pct = ajgep95.4pct - ajgep5.4pct,
         seqgap.4pct = ifelse(seqgap.4pct < 0, 0, seqgap.4pct), # clip negatives
         deqgap.4pct = ajgep95.4pct - ajgeppu.4pct,
         deqgap.4pct = ifelse(deqgap.4pct < 0, 0, deqgap.4pct), # clip negatives
         eqindx.4pct = 0.0,
         eqindx.4pct = deqgap.4pct / seqgap.4pct) %>%
  select(`District Name`, number, type, deqgap.4pct, eqindx.4pct) 

refrev_ave.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(refrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.4pct, by = c("District Name", "number", "type")) %>%
  mutate(refrev_eq.4pct = refrev22.4pct,
         refrev_eq.4pct = ifelse(number == 3000, refrev_new, refrev_eq.4pct),
         refrev_sd.4pct = sum(refrev_eq.4pct[group %in% c(1,2)]),
         loctier1_eq.4pct = loctier1rev.4pct,
         loctier1_eq.4pct = ifelse(number == 3000, 0, loctier1_eq.4pct),
         locrev_sd.4pct = sum(loctier1_eq.4pct[group %in% c(1,2)]),
         awadm_sd.4pct = sum(awadm22[group %in% c(1,2)]),
         refrev_ave.4pct = refrev_sd.4pct / awadm_sd.4pct,
         loc_ave.4pct = locrev_sd.4pct / awadm_sd.4pct) %>%
  select(`District Name`, number, type, refrev_ave.4pct, loc_ave.4pct)

eqrev1.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(percentile.helper, by = c("District Name", "number", "type")) %>%
  mutate(sldalo.4pct = (80*.04) + 80,
         eqrev1.4pct = round(awadm22 * (((14*.04)+14) + (sldalo.4pct * eqindx.4pct))),
         eqrev1.4pct = ifelse(dist==1 & type==3 | number==625 | number==709 | deqgap.4pct==0, 0, eqrev1.4pct),
         eqrev1_p.4pct = 0.0,
         eqrev1_p.4pct = ifelse(group==1 & awadm22 > 0, round(eqrev1.4pct / awadm22), eqrev1_p.4pct)) %>%
  select(`District Name`, number, type, eqrev1.4pct)

eqrev2.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(refrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(refrev_ave.4pct, by = c("District Name", "number", "type")) %>%
  left_join(percentile.helper, by = c("District Name", "number", "type")) %>%
  mutate(sst22.4pct = 100000,
         refrev_p.4pct = 0.0,
         refrev_p.4pct = ifelse(awadm22 > 0,  (refrev22.4pct + loctier1rev.4pct) / awadm22, refrev_p.4pct),
         eqrev2.4pct = 0.0,
         eqrev2.4pct = ifelse(refrev_p.4pct < ((refrev_ave.4pct + loc_ave.4pct) * 0.1), (((refrev_ave.4pct + loc_ave.4pct) * 0.1) - refrev_p.4pct) * awadm22, eqrev2.4pct),
         eqrev2.4pct = ifelse(eqrev2.4pct > sst22.4pct, sst22.4pct, eqrev2.4pct),
         eqrev2.4pct = ifelse(dist==1 & type==3 | number==625 | number==709 |deqgap.4pct==0, 0, eqrev2.4pct)) %>%
  select(`District Name`, number, type, eqrev2, eqrev2.4pct)

eqrev3.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(eqrev1.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev2.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eqrev3.4pct = 0.0,
         eqrev3.4pct = ifelse(eqgroup.label == "metroeq", (eqrev1.4pct + eqrev2.4pct) * 0.25, eqrev3.4pct),
         eqrev3.4pct = ifelse(eqgroup.label == "ruraleq", (eqrev1.4pct + eqrev2.4pct) * 0.25, eqrev3.4pct)) %>%
  select(`District Name`, number, type, eqrev3.4pct)

eqrev4.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(percentile.helper, by = c("District Name", "number", "type")) %>%
  mutate(eqblw95.4pct = (50*.04) + 50,
         eqabv95.4pct = (50*.04) + 50,
         eqrev4.4pct = round(awadm22 * eqblw95.4pct),
         eqrev4.4pct = ifelse(deqgap.4pct == 0,round(awadm22 * eqabv95.4pct), eqrev4.4pct)) %>%
  select(`District Name`, number, type, eqrev4.4pct)

eqrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(eqrev1.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev2.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev3.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev4.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eqrev.4pct = eqrev1.4pct + eqrev2.4pct + eqrev3.4pct + eqrev4.4pct) %>%
  select(`District Name`, number, type, eqrev.4pct)

eqaid.4pct <- original %>%
  left_join(eqrev.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eq_eq_factor.4pct = (510000*.04)+510000,
         eqlvy.4pct = 0.0,
         eqlvy.4pct = ifelse(wadm22 > 0 & group == 1, round(eqrev.4pct * ((rmkv19 / wadm22) / eq_eq_factor.4pct)), eqlvy.4pct),
         eqlvy.4pct = ifelse(eqlvy.4pct > eqrev.4pct, eqrev.4pct, eqlvy.4pct),
         eqaid.4pct = eqrev.4pct - eqlvy.4pct) %>%
  select(`District Name`, number, type, eqaid.4pct)

penrev.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(penrev.4pct = penrev) %>%
  select(`District Name`, number,  type, penrev.4pct)

optadjfa.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(tsparrev.4pct, by = c("District Name", "number", "type")) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         optadjin.4pct = 0.0,
         optadjin.4pct = 0.0,
         optbasch.4pct = round((clwadm22 + mclwadm22) * fa22.4pct * trapct),
         optsrsch.4pct = round((clwadm22 + mclwadm22) * tsparaln.4pct),
         optextch.4pct = 0.0,
         optadjch.4pct = optbasch.4pct + optextch.4pct + optsrsch.4pct,
         optadjfa.4pct = round(cfwadm22 * -fa22.4pct),
         optadjfa.4pct = ifelse(type == 70, round(0 * fa22.4pct / fa22.4pct), optadjfa.4pct),
         optadjfa.4pct = ifelse(type == 90, round(641313.36 * fa22.4pct / fa22.4pct), optadjfa.4pct),
         optadj.4pct = optadjin.4pct + optadjch.4pct + optadjfa.4pct) %>%
  select(`District Name`, number, type, optadj.4pct)

master.4pct <- bsrev.4pct %>%
  left_join(exdayr.4pct, by = c("District Name", "number", "type")) %>%
  left_join(gtrev22.4pct, by = c("District Name", "number", "type")) %>%
  left_join(smlrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(decrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(afdc22.4pct, by = c("District Name", "number", "type")) %>%
  left_join(totlep.4pct, by = c("District Name", "number", "type")) %>%
  left_join(totspar.4pct, by = c("District Name", "number", "type")) %>%
  left_join(cexaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(hhaid.4pct, by = c("District Name", "number", "type")) %>%
  left_join(tsparrev.4pct, by = c("District Name", "number", "type")) %>%
  left_join(optadjfa.4pct, by = c("District Name", "number", "type" )) %>%
  left_join(penrev.4pct, by = c("District Name", "number", "type" )) %>%
  select(1:8, 10:16, 18:20) %>%
  gather(key = "categories", value = "revenue.4pct", 4:18 ) %>%
  mutate(categories = str_sub(categories, 1, -6),
         revenue.4pct = ifelse(is.na(revenue.4pct), 0, revenue.4pct)) 

```

```{r 4% basic revenue only}
bsrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         bsrev.bsrevonly.4pct = round(awadm22 * fa22.4pct)) %>%
  select(`District Name`, number, type, bsrev.bsrevonly.4pct)

exdayr.bsrevonly.4pct <- original %>%
  mutate(exdayr.bsrevonly.4pct = exdayr) %>%
  select(`District Name`, number, type, exdayr.bsrevonly.4pct)

gtrev22.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(gtrev.bsrevonly.4pct = gtrev) %>%
  select(`District Name`, number, type, gtrev.bsrevonly.4pct)

smlrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(smlrev.bsrevonly.4pct = smlrev) %>%
  select(`District Name`, number, type, smlrev.bsrevonly.4pct)

decrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.bsrevonly.4pct = (fa22 * .04) + fa22,
         decalo.bsrevonly.4pct = round(fa22.bsrevonly.4pct * 0.28),
         declpu.bsrevonly.4pct = awadm21 - awadm22,
         declpu.bsrevonly.4pct = ifelse(declpu.bsrevonly.4pct < 0, 0, declpu.bsrevonly.4pct),
         decrev.bsrevonly.4pct = round(decalo.bsrevonly.4pct * declpu.bsrevonly.4pct),
         decrev.bsrevonly.4pct = ifelse(awadm22 == 0, 0, decrev.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, decrev.bsrevonly.4pct)

locaid.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(loctier1rev.bsrevonly.4pct = loctier1rev,
         locaid.bsrevonly.4pct = locaid) %>%
  select(`District Name`, number, type, loctier1rev.bsrevonly.4pct, locaid.bsrevonly.4pct)

afdc22.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(afdc22.bsrevonly.4pct = (afdc22 * .04) + afdc22) %>%
  select(`District Name`, number, type, afdc22.bsrevonly.4pct)

totlep.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(totlep.bsrevonly.4pct = totlep) %>%
  select(`District Name`, number, type, totlep.bsrevonly.4pct)

totspar.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         fa22ss.4pct = fa22.4pct - 530,
         sprevini.4pct = round(isoftr * admftr * sadmsv22 * fa22ss.4pct - 0),
         mspar22.4pct = round(mspar22 * (fa22ss.4pct / fa22ss.4pct)),
         hhspar22.4pct = round(hhspar22 * (fa22ss.4pct / fa22ss.4pct)),
         sprev.4pct = sprevini.4pct,
         sprev.4pct = ifelse(mspar22.4pct > sprevini.4pct, mspar22.4pct, sprev.4pct),
         sprev.4pct = ifelse(hhspar22.4pct > sprevini.4pct, hhspar22.4pct, sprev.4pct),
         espar22.4pct = espar22,
         elmspar.4pct = round(espar22.4pct * (fa22ss.4pct / fa22ss.4pct)),
         minspar.4pct = sprev.4pct + elmspar.4pct,
         totspar.bsrevonly.4pct = minspar.4pct,
         totspar.bsrevonly.4pct = ifelse(closedblg > 0 & srsrev21 > minspar.4pct, srsrev21, totspar.bsrevonly.4pct),
         srsrev22.bsrevonly.4pct = totspar.bsrevonly.4pct) %>%
  select(`District Name`, number, type,  totspar.bsrevonly.4pct)
  

cexaid.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(cexaid.bsrevonly.4pct = cexaid) %>%
  select(`District Name`, number, type,  cexaid.bsrevonly.4pct)

tsparrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         fa22ts.4pct = fa22.4pct,
         tsparal.4pct = ((fa22ts.4pct * 0.141 * trsindex**0.26 * trdindex**0.13) -(fa22ts.4pct * trapct)),
         tsparal.4pct = ifelse(tsparal.4pct < 0, 0, tsparal.4pct), #if less than zero, return zero
         bastrans.4pct = round((fa22ts.4pct * trapct) * awadm22),
         tsparrev1.4pct = round(tsparal.4pct * awadm22),
         tsparrev2.4pct = 0,
         tottrarev.4pct = tottrarev22) %>%
  rowwise() %>%
  mutate(transex.4pct = min(transex21, transex20 * 1.05)) %>%
  ungroup() %>%
  mutate(tsparrev2.4pct = (transex.4pct - tottrarev.4pct) * 0.182,
         tsparrev2.4pct = ifelse(tsparrev2.4pct < 0, 0, tsparrev2.4pct),
         tsparrev.bsrevonly.4pct = tsparrev1.4pct + tsparrev2.4pct,
         tsparaln.bsrevonly.4pct = 0,
         tsparaln.bsrevonly.4pct = ifelse(awadm22 > 0 & group==1, (tsparrev2.4pct / awadm22) + tsparal.4pct, tsparaln.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, tsparaln.bsrevonly.4pct, tsparrev.bsrevonly.4pct)

hhaid.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(hhaid.bsrevonly.4pct = hhaid) %>%
  select(`District Name`, number, type, hhaid.bsrevonly.4pct)

refrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(refcap.4pct = max(altcap22, stdcap)) %>%
  ungroup() %>%
  mutate(fa22.4pct = (fa22 * .04) + fa22,
         fa22ss.4pct = fa22.4pct - 530,
         sprevini.4pct = round(isoftr * admftr * sadmsv22 * fa22ss.4pct - 0),
         mspar22.4pct = round(mspar22 * (fa22ss.4pct / fa22ss.4pct)),
         hhspar22.4pct = round(hhspar22 * (fa22ss.4pct / fa22ss.4pct)),
         sprev.4pct = sprevini.4pct,
         sprev.4pct = ifelse(mspar22.4pct > sprevini.4pct, mspar22.4pct, sprev.4pct),
         sprev.4pct = ifelse(hhspar22.4pct > sprevini.4pct, hhspar22.4pct, sprev.4pct),
         espar22.4pct = espar22,
         elmspar.4pct = round(espar22.4pct * (fa22ss.4pct / fa22ss.4pct))) %>%
  rowwise() %>%
  mutate(refcap.4pct = max(altcap22, stdcap)) %>%
  ungroup() %>%
  mutate(refcap.4pct = ifelse(sprev.4pct + elmspar.4pct > 0, 99999999, refcap.4pct),
         refalo22.4pct = refalo22t,
         refalo22.4pct = ifelse(refalo22t > refcap.4pct, refcap.4pct, refalo22.4pct),
         refrev22.bsrevonly.4pct = round(refalo22.4pct * awadm22)) %>%
  select(`District Name`, number, type, refrev22.bsrevonly.4pct)


ajgeppu.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(bsrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(refrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(ajgened.bsrevonly.4pct = bsrev.bsrevonly.4pct + refrev22.bsrevonly.4pct + hhrev + loctier1rev.bsrevonly.4pct, # add lor tier 1 beginning FY21
         ajgeppu.bsrevonly.4pct = 0.0,
         ajgeppu.bsrevonly.4pct = ifelse(awadm22 > 0 & group == 1, round((ajgened.bsrevonly.4pct / awadm22) * 100) / 100, ajgeppu.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, ajgeppu.bsrevonly.4pct)
 
percentile.helper.bsrevonly <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(ajgeppu.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(rur5.bsrevonly.4pct = quantile(ajgeppu.bsrevonly.4pct[eqgroup.label == "ruraleq" & ajgeppu.bsrevonly.4pct > 0], .05, type = 1),
         rur95.bsrevonly.4pct = quantile(ajgeppu.bsrevonly.4pct[eqgroup.label == "ruraleq" & ajgeppu.bsrevonly.4pct > 0], .95, type = 1),
         metro5.bsrevonly.4pct = quantile(ajgeppu.bsrevonly.4pct[eqgroup.label == "metroeq"], .05, type = 1),
         metro95.bsrevonly.4pct = quantile(ajgeppu.bsrevonly.4pct[eqgroup.label == "metroeq"], .95, type = 1),
         ajgep5.bsrevonly.4pct = 0.0,
         ajgep95.bsrevonly.4pct = 0.0,
         ajgep5.bsrevonly.4pct = ifelse(eqgroup.label == "ruraleq", rur5.bsrevonly.4pct,
                         ifelse(eqgroup.label == "metroeq", metro5.bsrevonly.4pct, ajgep5.bsrevonly.4pct)),
         ajgep95.bsrevonly.4pct = ifelse(eqgroup.label == "ruraleq", rur95.bsrevonly.4pct,
                          ifelse(eqgroup.label == "metroeq", metro95.bsrevonly.4pct, ajgep95.bsrevonly.4pct)),
         seqgap.bsrevonly.4pct = ajgep95.bsrevonly.4pct - ajgep5.bsrevonly.4pct,
         seqgap.bsrevonly.4pct = ifelse(seqgap.bsrevonly.4pct < 0, 0, seqgap.bsrevonly.4pct), # clip negatives
         deqgap.bsrevonly.4pct = ajgep95.bsrevonly.4pct - ajgeppu.bsrevonly.4pct,
         deqgap.bsrevonly.4pct = ifelse(deqgap.bsrevonly.4pct < 0, 0, deqgap.bsrevonly.4pct), # clip negatives
         eqindx.bsrevonly.4pct = 0.0,
         eqindx.bsrevonly.4pct = deqgap.bsrevonly.4pct / seqgap.bsrevonly.4pct) %>%
  select(`District Name`, number, type, deqgap.bsrevonly.4pct, eqindx.bsrevonly.4pct) 

refrev_ave.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(refrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(refrev_eq.bsrevonly.4pct = refrev22.bsrevonly.4pct,
         refrev_eq.bsrevonly.4pct = ifelse(number == 3000, refrev_new, refrev_eq.bsrevonly.4pct),
         refrev_sd.bsrevonly.4pct = sum(refrev_eq.bsrevonly.4pct[group %in% c(1,2)]),
         loctier1_eq.bsrevonly.4pct = loctier1rev.bsrevonly.4pct,
         loctier1_eq.bsrevonly.4pct = ifelse(number == 3000, 0, loctier1_eq.bsrevonly.4pct),
         locrev_sd.bsrevonly.4pct = sum(loctier1_eq.bsrevonly.4pct[group %in% c(1,2)]),
         awadm_sd.bsrevonly.4pct = sum(awadm22[group %in% c(1,2)]),
         refrev_ave.bsrevonly.4pct = refrev_sd.bsrevonly.4pct / awadm_sd.bsrevonly.4pct,
         loc_ave.bsrevonly.4pct = locrev_sd.bsrevonly.4pct / awadm_sd.bsrevonly.4pct) %>%
  select(`District Name`, number, type, refrev_ave.bsrevonly.4pct, loc_ave.bsrevonly.4pct)

eqrev1.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(percentile.helper.bsrevonly, by = c("District Name", "number", "type")) %>%
  mutate(sldalo.bsrevonly.4pct = 80,
         eqrev1.bsrevonly.4pct = round(awadm22 * (14 + (sldalo.bsrevonly.4pct * eqindx.bsrevonly.4pct))),
         eqrev1.bsrevonly.4pct = ifelse(dist==1 & type==3 | number==625 | number==709 | deqgap.bsrevonly.4pct==0, 0, eqrev1.bsrevonly.4pct),
         eqrev1_p.bsrevonly.4pct = 0.0,
         eqrev1_p.bsrevonly.4pct = ifelse(group==1 & awadm22 > 0, round(eqrev1.bsrevonly.4pct / awadm22), eqrev1_p.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, eqrev1.bsrevonly.4pct)

eqrev2.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(refrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(refrev_ave.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(percentile.helper.bsrevonly, by = c("District Name", "number", "type")) %>%
  mutate(sst22.bsrevonly.4pct = 100000,
         refrev_p.bsrevonly.4pct = 0.0,
         refrev_p.bsrevonly.4pct = ifelse(awadm22 > 0,  (refrev22.bsrevonly.4pct + loctier1rev.bsrevonly.4pct) / awadm22, refrev_p.bsrevonly.4pct),
         eqrev2.bsrevonly.4pct = 0.0,
         eqrev2.bsrevonly.4pct = ifelse(refrev_p.bsrevonly.4pct < ((refrev_ave.bsrevonly.4pct + loc_ave.bsrevonly.4pct) * 0.1), (((refrev_ave.bsrevonly.4pct + loc_ave.bsrevonly.4pct) * 0.1) - refrev_p.bsrevonly.4pct) * awadm22, eqrev2.bsrevonly.4pct),
         eqrev2.bsrevonly.4pct = ifelse(eqrev2.bsrevonly.4pct > sst22.bsrevonly.4pct, sst22.bsrevonly.4pct, eqrev2.bsrevonly.4pct),
         eqrev2.bsrevonly.4pct = ifelse(dist==1 & type==3 | number==625 | number==709 |deqgap.bsrevonly.4pct==0, 0, eqrev2.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, eqrev2, eqrev2.bsrevonly.4pct)

eqrev3.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(eqrev1.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev2.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eqrev3.bsrevonly.4pct = 0.0,
         eqrev3.bsrevonly.4pct = ifelse(eqgroup.label == "metroeq", (eqrev1.bsrevonly.4pct + eqrev2.bsrevonly.4pct) * 0.25, eqrev3.bsrevonly.4pct),
         eqrev3.bsrevonly.4pct = ifelse(eqgroup.label == "ruraleq", (eqrev1.bsrevonly.4pct + eqrev2.bsrevonly.4pct) * 0.25, eqrev3.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, eqrev3.bsrevonly.4pct)

eqrev4.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(percentile.helper.bsrevonly, by = c("District Name", "number", "type")) %>%
  mutate(eqblw95.bsrevonly.4pct = 50,
         eqabv95.bsrevonly.4pct = 50,
         eqrev4.bsrevonly.4pct = round(awadm22 * eqblw95.bsrevonly.4pct),
         eqrev4.bsrevonly.4pct = ifelse(deqgap.bsrevonly.4pct == 0,round(awadm22 * eqabv95.bsrevonly.4pct), eqrev4.bsrevonly.4pct)) %>%
  select(`District Name`, number, type, eqrev4.bsrevonly.4pct)

eqrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(eqrev1.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev2.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev3.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqrev4.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eqrev.bsrevonly.4pct = eqrev1.bsrevonly.4pct + eqrev2.bsrevonly.4pct + eqrev3.bsrevonly.4pct + eqrev4.bsrevonly.4pct) %>%
  select(`District Name`, number, type, eqrev.bsrevonly.4pct)

eqaid.bsrevonly.4pct <- original %>%
  left_join(eqrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(eq_eq_factor.bsrevonly.4pct = 510000,
         eqlvy.bsrevonly.4pct = 0.0,
         eqlvy.bsrevonly.4pct = ifelse(wadm22 > 0 & group == 1, round(eqrev.bsrevonly.4pct * ((rmkv19 / wadm22) / eq_eq_factor.bsrevonly.4pct)), eqlvy.bsrevonly.4pct),
         eqlvy.bsrevonly.4pct = ifelse(eqlvy.bsrevonly.4pct > eqrev.bsrevonly.4pct, eqrev.bsrevonly.4pct, eqlvy.bsrevonly.4pct),
         eqaid.bsrevonly.4pct = eqrev.bsrevonly.4pct - eqlvy.bsrevonly.4pct) %>%
  select(`District Name`, number, type, eqaid.bsrevonly.4pct)

penrev.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  mutate(penrev.bsrevonly.4pct = penrev) %>%
  select(`District Name`, number,  type, penrev.bsrevonly.4pct)

optadjfa.bsrevonly.4pct <- original %>%
  filter(group %in% c(1,4)) %>%
  left_join(tsparrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  mutate(fa22.4pct = (fa22*.04) + fa22,
         optadjin.bsrevonly.4pct = 0.0,
         optadjin.bsrevonly.4pct = 0.0,
         optbasch.bsrevonly.4pct = round((clwadm22 + mclwadm22) * fa22.4pct * trapct),
         optsrsch.bsrevonly.4pct = round((clwadm22 + mclwadm22) * tsparaln.bsrevonly.4pct),
         optextch.bsrevonly.4pct = 0.0,
         optadjch.bsrevonly.4pct = optbasch.bsrevonly.4pct + optextch.bsrevonly.4pct + optsrsch.bsrevonly.4pct,
         optadjfa.bsrevonly.4pct = round(cfwadm22 * -fa22.4pct),
         optadjfa.bsrevonly.4pct = ifelse(type == 70, round(0 * fa22.4pct / fa22.4pct), optadjfa.bsrevonly.4pct),
         optadjfa.bsrevonly.4pct = ifelse(type == 90, round(641313.36 * fa22.4pct / fa22.4pct), optadjfa.bsrevonly.4pct),
         optadj.bsrevonly.4pct = optadjin.bsrevonly.4pct + optadjch.bsrevonly.4pct + optadjfa.bsrevonly.4pct) %>%
  select(`District Name`, number, type, optadj.bsrevonly.4pct)

master.bsrevonly.4pct <- bsrev.bsrevonly.4pct %>%
  left_join(exdayr.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(gtrev22.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(smlrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(decrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(locaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(afdc22.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(totlep.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(totspar.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(cexaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(eqaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(hhaid.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(tsparrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(optadjfa.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  left_join(penrev.bsrevonly.4pct, by = c("District Name", "number", "type")) %>%
  select(1:8, 10:16, 18:20) %>%
  gather(key = "categories", value = "revenue.bsrevonly.4pct", 4:18 ) %>%
  mutate(categories = str_sub(categories, 1, -16),
         categories = trimws(categories, which = "both"),
         revenue.bsrevonly.4pct = ifelse(is.na(revenue.bsrevonly.4pct), 0, revenue.bsrevonly.4pct)) 


```


```{r district join}
district.join <- original %>%
  select(`District Name`, number, type, group, `County Name`, countyfp, Dem_Desc, planning.region, edr, awadm22) %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))
```


```{r district prop}
prop.group <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(group) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n)) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  select(Definition, total.dataset.n, total.dataset.pct.n)

prop.ruca <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(Dem_Desc) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.prop = total.dataset.n / sum(total.dataset.n)) 

prop.pr <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(planning.region) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n))

prop.edr <- master.original %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  distinct(`District Name`, .keep_all = TRUE) %>%
  group_by(edr) %>%
  summarize(total.dataset.n = n()) %>%
  ungroup() %>%
  mutate(total.dataset.pct.n = total.dataset.n / sum(total.dataset.n))

```

# Overview of scenarios

The general education formula was developed in order to bring fairness in eduction funding across school districts independent of where they are located (property values, etc...) while also acknowledging that some schools will cost more to operate due to location and characteristics of the district. By only focusing on increasing one element of the formula, there is risk of making funding school districts unbalanced. 

There are multiple ways in which legislators can change the general education revenue formula. However, it is typical that legislators will increase difference funding mechanisms by percentages. For example, the legislature can increase the basic education revenue by 4%. In FY22 that would mean the revenue would jump from `r filter(original, number == 6) %>% select(fa22)` to `r filter(original, number == 6) %>% select(fa22) %>% mutate(fa22.4pct = (fa22 * .04) + fa22) %>% select(fa22.4pct)`.

One advantage of only increasing the basic education revenue component is that that component is linked to a few other components. For example, the declining enrollment component provides additional revenues for districts with decreasing enrollment by providing 28% of the basic education revenue value multiplied by the difference between FY22 and FY21 APUs. The components that are linked to the basic education revenue component are;

* Declining enrollment
* Compensatory
* Sparsity, 
* Transportation sparsity, and
* Options adjustment.

On the flip side of all this, the legislature could also choose other elements to adjust, such as increasing the gifted and talented revenue from $13 to $14 per APU. 

I want to analyze what happens to total revenues for schools when focusing on one component vs. all components for increases. Therefore the following scenarios will be compared;

1. 4% increase to all components in the formula
2. 4% increase to the basic education revenue component only.

This will help us determine if some schools benefit way more by only focusing on one component for increases rather than the entire formula.

<br>

## Overview of scenario 1: 4% increase for entire formula

The following is a list of all the components and how each one was adjusted by 4%. 

<br>

**Basic education revenue**

The basic education revenue category provides a base amount of revenue per adjusted pupil units to each school district.

A 4% would bring the revenue from $6,728 to `r dollar((6728*.04)+6728)`.

<br>

**Extended time**

This program allows a school district to count a student who participates in extended programming for up to an additional 0.2 students in ADM for the time the student spends in summer school, etc…. The allowance is $5,117 X the district’s extended time adjusted pupil units.

A 4% increase would bring the revenue from $5,117 to `r dollar((5117*.04)+5117)`.

<br>

**Gifted and talented**

A school district receives $13 per pupil unit for gifted and talented programming. $13 X adjusted pupil units. Must be spent on gifted and talented students.

A 4% increase would bring the revenue from $13 to `r dollar((13*.04) + 13)`. 

<br>

**Small schools**

A school district that serves less than 960 pupil units is eligible for small schools revenue equal to $544 X the district’s adjusted pupil units, times the ratio of 960 less the district’s adjusted pupil units to 960.

A 4% increase would bring the revenue from $544 to `r dollar((544*.04) + 544)`.

In addition, a few schools received a dollar amount that wasn't in the usual $544 x APU ratio due to having multiple schools in the district. A few of the schools in these districts qualified for small schools funding. Each of these were also increased.

* District 318, from $70,189.06 to  `r dollar((70189.06*.04) + 70189)`,
* District 363, from $115,058.66 to `r dollar((115058.66 * .04) + 115058.66)`,
* District 381, from $241,346.69 to `r dollar((241346.69 * .04) + 241346.69)`,
* District 2142, from $404,349.22 to `r dollar((404349.22 * .04) + 404349.22)`.

<br>

**Declining enrollment**

Revenue equals the greater of zero or 28% of the formula allowance for that year and the difference between adjusted pupil units for the current year and the adjusted pupil units for the previous year.

A 4% increase would bring the revenue from $1,884 to `r dollar((1884 *.04)+1884)`.

<br>

**Local optional aid**

This revenue is meant to help equalize property rich schools districts and property poor school districts by providing extra aid to property poor districts. This is done by calculating the revenue, then the levy with equalizing factors, and then aid is distributed by subtracting the levy from the revenue.

* Revenue
    + Tier 1: from $300 to `r dollar((300*.04)+300)`
    + Tier 2: $424 to `r dollar((424*.04) + 424)`
* Levy equalizing factors
    + Tier 1: $880,000 to `r dollar((880000*.04) + 880000)`
    + Tier 2: $510,000 to `r dollar((510000*.04) + 510000)`
    
<br>

**Compensatory**

Compensatory is a site-based revenue and at least 50% of the revenue must be distributed to qualifying programs at each site. The revenue must be used to meet the educational needs of pupils whose progress toward meeting state or local content or performance standards is below the level that is appropriate for learners of their age. This revenue must be put into a separate account. Revenue increases as the number of compensatory pupil units goes up, which is driven by the number of free and reduced price meals.

A pupil is counted as compensatory pupil if the pupil is eligible for free or reduced priced meals, which is set by the Federal government at 130% and 185 % of the federal poverty guidelines.

* Compensatory Revenue = (Basic Formula Allowance - $839) x .6 x Compensatory Pupil Units
* Compensatory Pupil Units = (free lunch students + .5 x reduced lunch students) x the less of:
one, or (free lunch students + .5 x reduced lunch students) / building ADM / .8

A 4% increase in this funding is linked to the basic education revenue so it would be $5,889 to `r dollar((5889*.04)+5889)`. However, we were not provided the number of students that qualified for free or reduced lunch at each district but rather just given the total compensatory value for each school district. So in this case, we just increased the total dollar amount by 4%.

<br>

**English learners**

English learner revenue: a school district with at least one student eligible for EL services has a statutorily assigned minimum EL pupil count of 20. In addition, a district received more english learner revenue depending on the concentration of english learner students within the district.

A 4% increase for the basic EL revenue would go from $704 to `r dollar((704*.04) + 704)`.

A 4% increase for EL concentration revenue would go from $250 to `r dollar((250*.04) + 250)`.

<br>

**Sparsity**

This is a vertical funding mechanism meant to shore up support for school districts that serve small student population for an area not served by other schools. It acknowledges the challenges associated with the lack of economies of scale to providing education.

There are three parts to this revenue;

* Secondary school sparsity
* Elementary school sparsity
* Sparsity guarantee

The two main components that can be changed are the following;

* Basic education revenue - $530: a 4% increase goes from $6,198.00 to `r dollar((6198*.04)+6198)`.
* Elementary sparsity revenue: the total revenue received by each school district was provided so we just multiplied the total revenue by 4%.

<br>

**Operating Capital aid**

Operating capital revenue must be reserved and used for equipment and facility needs. The computation is, the sum of $79 per pupil unit and the product of $109 per pupil unit and the district’s average building age index. The age index is called the maintenance cost index (MCI) and is calculated as follows;

* MCI = (weighted square footage of buildings) / (Unweighted square footage of buildings)
* The weighted square food is the buildings square footage times the lesser of 1.5 or the sum of 1 + (the age of each building or addition / 100).

Operating capital revenue is provided through an equalized aid and levy and is computed as follows;

* Operating capital revenue - [$79 + (MCI x $109)] x adjusted pupil units
* Operating capital levy = Operating capital revenue x the less of 1 or (adjusted net tax capacity /Adjusted Pupil Units) / $23,885
* Operating capital aid = Operating Capital Revenue - Operating Capital Levy

The following adjustments were made for this scenario;

A 4% increase of $79 is `r dollar((79*.04) + 79)`.

A 4% increase of $109 is `r dollar((109*.04) + 109)`.

A 4% increase for the equalizing factor goes from $23,885 to `r dollar((23885 * .04) + 23885)`.

<br>

**Transportation sparsity**

Transportation sparsity revenue provides revenue to school districts that have a relatively low ratio of pupils to the square mile area of the school district.

the primary change here is the increase in the basic education revenue.

A 4% would bring the revenue from $6,728 to `r dollar((6728*.04)+6728)`.

<br>

**Equity**

Equity revenue is designed to provide additional revenue to districts with lower amounts of referendum revenue. Calculations for this revenue is broken into two regions - the 7-county metro and greater Minnesota. The formula consists of three parts.

1. Basic equity revenue: equals the product of 125% x [$14 +($80 x district’s equity index)] x adjusted pupil units
    + Equity index = 1 - (basic formula allowance + local optional revenue + referendum revenue) / per pupil amount for the district at the 95th percentile in that region
    + School districts of the first class (Minneapolis, St. Paul, and Duluth) don’t receive basic equity revenue
2. Low referendum revenue: district has per pupil referendum revenue less than 10% of the statewide average receives an additional equity amount equal to the lesser of $100,000 or the difference between 10% of the statewide average referendum revenue and the district’s current amount of referendum revenue.
3. Supplemental equity revenue: all school districts receive $50 per pupil unit.

Equity aid and levy: A district’s total equity revenue is equalized on referendum market value using an equalizing factor of $510,000.

The primary change in equity funding in this scenario is;

* Basic education revenue: from $6,728 to `r dollar((6728*.04)+6728)`
* Updated revenue (4% scenario) from small schools, location optional referendum, transition revenue, and referendum revenue. 
* A 4% increase to $14 is `r dollar((14*.04)+14)`.
* A 4% increase to $80 is `r dollar((80*.04)+80)`.
* A 4% increase to $50 is `r dollar((50*.04) + 50)`.
* A 4% increase to the equalizing factor goes from $500,000 to `r dollar((500000*.04) + 500000)`.

<br>

**Transition**

No changes were made to this revenue.

<br>

**Pension adjustment**

No changes were made to the pension adjustment.

<br>

**Options adjustment**

The change here was in the basic education revenue allotment.

A 4% increase goes from $6728 to `r dollar((6728*.04)+6728)`.

<br>

## Overview of scenario 2: 4% increase to basic education revenue component

Due to the basic education revenue component being linked to other components, it's important to understand what changes.

The following is a list of the components that are impacted by a 4% increase to only the basic education revenue component.

<br>

**Declining enrollment**

Revenue equals the greater of zero or 28% of the formula allowance for that year and the difference between adjusted pupil units for the current year and the adjusted pupil units for the previous year.

A 4% increase would bring the revenue from $1,884 to `r dollar((1884 *.04)+1884)`.

<br>

**Compensatory**

Compensatory is a site-based revenue and at least 50% of the revenue must be distributed to qualifying programs at each site. The revenue must be used to meet the educational needs of pupils whose progress toward meeting state or local content or performance standards is below the level that is appropriate for learners of their age. This revenue must be put into a separate account. Revenue increases as the number of compensatory pupil units goes up, which is driven by the number of free and reduced price meals.

A pupil is counted as compensatory pupil if the pupil is eligible for free or reduced priced meals, which is set by the Federal government at 130% and 185 % of the federal poverty guidelines.

* Compensatory Revenue = (Basic Formula Allowance - $839) x .6 x Compensatory Pupil Units
* Compensatory Pupil Units = (free lunch students + .5 x reduced lunch students) x the less of:
one, or (free lunch students + .5 x reduced lunch students) / building ADM / .8

A 4% increase in this funding is linked to the basic education revenue so it would be $5,889 to `r dollar((5889*.04)+5889)`. However, we were not provided the number of students that qualified for free or reduced lunch at each district but rather just given the total compensatory value for each school district. So in this case, we just increased the total dollar amount by 4%.

<br>

**Sparsity**

This is a vertical funding mechanism meant to shore up support for school districts that serve small student population for an area not served by other schools. It acknowledges the challenges associated with the lack of economies of scale to providing education.

There are three parts to this revenue;

* Secondary school sparsity
* Elementary school sparsity
* Sparsity guarantee

The two main components that can be changed are the following;

* Basic education revenue - $530: a 4% increase goes from $6,198.00 to `r dollar((6198*.04)+6198)`.

* Elementary sparsity revenue: the total revenue received by each school district was provided so we just multiplied the total elementary sparsity revenue provided by 4%.

<br>

**Transportation sparsity**

Transportation sparsity revenue provides revenue to school districts that have a relatively low ratio of pupils to the square mile area of the school district.

the primary change here is the increase in the basic education revenue.

A 4% would bring the revenue from $6,728 to `r dollar((6728*.04)+6728)`.

<br>

**Options adjustment**

The change here was in the basic education revenue allotment.

A 4% increase goes from $6728 to `r dollar((6728*.04)+6728)`.

<br>

# Analysis of largest boost: revenue per APU

Let's do the same thing we did above, but instead of looking at scenarios in terms of how much it boosts revenue, let's look at it as revenue per APU.

<br>

## Aggregated analysis{.tabset}

We will begin by summarizing total original revenue as well as the two scenarios per APU. The table below provides the total original revenue per APU, the 4% increase to the basic education component only per APU, and the 4% increase to the entire general education formula per APU, as well as the differences between these scenarios. 

A 4% increase to only the basic education component equals a 3.75% increase to revenue per APU - from $7,843.19 per APU to $8,137.10. A 4% increase to the entire general education formula equals a 4.17% increase in total revenue per APU - from $7,843.19 per APU to $8,170.06 per APU. Essentially increasing the entire general education formula by 4% increases the total revenue per APU by nearly $33 compared to only increasing the basic education revenue component only.



<br>

```{r summary total rev per apu all}
summary.total.rev <- master.original %>%
  left_join(master.4pct, by = c("District Name", "number", "type", "categories")) %>%
  left_join(master.bsrevonly.4pct, by = c("District Name", "number", "type", "categories")) %>%
  left_join(district.join, by = c("District Name", "number", "type"))

summary.total.rev.apu <- summary.total.rev %>%
  group_by(`District Name`, number, type) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE),
            revenue.4pct = sum(revenue.4pct, na.rm = TRUE),
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct, na.rm = TRUE)) %>%
  ungroup()

summary.total.rev.apu.all <- summary.total.rev.apu %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  summarize(revenue.original = sum(revenue.original),
            revenue.4pct = sum(revenue.4pct),
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct),
            awadm22 = sum(awadm22)) %>%
  mutate(revenue.original.apu = revenue.original / awadm22,
         revenue.4pct.apu = revenue.4pct / awadm22,
         revenue.bsrevonly.4pct.apu = revenue.bsrevonly.4pct / awadm22,
         pct.change.bsrev.apu = (revenue.bsrevonly.4pct.apu - revenue.original.apu) / revenue.original.apu,
         pct.change.4pct.apu = (revenue.4pct.apu - revenue.original.apu) / revenue.original.apu) %>%
  select(awadm22, revenue.original.apu, revenue.bsrevonly.4pct.apu, pct.change.bsrev.apu, revenue.4pct.apu, pct.change.4pct.apu) %>%
  mutate(diff.between.scenarios.apu = revenue.4pct.apu - revenue.bsrevonly.4pct.apu,
         pct.diff.between.scenarios = diff.between.scenarios.apu / revenue.original.apu)

datatable(summary.total.rev.apu.all, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 0:7)),
                         scrollX = TRUE)) %>%
  formatCurrency(2:3, "$") %>%
  formatPercentage(4, digits = 2) %>%
  formatCurrency(5, "$") %>%
  formatPercentage(6, digits = 2) %>%
  formatCurrency(7, "$") %>%
  formatPercentage(8, digits = 2)


```

<br>

Next, let's take a look at the differences by charter vs. public, RUCA category, and regions.

The charter vs. public table shows that, surprisingly, charter schools receive significantly more revenue per APU than public schools. In the original FY22 revenue, charter schools receive nearly a $1,000 more per APU than public schools - $8,726.00 vs. $7,768.23 per APU. An increase of 4% to the basic education component only provides a larger boost to public schools than charter - 3.76% vs. 3.66%. A 4% increase to the entire formula also provides a larger boost to public than charter - 4.19% vs. 3.94%.

The RUCA table shows that entirely rural school districts receive the largest revenue per APU in the FY22 revenue formula - $8,902.93 vs. $7,752.59 per APU for entirely urban counties. That's SIGNIFICANTLY larger. If only the basic education revenue component is increased by 4%, entirely urban schools receive the largest bump with 3.77% increase. It gets progressively less as a school district is more rural - 3.64% for entirely rural districts. However, a 4% increase to the entire general education formula means that entirely urban districts get the lowest bump - 4.13%. Then, entirely rural districts get a 4.19% bump, 4.23% for town/rural districts, and a 4.25% bump for urban/town/rural districts.

The planning region table shows that total revenue per APU is significantly closer to each other due to there being a mixture of rural and urban school districts within each planning region. In the original FY22 revenue, Northwest receives the highest with $8,121.39 per APU followed closely by Northeast. The lowest is actually Central with $7,643.96 per APU. The seven county metro receives the largest bump with a 4% increase to only the basic education component with a 3.77% increase. The lowest is Southwest with a 3.69%. By increasing the entire general education formula, Central and Southwest would receive a 4.27% increase followed closely by Southeast and Northwest. The Seven County metro would receive the lowest with a 4.11% increase.

The EDR table shows that EDR 1 and 2 receive the highest revenue per APU with between $8,500 and $9,000 per APU. This is followed closely by other rural EDRs such as 6W, 8, and 3. The lowest are EDRs located in Central MN - ER 9, 7E and 7W. With a 4% increase to only the basic education component, EDR 11 receives the highest bump with EDR 4 and EDRs in Central Minnesota following closely behind. The lowest bump is EDR 1, 6W, and 8. The EDRs with the highest bumps from a 4% increase to the entire general education formula would be EDR 6E, 8, 7E and 7W. 

<br>

### Public vs. Charter

<br>

```{r summary total rev per apu group}

summary.total.rev.apu.group <- summary.total.rev.apu %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  group_by(group) %>%
  summarize(revenue.original = sum(revenue.original),
            revenue.4pct = sum(revenue.4pct),
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct),
            awadm22 = sum(awadm22)) %>%
  mutate(revenue.original.apu = revenue.original / awadm22,
         revenue.4pct.apu = revenue.4pct / awadm22,
         revenue.bsrevonly.4pct.apu = revenue.bsrevonly.4pct / awadm22,
         pct.change.bsrev.apu = (revenue.bsrevonly.4pct.apu - revenue.original.apu) / revenue.original.apu,
         pct.change.4pct.apu = (revenue.4pct.apu - revenue.original.apu) / revenue.original.apu) %>%
  select(group,awadm22, revenue.original.apu, revenue.bsrevonly.4pct.apu, pct.change.bsrev.apu, revenue.4pct.apu, pct.change.4pct.apu) %>%
  mutate(diff.between.scenarios.apu = revenue.4pct.apu - revenue.bsrevonly.4pct.apu,
         pct.diff.between.scenarios = diff.between.scenarios.apu / revenue.original.apu) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  select(Definition, 2:9)

datatable(summary.total.rev.apu.group, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:7)),
                         scrollX = TRUE)) %>%
  formatCurrency(3:4, "$") %>%
  formatPercentage(5, digits = 2) %>%
  formatCurrency(6, "$") %>%
  formatPercentage(7, digits = 2) %>%
  formatCurrency(8, "$") %>%
  formatPercentage(9, digits = 2)


```

<br>

### RUCA

<br>

```{r summary total rev per apu ruca}

summary.total.rev.apu.ruca <- summary.total.rev.apu %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  drop_na(Dem_Desc) %>%
  group_by(Dem_Desc) %>%
  summarize(revenue.original = sum(revenue.original),
            revenue.4pct = sum(revenue.4pct),
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct),
            awadm22 = sum(awadm22)) %>%
  mutate(revenue.original.apu = revenue.original / awadm22,
         revenue.4pct.apu = revenue.4pct / awadm22,
         revenue.bsrevonly.4pct.apu = revenue.bsrevonly.4pct / awadm22,
         pct.change.bsrev.apu = (revenue.bsrevonly.4pct.apu - revenue.original.apu) / revenue.original.apu,
         pct.change.4pct.apu = (revenue.4pct.apu - revenue.original.apu) / revenue.original.apu) %>%
  select(Dem_Desc,awadm22, revenue.original.apu, revenue.bsrevonly.4pct.apu, pct.change.bsrev.apu, revenue.4pct.apu, pct.change.4pct.apu) %>%
  mutate(diff.between.scenarios.apu = revenue.4pct.apu - revenue.bsrevonly.4pct.apu,
         pct.diff.between.scenarios = diff.between.scenarios.apu / revenue.original.apu) 

datatable(summary.total.rev.apu.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:7)),
                         scrollX = TRUE)) %>%
  formatCurrency(3:4, "$") %>%
  formatPercentage(5, digits = 2) %>%
  formatCurrency(6, "$") %>%
  formatPercentage(7, digits = 2) %>%
  formatCurrency(8, "$") %>%
  formatPercentage(9, digits = 2)


```

<br>

### Planning Region

<br>

```{r summary total rev per apu pr}

summary.total.rev.apu.pr <- summary.total.rev.apu %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  drop_na(planning.region) %>%
  group_by(planning.region) %>%
  summarize(revenue.original = sum(revenue.original),
            revenue.4pct = sum(revenue.4pct),
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct),
            awadm22 = sum(awadm22)) %>%
  mutate(revenue.original.apu = revenue.original / awadm22,
         revenue.4pct.apu = revenue.4pct / awadm22,
         revenue.bsrevonly.4pct.apu = revenue.bsrevonly.4pct / awadm22,
         pct.change.bsrev.apu = (revenue.bsrevonly.4pct.apu - revenue.original.apu) / revenue.original.apu,
         pct.change.4pct.apu = (revenue.4pct.apu - revenue.original.apu) / revenue.original.apu) %>%
  select(planning.region,awadm22, revenue.original.apu, revenue.bsrevonly.4pct.apu, pct.change.bsrev.apu, revenue.4pct.apu, pct.change.4pct.apu) %>%
  mutate(diff.between.scenarios.apu = revenue.4pct.apu - revenue.bsrevonly.4pct.apu,
         pct.diff.between.scenarios = diff.between.scenarios.apu / revenue.original.apu) 

datatable(summary.total.rev.apu.pr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:7)),
                         scrollX = TRUE)) %>%
  formatCurrency(3:4, "$") %>%
  formatPercentage(5, digits = 2) %>%
  formatCurrency(6, "$") %>%
  formatPercentage(7, digits = 2) %>%
  formatCurrency(8, "$") %>%
  formatPercentage(9, digits = 2)


```

<br>

### EDR

<br>

```{r summary total rev per apu edr}

summary.total.rev.apu.edr <- summary.total.rev.apu %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  drop_na(edr) %>%
  group_by(edr) %>%
  summarize(revenue.original = sum(revenue.original),
            revenue.4pct = sum(revenue.4pct),
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct),
            awadm22 = sum(awadm22)) %>%
  mutate(revenue.original.apu = revenue.original / awadm22,
         revenue.4pct.apu = revenue.4pct / awadm22,
         revenue.bsrevonly.4pct.apu = revenue.bsrevonly.4pct / awadm22,
         pct.change.bsrev.apu = (revenue.bsrevonly.4pct.apu - revenue.original.apu) / revenue.original.apu,
         pct.change.4pct.apu = (revenue.4pct.apu - revenue.original.apu) / revenue.original.apu) %>%
  select(edr,awadm22, revenue.original.apu, revenue.bsrevonly.4pct.apu, pct.change.bsrev.apu, revenue.4pct.apu, pct.change.4pct.apu) %>%
  mutate(diff.between.scenarios.apu = revenue.4pct.apu - revenue.bsrevonly.4pct.apu,
         pct.diff.between.scenarios = diff.between.scenarios.apu / revenue.original.apu) 

datatable(summary.total.rev.apu.edr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:7)),
                         scrollX = TRUE)) %>%
  formatCurrency(3:4, "$") %>%
  formatPercentage(5, digits = 2) %>%
  formatCurrency(6, "$") %>%
  formatPercentage(7, digits = 2) %>%
  formatCurrency(8, "$") %>%
  formatPercentage(9, digits = 2)
```

<br>

## {.unnumbered .unlisted .toc-ignore}

Now let's see which counties receive the largest "boost" between the two scenarios. The map below shows that rural counties in SW and NW Minnesota receive the highest boost in dollars per APU by increasing the entire formula by 4% vs. only the basic education component. These counties receive $50 or more per APU by increasing the formula vs. the $40 or less of other counties.

<br>

```{r summary total rev per apu county}

summary.total.rev.apu.county <- summary.total.rev.apu %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  drop_na(`County Name`) %>%
  group_by(`County Name`, countyfp) %>%
  summarize(revenue.original = sum(revenue.original),
            revenue.4pct = sum(revenue.4pct),
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct),
            awadm22 = sum(awadm22)) %>%
  ungroup() %>%
  mutate(revenue.original.apu = revenue.original / awadm22,
         revenue.4pct.apu = revenue.4pct / awadm22,
         revenue.bsrevonly.4pct.apu = revenue.bsrevonly.4pct / awadm22,
         pct.change.bsrev.apu = (revenue.bsrevonly.4pct.apu - revenue.original.apu) / revenue.original.apu,
         pct.change.4pct.apu = (revenue.4pct.apu - revenue.original.apu) / revenue.original.apu) %>%
  select(`County Name`, countyfp,awadm22, revenue.original.apu, revenue.bsrevonly.4pct.apu, pct.change.bsrev.apu, revenue.4pct.apu, pct.change.4pct.apu) %>%
  mutate(diff.between.scenarios.apu = revenue.4pct.apu - revenue.bsrevonly.4pct.apu,
         pct.diff.between.scenarios = diff.between.scenarios.apu / revenue.original.apu) %>%
  left_join(mn_counties[,c(4,7)], by = "countyfp")

summary.total.rev.apu.county.map <- ggplot(summary.total.rev.apu.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = diff.between.scenarios.apu, data_id = countyfp, tooltip = paste(`County Name`, "\nRevenue per APU - original: ", dollar(revenue.original.apu), "\nRevenue per APU - 4% increase to basic education component only: ", dollar(revenue.bsrevonly.4pct.apu), "\nRevenue per APU - 4% increase to entire formula: ", dollar(revenue.4pct.apu), "\nDollars per APU gained by increasing entire formula by 4% vs increasing only basic education: ", dollar(diff.between.scenarios.apu), sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "PuBu", direction = 1, labels = scales::dollar) +
  labs(title = "Dollars per APU gained by increasing entire formula vs. only\nbasic education component") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = summary.total.rev.apu.county.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))


```

<br>

## Not aggregated - school districts{.tabset}

The section above shows that there are significant differences in the amount of "boost" districts receive at an aggregated level between the two scenarios. Now let's take a look at difference by not aggregating the districts. Rather, we will keep all revenues totaled at the district level, and analyze the districts that receive the highest boost (top 25%) and see if there are relationships between that 25% and their school type, RUCA category, and geography.

First, we will calculate each districts revenue increases from each scenario so we can determine which ones are in the top 25% highest. If you arrange it so that the districts with the largest gain from only increasing the basic education component by 4% vs. increasing the entire formula by 4%, there are a number of districts that gain above or nearly 1% in total revenue.

The summary stats of all the districts indicate a pretty normal distribution. The mean and medians for all scenarios are very close to each other with modest standard deviations.

### Table

<br>

```{r change per apu between scenarios districts}
change.total.rev.apu.districts <- summary.total.rev %>%
  group_by(`District Name`, number, type) %>%
  summarize(revenue.original = sum(revenue.original, na.rm = TRUE),
            revenue.4pct = sum(revenue.4pct, na.rm = TRUE),
            revenue.bsrevonly.4pct = sum(revenue.bsrevonly.4pct),
            awadm22 = sum(awadm22)) %>%
  ungroup() %>%
  mutate(revenue.original.apu = revenue.original / awadm22,
         revenue.4pct.apu = revenue.4pct / awadm22,
         pct.increase.revenue.4pct.apu = (revenue.4pct.apu - revenue.original.apu) / revenue.original.apu,
         revenue.bsrevonly.4pct.apu = revenue.bsrevonly.4pct / awadm22,
         pct.increase.revenue.bsrevonly.4pct.apu = (revenue.bsrevonly.4pct.apu - revenue.original.apu) / revenue.original.apu,
         diff.between.scenarios = (revenue.4pct.apu - revenue.bsrevonly.4pct.apu) / revenue.original.apu) %>%
  select(`District Name`, number, type, revenue.original.apu, revenue.bsrevonly.4pct.apu, pct.increase.revenue.bsrevonly.4pct.apu, revenue.4pct.apu, pct.increase.revenue.4pct.apu, diff.between.scenarios) %>%
  filter(revenue.original.apu > 0,
         !is.infinite(revenue.original.apu))

datatable(change.total.rev.apu.districts, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:7)),
                         scrollX = TRUE)) %>%
  formatCurrency(4:5, "$") %>%
  formatPercentage(6, digits = 2) %>%
  formatCurrency(7, "$") %>%
  formatPercentage(8:9, digits = 2) 

```

<br>

### Summary statistics

<br>

```{r change per apu districts range}
change.total.rev.apu.summary.stats.districts <- change.total.rev.apu.districts %>%
  gather(key = "scenario", value = "value", 6,8,9) %>%
  group_by(scenario) %>%
  summarize(n = n(),
            mean = mean(value),
            median = median(value),
            sd = sd(value),
            min = min(value),
            max = max(value)) %>%
  ungroup() 

datatable(change.total.rev.apu.summary.stats.districts, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:6)),
                         scrollX = TRUE)) %>%
  formatPercentage(3:7, digits = 2) 
  
```

<br>

## {.unnumbered .unlisted .toc-ignore .tabset}

Let's take a look at each of these scenarios and the boosts given to each district. The maps below compare all of them.

```{r maps boosts all three scenarios}
top.dist.bsrev.only.districts <- change.total.rev.apu.districts %>%
  select(`District Name`, number, type, revenue.original.apu, revenue.bsrevonly.4pct.apu, pct.increase.revenue.bsrevonly.4pct.apu) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  arrange(desc(pct.increase.revenue.bsrevonly.4pct.apu)) %>%
  mutate(rank = seq(n()),
         bins = cut(pct.increase.revenue.bsrevonly.4pct.apu,
                    breaks = c(0, .035, .036, .037, .038, .04),
                    labels = c("2.5% to 3.5%", "3.5% to 3.6%", "3.6% to 3.7%", "3.7% to 3.8%", "3.8% to 4.0%"))) %>%
  right_join(mn_counties[,c(4,7)], by = c("countyfp")) %>%
  left_join(school_districts[,c(1,2,7)], by = c("type", "number")) %>%
  rename(geometry.county = geometry.x,
         geometry.schools = geometry.y)

top.dist.bsrev.only.districts.map <- ggplot(top.dist.bsrev.only.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry.schools, fill = bins, data_id = `District Name`, tooltip = paste(`District Name`, "\nOriginal revenue per APU: ", dollar(revenue.original.apu), "\nRevenue per APU after increasing basic education component only: ", dollar(revenue.bsrevonly.4pct.apu), "\nPercent increase in total revenue: ", percent(pct.increase.revenue.bsrevonly.4pct.apu), "\nRank of boost: ", rank, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 5, "PuBu"),
                    guide = guide_legend(reverse = TRUE)) +
  labs(title = "Largest boost - basic ed only", subtitle = "Largest increases are in the suburbs and\ndistricts with lake properties") +
  theme(legend.box.margin = margin(50, 0, 0, -80),
        text = element_text(size = 18))

top.dist.4pct.districts <- change.total.rev.apu.districts %>%
  select(`District Name`, number, type, revenue.original.apu, revenue.4pct.apu, pct.increase.revenue.4pct.apu) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  arrange(desc(pct.increase.revenue.4pct.apu)) %>%
  mutate(rank = seq(n()),
         bins = cut(pct.increase.revenue.4pct.apu,
                    breaks = c(0, .04, .041, .042, .043, 1),
                    labels = c("3% to 4%", "4% to 4.1%", "4.1% to 4.2%", "4.2% to 4.3%", "4.3% to 4.5%"))) %>%
  right_join(mn_counties[,c(4,7)], by = c("countyfp")) %>%
  left_join(school_districts[,c(1,2,7)], by = c("type", "number")) %>%
  rename(geometry.county = geometry.x,
         geometry.schools = geometry.y)


top.dist.4pct.districts.map <- ggplot(top.dist.4pct.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry.schools, fill = bins, data_id = `District Name`, tooltip = paste(`District Name`, "\nOriginal revenue per APU: ", dollar(revenue.original.apu), "\nRevenue per APU after increasing entire formula: ", dollar(revenue.4pct.apu), "\nPercent increase in total revenue: ", percent(pct.increase.revenue.4pct.apu), "\nRank of boost: ", rank, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 5, "PuBu"),
                    guide = guide_legend(reverse = TRUE)) +
  labs(title = "Largest boost - increase entire formula", subtitle = "Largest boosts located in districts in\nsouthern and central MN") +
  theme(legend.box.margin = margin(50, 0, 0, -90),
        text = element_text(size = 18))

plot.row.1 <- plot_grid(top.dist.bsrev.only.districts.map, top.dist.4pct.districts.map)

top.dist.diff.districts <- change.total.rev.apu.districts %>%
  select(`District Name`, number, type, revenue.original.apu, diff.between.scenarios) %>%
  left_join(district.join, by = c("District Name", "number", "type")) %>%
  arrange(desc(diff.between.scenarios)) %>%
  mutate(rank = seq(n()),
         bins = cut(diff.between.scenarios,
                    breaks = c(0, .003, .004, .005, .0060, .007, 1),
                    labels = c("0.1% to 0.3%", "0.3% to 0.4%", "0.4% to 0.5%", "0.5% to 0.6%", "0.6% to .7%", ".7% to 1.1%"))) %>%
  right_join(mn_counties[,c(4,7)], by = c("countyfp")) %>%
  left_join(school_districts[,c(1,2,7)], by = c("type", "number")) %>%
  rename(geometry.county = geometry.x,
         geometry.schools = geometry.y)

top.dist.diff.map <- ggplot(top.dist.diff.districts) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry.schools, fill = bins, data_id = `District Name`, tooltip = paste(`District Name`, "\nOriginal revenue per APU: ", dollar(revenue.original.apu), "\nPercent increase in revenue from increasing basi education component only to increasing entire formula: ", percent(diff.between.scenarios, accuracy = .01), "\nRank of boost: ", rank, sep = ""))) +
  theme_sf+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(reverse = TRUE)) +
  labs(title = "Largest gain between scenarios", subtitle = "Largest boosts located in districts in southern\nand central MN") +
  theme(legend.box.margin = margin(50, 0, 0, -90),
        text = element_text(size = 18))

plot.row.2 <- plot_grid(NULL, top.dist.diff.map, NULL,
                        rel_widths = c(0, 1, 0))

girafe(ggobj = plot_grid(plot.row.1, plot.row.2, ncol = 1, nrow = 2),
       height_svg = 20,
       width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>


Let's check to see how much overlap there is - essentially, do districts that receive a high boost in one scenario not receive a high boost in another scenario. To do this, we will filter out the districts that receive the highest (top quartile) boost across all three scenarios and see which districts show up. The quantiles for the boosts due to increasing only the basic education revenue component is;

<br>

```{r quantile for bsrev only}
bsrevonly.quantile <- change.total.rev.apu.districts %>%
  summarize(quantile = quantile(pct.increase.revenue.bsrevonly.4pct.apu)) %>%
  mutate(pct = c("Min", "25%", "50%", "75%", "Max")) %>%
  spread(pct, quantile) %>%
  select(Min, `25%`, `50%`, `75%`, Max)

datatable(bsrevonly.quantile, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 0:4)))) %>%
  formatPercentage(1:5, digits = 2) 
  
```

The quantiles for the boosts due to increasing the entire general education revenue framework is;

```{r quantile for increasing entire formula}
entire.4pct.quantile <- change.total.rev.apu.districts %>%
  summarize(quantile = quantile(pct.increase.revenue.4pct.apu)) %>%
  mutate(pct = c("Min", "25%", "50%", "75%", "Max")) %>%
  spread(pct, quantile) %>%
  select(Min, `25%`, `50%`, `75%`, Max)

datatable(entire.4pct.quantile, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 0:4)))) %>%
  formatPercentage(1:5, digits = 2) 
  
```

The quantiles for the difference in these boosts are;

```{r quantile for difference in boosts}
diff.4pct.quantile <- change.total.rev.apu.districts %>%
  summarize(quantile = quantile(diff.between.scenarios)) %>%
  mutate(pct = c("Min", "25%", "50%", "75%", "Max")) %>%
  spread(pct, quantile) %>%
  select(Min, `25%`, `50%`, `75%`, Max)

datatable(diff.4pct.quantile, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 0:4)))) %>%
  formatPercentage(1:5, digits = 2) 
  
```

<br>

For each scenario, there are a number of other ways in which a district could be in the top 25% across the scenarios.

* District receives top 25% boost from increasing basic education component only can also
    + receive a top 25% boost when the entire formula is increased by 4%, and/or
    + be in the top 25% of districts that have the largest difference between the two scenarios, or
    + none of the above.
    
* District receives top 25% boost from increasing the entire formula by 4% can also
    + receive a top 25% boost from increasing the basic education component only, and/or
    + be in the top 25% of districts that have the largest difference between the two scenarios, or
    + none of the above.
    
* District has a top 25% difference in boost received between the two scenarios can also,
    + receive a top 25% boost from increasing the basic education component only, and/or
    + receive a top 25% boost from increasing the entire formula by 4%, or
    none of the above.
    
* District does not end up in the top 25% of boosts or differences.

The chart below shows that 46% of the districts in the dataset do not fall into the top 25% in any scenario. In addition, it shows that 21% of districts receive a top 25% boost from increasing the basic education component only and not in any other scenario. 

<br>

```{r top quantiles}
top.quan.bsrev.only.districts <- quantile(change.total.rev.apu.districts$pct.increase.revenue.bsrevonly.4pct.apu, .75) %>%
  unname()

top.quan.4pct.districts <- quantile(change.total.rev.apu.districts$pct.increase.revenue.4pct.apu, .75) %>%
  unname()

top.quan.diff.districts <- quantile(change.total.rev.apu.districts$diff.between.scenarios, .75) %>%
  unname()
```

```{r districts in top 25% boost in each scenario}
top.25pct.boost.districts <- change.total.rev.apu.districts %>%
  mutate(top.25pct.bsrevonly = ifelse(pct.increase.revenue.bsrevonly.4pct.apu > top.quan.bsrev.only.districts, "Yes", "No"),
         top.25pct.entire.formula = ifelse(pct.increase.revenue.4pct.apu > top.quan.4pct.districts, "Yes", "No"),
         top.25pct.diff = ifelse(diff.between.scenarios > top.quan.diff.districts, "Yes", "No")) %>%
  mutate(combo = ifelse(top.25pct.bsrevonly == "Yes" & top.25pct.entire.formula == "No" & top.25pct.diff == "No", "Basic ed only",
                        ifelse(top.25pct.bsrevonly == "Yes" & top.25pct.entire.formula == "Yes" & top.25pct.diff == "No", "Basic-Entire",
                               ifelse(top.25pct.bsrevonly == "Yes" & top.25pct.entire.formula == "Yes" & top.25pct.diff == "Yes", "Basic-Entire-Diff",
                                      ifelse(top.25pct.bsrevonly == "Yes" & top.25pct.entire.formula == "No" & top.25pct.diff == "Yes", "Basic-Diff",
                                             ifelse(top.25pct.bsrevonly == "No" & top.25pct.entire.formula == "Yes" & top.25pct.diff == "No", "Entire",
                                                    ifelse(top.25pct.bsrevonly == "No" & top.25pct.entire.formula == "Yes" & top.25pct.diff == "Yes", "Entire-Diff",
                                                           
                                                           ifelse(top.25pct.bsrevonly == "No" & top.25pct.entire.formula == "No" & top.25pct.diff == "Yes", "Diff", "None"))))))))

top.25pct.summary <- top.25pct.boost.districts %>%
  group_by(combo) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct = n / nrow(top.25pct.boost.districts),
         Basic.cat = c("Yes", "Yes", "Yes","No", "No", "No", "No"),
         Entire.cat = c("No", "Yes", "Yes", "No", "Yes", "Yes", "No"),
         Diff.cat = c("No", "No", "Yes", "Yes", "No", "Yes", "No"),
         data_id = seq(n())) %>%
  arrange(desc(pct)) 

top.25pct.summary.plot <- ggplot(top.25pct.summary, aes(reorder(combo, -pct), pct)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Top 25% scenario: ", combo, "\nNumber of districts with this top 25% combination: ", comma(n), "\nPercent of districts with this combination: ", percent(pct, accuracy = .01), sep = ""))) +
  labs(x="", y = "", color="", title = "Percent of districts in top 25% combination")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = top.25pct.summary.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))   

```

<br>

Let's take out all the school districts that are not in the top 25% in either scenario nor do they fall into the top 25% of difference between the scenarios. 

The chart below shows that nearly 40% of the school districts that fall into the top 25% of any scenario only fall into the top 25% of change if the basic education component is increased only. The next highest are districts that fall into the top 25% of change if the entire formula is increased by 4% and the greatest difference between the two scenarios - nearly 30% of the districts.

<br>

```{r top 25 pct only}
top.25pct.boost.only.districts <- top.25pct.boost.districts %>%
  filter(combo != "None")

top.25pct.only.summary <- top.25pct.boost.only.districts %>%
  group_by(combo) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct = n / nrow(top.25pct.boost.only.districts),
         Basic.cat = c("Yes", "Yes", "Yes","No", "No", "No"),
         Entire.cat = c("No", "Yes", "Yes", "No", "Yes", "Yes"),
         Diff.cat = c("No", "No", "Yes", "Yes", "No", "Yes"),
         data_id = seq(n())) %>%
  arrange(desc(pct)) 

top.25pct.only.summary.plot <- ggplot(top.25pct.only.summary, aes(reorder(combo, -pct), pct)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Top 25% scenario: ", combo, "\nNumber of districts with this top 25% combination: ", comma(n), "\nPercent of districts with this combination: ", percent(pct, accuracy = .01), sep = ""))) +
  labs(x="", y = "", color="", title = "Percent of districts in top 25% combination")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = top.25pct.only.summary.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))   


```

<br>

Let's see what this looks like with maps. The map belows highlights the school districts that are in the top 25% of change for each of the scenarios.

* Increase basic education component only: The districts that receive the top 25% highest bump are located in and around the seven county metro and the central lakes region (northern MN) and along the Southeast side of the state.

* Increase the entire formula by 4%: The districts that receive the top 25% boost in this scenario are concentrated outside of the seven county metro and in Southern Minnesota and along the western border.

* Largest difference in revenue between the two scenarios: It seems that the largest difference between the two scenarios exist in southern and western Minnesota.

<br>

```{r top 25 pct all scenarios map}
top.25pct.boost.districts.confirmed <- top.25pct.boost.districts %>%
  gather(key = "scenario", value = "confirmed", 10:12) %>%
  left_join(school_districts[,c(1,2,7)], by = c("number", "type")) %>%
  mutate(scenario = fct_relevel(scenario, "top.25pct.bsrevonly", "top.25pct.entire.formula", "top.25pct.diff"),
         confirmed = fct_relevel(confirmed, "Yes", "No"))

top.25pct.boost.districts.confirmed.map <- ggplot(top.25pct.boost.districts.confirmed) +
  facet_wrap(~scenario, ncol = 2) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = confirmed, data_id = `District Name`, tooltip = paste(`District Name`, "Original revenue per APU: ", dollar(revenue.original.apu), "\nRevenue per APU - 4% increase to basic ed only: ", dollar(revenue.bsrevonly.4pct.apu), "\nPct increase in revenue per APU - 4% incresae to basic ed only: ", percent(pct.increase.revenue.bsrevonly.4pct.apu), "\nRevenue per APU - 4% increase to entire formula: ", dollar(revenue.4pct.apu), "\nPct increase in revenue per APU - 4% increase to entire formula: ", percent(pct.increase.revenue.4pct.apu), "\nPct difference between two scenarios: ", percent(diff.between.scenarios, accuracy = .001), sep = ""))) +
  theme_sf+
  scale_fill_manual(values = c("red", "grey85")) +
  labs(title = "Districts that are in the top 25% in change for each scenario") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = top.25pct.boost.districts.confirmed.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>

Okay, so it definitely looks like there might be some relationships between location and whether a district receives the 25% highest boosts. Let's run the numbers and look at the proportions.

Below are a bunch of tabs breaking out the relationships between each scenario and whether a district public vs. charter, RUCA category, and regions.

* Public vs. Charter: The likelihood that a public school falls into the top 25% of change in each scenario is significantly higher than being a charter school. Public schools make up 92% to 100% of the top 25% in each scenario while they compose 64.2% of the districts in the dataset.

* RUCA: There wasn't a statistically significant difference between whether a district was located in one of the RUCA categories and if they received a top 25% boost from increasing the basic education revenue component only. However, there was a relationship in whether a district was in a specific RUCA category and receiving a top 25% boost from increasing the entire formula and top 25% largest difference between the two scenarios. 
    + Increase entire formula: Districts in urban/town/rural mix and town/rural mix categories were significantly more likely to receive a top 25% boost from this scenario, while more urban school districts were not as well as entirely rural.
    + Difference between two scenarios: The differences become even more intense in this scenario. Urban/town/rural as well as town/rural school districts were significantly more likely to be in the top 25% of difference between the two scenarios compared to urban. Entirely rural districts were slightly more likely.
    
* Planning Regions: There was no relationship between planning regions and whether a district received a top 25% boost from increasing the basic education revenue component by 4%. However, there were relationships in the other scenarios;
    + Increase entire formula: Regions in the central and southern part of the state outside of the seven county metro were significantly more likely to receive a top 25% boost in this scenario. Northern Minnesota districts were relatively the same while twin cities metro was significantly less likely.
    + Difference between two scenarios: Regions in the central and southern part of the state outside of the seven county metro were significantly more likely to have a top 25% difference between the two scenarios.
    
* EDR: There was no relationship between EDR and whether a district received a top 25% boost from increasing the basic education revenue component by 4%. However, there were relationships in the other scenarios;
    + Increase entire formula: EDRs in the sourthern portion of Minnesota typically have a better change of receiving a top 25% boost in this scenario while northern MN and the twin cities are significantly less.
    + Difference between two scenarios: Same as above.



<br>

### Public vs. Charter{.tabset}

<br>

#### Basic education component only

<br>

```{r relationship basic ed component group}
relationship.group <- top.25pct.boost.districts %>%
  left_join(district.join, by = c("number", "type")) %>%
  select(group, top.25pct.bsrevonly, top.25pct.entire.formula, top.25pct.diff) %>%
  gather(key = "scenario", value = "confirmed", 2:4) %>%
  group_by(group, scenario, confirmed) %>%
  summarize(n = n()) %>%
  ungroup() %>%
    filter(confirmed == "Yes") %>%
  group_by(scenario) %>%
  mutate(total.districts = sum(n)) %>%
  ungroup() %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  select(Definition, scenario, n, total.districts) %>%
  complete(Definition, scenario, fill = list(n = 0, total.districts = 508)) %>%
  mutate(pct.top25pct = n / total.districts) %>%
  left_join(prop.group, by = "Definition")

relationship.bsrevonly.group <- relationship.group %>%
  filter(scenario == "top.25pct.bsrevonly") %>%
  select(Definition, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.bsrevonly.group, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.bsrevonly.group$n, relationship.bsrevonly.group$total.dataset.n)
```

<br>

#### Increase entire formula

<br>

```{r relationship entire formula group}
relationship.entire.formula.group <- relationship.group %>%
  filter(scenario == "top.25pct.entire.formula") %>%
  select(Definition, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.entire.formula.group, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.entire.formula.group$n, relationship.entire.formula.group$total.dataset.n)
```

<br>

#### Largest boost between two scenarios

<br>

```{r relationship difference group}
relationship.diff.group <- relationship.group %>%
  filter(scenario == "top.25pct.diff") %>%
  select(Definition, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.diff.group, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.diff.group$n, relationship.diff.group$total.dataset.n)
```

<br>

### RUCA{.tabset}

<br>

#### Basic education component only

<br>

```{r relationship basic ed component ruca}
relationship.ruca <- top.25pct.boost.districts %>%
  left_join(district.join, by = c("number", "type")) %>%
  select(Dem_Desc, top.25pct.bsrevonly, top.25pct.entire.formula, top.25pct.diff) %>%
  gather(key = "scenario", value = "confirmed", 2:4) %>%
  group_by(Dem_Desc, scenario, confirmed) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  filter(confirmed == "Yes") %>%
  group_by(scenario) %>%
  mutate(total.districts = sum(n)) %>%
  ungroup() %>%
  complete(Dem_Desc, scenario, fill = list(n = 0, total.districts = 508)) %>%
  mutate(pct.top25pct = n / total.districts) %>%
  left_join(prop.ruca, by = "Dem_Desc")

relationship.bsrevonly.ruca <- relationship.ruca %>%
  filter(scenario == "top.25pct.bsrevonly") %>%
  select(Dem_Desc, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.prop) 

datatable(relationship.bsrevonly.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.bsrevonly.ruca$n, relationship.bsrevonly.ruca$total.dataset.n)
```

<br>

#### Increase entire formula

<br>

```{r relationship entire formula ruca}
relationship.entire.formula.ruca <- relationship.ruca %>%
  filter(scenario == "top.25pct.entire.formula") %>%
  select(Dem_Desc, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.prop) 

datatable(relationship.entire.formula.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.entire.formula.ruca$n, relationship.entire.formula.ruca$total.dataset.n)
```

<br>

#### Largest boost between two scenarios

<br>

```{r relationship difference ruca}
relationship.diff.ruca <- relationship.ruca %>%
  filter(scenario == "top.25pct.diff") %>%
  select(Dem_Desc, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.prop) 

datatable(relationship.diff.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.diff.ruca$n, relationship.diff.ruca$total.dataset.n)
```

<br>

### Planning Region{.tabset}

<br>

#### Basic education component only

<br>

```{r relationship basic ed component pr}
relationship.pr <- top.25pct.boost.districts %>%
  left_join(district.join, by = c("number", "type")) %>%
  select(planning.region, top.25pct.bsrevonly, top.25pct.entire.formula, top.25pct.diff) %>%
  gather(key = "scenario", value = "confirmed", 2:4) %>%
  group_by(planning.region, scenario, confirmed) %>%
  summarize(n = n()) %>%
  ungroup() %>%
    filter(confirmed == "Yes") %>%
  group_by(scenario) %>%
  mutate(total.districts = sum(n)) %>%
  ungroup() %>%
  complete(planning.region, scenario, fill = list(n = 0, total.districts = 508)) %>%
  mutate(pct.top25pct = n / total.districts) %>%
  left_join(prop.pr, by = "planning.region")

relationship.bsrevonly.pr <- relationship.pr %>%
  filter(scenario == "top.25pct.bsrevonly") %>%
  select(planning.region, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.bsrevonly.pr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.bsrevonly.pr$n, relationship.bsrevonly.pr$total.dataset.n)
```

<br>

#### Increase entire formula

<br>

```{r relationship entire formula pr}
relationship.entire.formula.pr <- relationship.pr %>%
  filter(scenario == "top.25pct.entire.formula") %>%
  select(planning.region, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.entire.formula.pr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.entire.formula.pr$n, relationship.entire.formula.pr$total.dataset.n)
```

<br>

#### Largest boost between two scenarios

<br>

```{r relationship difference pr}
relationship.diff.pr <- relationship.pr %>%
  filter(scenario == "top.25pct.diff") %>%
  select(planning.region, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.diff.pr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.diff.pr$n, relationship.diff.pr$total.dataset.n)
```

<br>

### EDR{.tabset}

<br>

#### Basic education component only

<br>

```{r relationship basic ed component edr}
relationship.edr <- top.25pct.boost.districts %>%
  left_join(district.join, by = c("number", "type")) %>%
  select(edr, top.25pct.bsrevonly, top.25pct.entire.formula, top.25pct.diff) %>%
  gather(key = "scenario", value = "confirmed", 2:4) %>%
  group_by(edr, scenario, confirmed) %>%
  summarize(n = n()) %>%
  ungroup() %>%
    filter(confirmed == "Yes") %>%
  group_by(scenario) %>%
  mutate(total.districts = sum(n)) %>%
  ungroup() %>%
  complete(edr, scenario, fill = list(n = 0, total.districts = 508)) %>%
  mutate(pct.top25pct = n / total.districts) %>%
  left_join(prop.edr, by = "edr")

relationship.bsrevonly.edr <- relationship.edr %>%
  filter(scenario == "top.25pct.bsrevonly") %>%
  select(edr, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.bsrevonly.edr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.bsrevonly.edr$n, relationship.bsrevonly.edr$total.dataset.n)
```

<br>

#### Increase entire formula

<br>

```{r relationship entire formula edr}
relationship.entire.formula.edr <- relationship.edr %>%
  filter(scenario == "top.25pct.entire.formula") %>%
  select(edr, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.entire.formula.edr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.entire.formula.edr$n, relationship.entire.formula.edr$total.dataset.n)
```

<br>

#### Largest boost between two scenarios

<br>

```{r relationship difference edr}
relationship.diff.edr <- relationship.edr %>%
  filter(scenario == "top.25pct.diff") %>%
  select(edr, scenario, n, pct.top25pct, total.dataset.n, total.dataset.pct.n) 

datatable(relationship.diff.edr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:5)))) %>%
  formatPercentage(4, digits = 1) %>%
  formatPercentage(6, digits = 1)

tags$br()

prop.test(relationship.diff.edr$n, relationship.diff.edr$total.dataset.n)
```





