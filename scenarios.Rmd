---
title: "Scenarios"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)

```

```{r loading jon docs and shapefiles, cache=TRUE, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         planning.region = ifelse(Name == "Minnesota", "Minnesota", planning.region) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.edr <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

```

```{r master basic revenue}
original <- read_csv("Data/Formula/Master.csv") %>%
  mutate(Dem_Desc = fct_relevel(Dem_Desc, "Entirely rural", "Town/rural mix", "Urban/town/rural mix", "Entirely urban"),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

group.codes <- read_xlsx("Data/Formula/group codes.xlsx")

var.codes <- read_xlsx("Data/Formula/primary variable codes.xlsx")

```

<br>

Something here.

# Proportion of total revenue by category{.tabset}

First let's check to see what categories contribute the most revenue to school districts. Are there categories that provide more than another depending on the type of school, RUCA categories or regions?

First, let's lump all schools together and see what which categories provide the most. As the chart below shows, the basic education revenue provides BY FAR the most to school districts in Minnesota. Very far behind is compensatory which provides 6.4% of the total revenue given to schools.

<br>

```{r categories all school}
cat.all.schools <- original %>%
  filter(group %in% c(1,4)) %>%
  summarize(bsrev = sum(bsrev),
            exdayr = sum(exdayr),
            gtrev = sum(gtrev), 
            smlrev = sum(smlrev), 
            decrev = sum(decrev), 
            locaid = sum(locaid), 
            afdc22 = sum(afdc22), 
            totlep = sum(totlep), 
            totspar = sum(totspar), 
            cexaid = sum(cexaid, na.rm = TRUE), 
            tsparrev = sum(tsparrev), 
            eqaid = sum(eqaid), 
            hhaid = sum(hhaid), 
            penrev = sum(penrev)) %>%
  gather(key = "categories", value = "revenue", 1:14) %>%
  mutate(pct.revenue = revenue / sum(revenue),
         data_id = as.character(seq(n()))) %>%
  left_join(var.codes, by = c("categories" = "Code"))

cat.all.schools.plot <- ggplot(cat.all.schools, aes(fct_reorder(Category, pct.revenue), pct.revenue)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(Category, "\nTotal revenue: ", dollar(revenue), "\nPercent of total revenue: ", percent(pct.revenue, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct.revenue, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent share of total general education revenue\nformula")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "none",
        text = element_text(size = 18))


girafe(ggobj = cat.all.schools.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

Next, let's see if there are any big differences between public and charter schools. The chart below provides the proportion of revenue from each category by type of schools. Charter schools receive a significant larger amount of their revenue from compensatory, english learners, small schools revenue.

<br>

```{r categories by group}
cat.group <- original %>%
  filter(group %in% c(1,4)) %>%
  group_by(group) %>%
  summarize(bsrev = sum(bsrev),
            exdayr = sum(exdayr),
            gtrev = sum(gtrev), 
            smlrev = sum(smlrev), 
            decrev = sum(decrev), 
            locaid = sum(locaid), 
            afdc22 = sum(afdc22), 
            totlep = sum(totlep), 
            totspar = sum(totspar), 
            cexaid = sum(cexaid, na.rm = TRUE), 
            tsparrev = sum(tsparrev), 
            eqaid = sum(eqaid), 
            hhaid = sum(hhaid), 
            penrev = sum(penrev)) %>%
  gather(key = "categories", value = "revenue", 2:15) %>%
  group_by(group) %>%
  mutate(pct.revenue = revenue / sum(revenue)) %>%
  ungroup() %>%
  mutate(data_id = as.character(seq(n()))) %>%
  left_join(var.codes, by = c("categories" = "Code")) %>%
  left_join(group.codes, by = c("group" = "Code")) %>%
  select(Definition, Category, revenue, pct.revenue, data_id)


cat.group.plot <- ggplot(cat.group, aes(fct_reorder(Category, pct.revenue), pct.revenue)) +
  facet_wrap(~Definition) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("School type: ", Definition, "n", Category, "\nTotal revenue: ", dollar(revenue), "\nPercent of total revenue: ", percent(pct.revenue, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct.revenue, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent share of total general education revenue\nformula")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "none",
        text = element_text(size = 18))


girafe(ggobj = cat.group.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

Okay, let's see what kind of differences there are by RUCA categories and regions.

The RUCA tables show that as a county group becomes more urban, the percentage of revenue coming from the basic education component decreases. This is because rural areas get more revenue from some of the other components. The components that seem to benefit rural schools more than urban are;

* Declining enrollment
* Equity aid
* Local optional aid
* Sparsity
* Transportation sparsity
* Small schools

There are a few that benefit urban schools more;

* Operating capital aid
* English learners
* Pensions adjustment
* Extended time

It's worth mentioning that compensatory revenue is a significant percentage across all RUCA categories. The highest is in the entirely urban areas, but is quite similar to our entirely rural areas.

When looking at things by geography, there are a few patterns. We will go through each category.

* Basic revenue: the highest percentages are in Central, seven county metro, and Southeast. Most of the EDRs in these regions have well over 80% of their total revenue from this category.
* Compensatory: The highest compensatory percentages exist in EDR 2 - Headwaters, the twin cities, and the north central lakes regions. 
* Declining enrollment: the highest percentage is in Southeast regions.
* English learners: the highest percentages are in Southwest region as well as seven county metro.
* Equity aid: higherst percentages in Northwest and West Central regions.
* Extended time: highest percentages exist in central Minnesota and seven county metro.
* Gifted and talented: even across all of Minnesota.
* Local optional aid: Local optional doesn't have a pattern that I can see.


<br>

## RUCA

<br>

```{r categories by ruca}
cat.ruca <- original %>%
  filter(group %in% c(1,4)) %>%
  drop_na(Dem_Desc) %>%
  group_by(Dem_Desc) %>%
  summarize(bsrev = sum(bsrev),
            exdayr = sum(exdayr),
            gtrev = sum(gtrev), 
            smlrev = sum(smlrev), 
            decrev = sum(decrev), 
            locaid = sum(locaid), 
            afdc22 = sum(afdc22), 
            totlep = sum(totlep), 
            totspar = sum(totspar), 
            cexaid = sum(cexaid, na.rm = TRUE), 
            tsparrev = sum(tsparrev), 
            eqaid = sum(eqaid), 
            hhaid = sum(hhaid), 
            penrev = sum(penrev)) %>%
  gather(key = "categories", value = "revenue", 2:15) %>%
  group_by(Dem_Desc) %>%
  mutate(pct.revenue = revenue / sum(revenue)) %>%
  ungroup() %>%
  mutate(data_id = as.character(seq(n()))) %>%
  left_join(var.codes, by = c("categories" = "Code")) %>%
  select(Dem_Desc, Category, pct.revenue) %>%
  spread(Dem_Desc, pct.revenue)

datatable(cat.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:4)))) %>%
  formatPercentage(2:5, digits = 1)


```



<br>

## Planning Region

<br>

```{r categories by pr}
cat.pr <- original %>%
  filter(group %in% c(1,4)) %>%
  drop_na(planning.region) %>%
  group_by(planning.region) %>%
  summarize(bsrev = sum(bsrev),
            exdayr = sum(exdayr),
            gtrev = sum(gtrev), 
            smlrev = sum(smlrev), 
            decrev = sum(decrev), 
            locaid = sum(locaid), 
            afdc22 = sum(afdc22), 
            totlep = sum(totlep), 
            totspar = sum(totspar), 
            cexaid = sum(cexaid, na.rm = TRUE), 
            tsparrev = sum(tsparrev), 
            eqaid = sum(eqaid), 
            hhaid = sum(hhaid), 
            penrev = sum(penrev)) %>%
  gather(key = "categories", value = "revenue", 2:15) %>%
  group_by(planning.region) %>%
  mutate(pct.revenue = revenue / sum(revenue)) %>%
  ungroup() %>%
  mutate(data_id = as.character(seq(n()))) %>%
  left_join(var.codes, by = c("categories" = "Code")) %>%
  select(planning.region, Category, pct.revenue) %>%
  spread(planning.region, pct.revenue)

datatable(cat.pr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:6)),
                         scrollX = TRUE)) %>%
  formatPercentage(2:7, digits = 1)


```

<br>

## EDR

<br>

```{r categories by edr}
cat.edr <- original %>%
  filter(group %in% c(1,4)) %>%
  drop_na(edr) %>%
  group_by(edr) %>%
  summarize(bsrev = sum(bsrev),
            exdayr = sum(exdayr),
            gtrev = sum(gtrev), 
            smlrev = sum(smlrev), 
            decrev = sum(decrev), 
            locaid = sum(locaid), 
            afdc22 = sum(afdc22), 
            totlep = sum(totlep), 
            totspar = sum(totspar), 
            cexaid = sum(cexaid, na.rm = TRUE), 
            tsparrev = sum(tsparrev), 
            eqaid = sum(eqaid), 
            hhaid = sum(hhaid), 
            penrev = sum(penrev)) %>%
  gather(key = "categories", value = "revenue", 2:15) %>%
  group_by(edr) %>%
  mutate(pct.revenue = revenue / sum(revenue)) %>%
  ungroup() %>%
  mutate(data_id = as.character(seq(n()))) %>%
  left_join(var.codes, by = c("categories" = "Code")) %>%
  select(edr, Category, pct.revenue) %>%
  spread(edr, pct.revenue)

datatable(cat.edr, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:6)),
                         scrollX = TRUE)) %>%
  formatPercentage(2:14, digits = 1)


```

<br>
